

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="r00tk1t">
  <meta name="keywords" content="">
  
    <meta name="description" content="本篇是sandbox源码剖析的第六篇，主要分析了windows平台下，Chromium对Token的封装与使用。阅读本篇前，最好阅读前四篇（本篇相对独立）。 想要流程的阅读本系列你需要以下几个条件： 1. 较高水平的C++编码能力（至少通读C++ Primer 5th，刷过课后题，有一定编码量）。 2. 熟悉Windows API编程，尤其是安全相关的内容。 3. 对二进制安全有一定了解，熟悉各类">
<meta property="og:type" content="article">
<meta property="og:title" content="Chromium-sandbox-Tokens-analysis">
<meta property="og:url" content="https://r00tk1ts.github.io/2018/05/19/chromium-sandbox-Tokens-analysis/index.html">
<meta property="og:site_name" content="玉涵的技能书">
<meta property="og:description" content="本篇是sandbox源码剖析的第六篇，主要分析了windows平台下，Chromium对Token的封装与使用。阅读本篇前，最好阅读前四篇（本篇相对独立）。 想要流程的阅读本系列你需要以下几个条件： 1. 较高水平的C++编码能力（至少通读C++ Primer 5th，刷过课后题，有一定编码量）。 2. 熟悉Windows API编程，尤其是安全相关的内容。 3. 对二进制安全有一定了解，熟悉各类">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-05-19T00:14:11.000Z">
<meta property="article:modified_time" content="2024-04-22T03:34:00.168Z">
<meta property="article:author" content="r00tk1t">
<meta property="article:tag" content="chromium">
<meta property="article:tag" content="chromium-sandbox">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Chromium-sandbox-Tokens-analysis - 玉涵的技能书</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"r00tk1ts.github.io","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":80,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>玉涵的技能书</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/doc/">
                <i class="iconfont icon-books"></i>
                <span>藏经阁</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Chromium-sandbox-Tokens-analysis"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2018-05-19 08:14" pubdate>
          2018年5月19日 早上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          41k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          345 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Chromium-sandbox-Tokens-analysis</h1>
            
            
              <div class="markdown-body">
                
                <p>本篇是sandbox源码剖析的第六篇，主要分析了windows平台下，Chromium对Token的封装与使用。阅读本篇前，最好阅读前四篇（本篇相对独立）。</p>
<p>想要流程的阅读本系列你需要以下几个条件： 1.
较高水平的C++编码能力（至少通读C++ Primer
5th，刷过课后题，有一定编码量）。 2. 熟悉Windows
API编程，尤其是安全相关的内容。 3.
对二进制安全有一定了解，熟悉各类型安全漏洞成因、漏洞缓解措施及bypass手法。</p>
<span id="more"></span>
<h1
id="chromium-sandbox-tokens-analysis">chromium-sandbox-Tokens-analysis</h1>
<p>上一节分析了Job，本节分析policy三大组件之Token。Token实际上是Windows环境下的一种安全信令，它可以作为判定资源是否可以访问的凭证。Chrome的sandbox使用了token，以此来限制target进程的访问权限。</p>
<p>这一节我们从已知的几个疑惑点入手，层层深入。</p>
<p>由于Token牵扯到了Windows系统安全鉴权方面的知识，所以建议对token不了解的读者优先阅读《Windows
Internals》第六章。在搞清楚下面的问题之后，你就可以看这部分代码了。</p>
<ol type="1">
<li>token的结构是什么样的、拥有者是谁、用来干什么？personation
token是谁的，用来干什么？restricted token又是什么？</li>
<li>Integrity
Level是什么，用来区分什么，SID相同时，低Level进程可以访问高Level对象吗？</li>
<li>privilege和account right是什么，有什么区别？</li>
<li>SID(Security Identifier)代表什么？</li>
<li>SD(Security
Descriptor)是什么，DACL又是什么，进程用token访问对象时，如何利用SD裁决请求的？</li>
</ol>
<h2 id="brokerservicesbase-related"><code>BrokerServicesBase</code>
related</h2>
<p>三个token最初是在<code>BrokerServicesBase::SpawnTarget</code>中make出来的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp">base::win::ScopedHandle initial_token;<br>base::win::ScopedHandle lockdown_token;<br>base::win::ScopedHandle lowbox_token;<br>ResultCode result = SBOX_ALL_OK;<br><br>result =<br>  policy_base-&gt;<span class="hljs-built_in">MakeTokens</span>(&amp;initial_token, &amp;lockdown_token, &amp;lowbox_token);<br></code></pre></td></tr></table></figure>
<p>步入到<code>MakeToken</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">ResultCode <span class="hljs-title">PolicyBase::MakeTokens</span><span class="hljs-params">(base::win::ScopedHandle* initial,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  base::win::ScopedHandle* lockdown,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  base::win::ScopedHandle* lowbox)</span> </span>&#123;<br>  <span class="hljs-comment">// Create the &#x27;naked&#x27; token. This will be the permanent token associated</span><br>  <span class="hljs-comment">// with the process and therefore with any thread that is not impersonating.</span><br>  <span class="hljs-comment">// 这是个很关键的API，在进程token基础上，做出一个受限信令，使用的是默认DACL</span><br>  <span class="hljs-comment">// restricted token是Windows的一个重要概念</span><br>  DWORD result =<br>      <span class="hljs-built_in">CreateRestrictedToken</span>(lockdown_level_, integrity_level_, PRIMARY,<br>                            lockdown_default_dacl_, lockdown);<br>  <span class="hljs-keyword">if</span> (ERROR_SUCCESS != result)<br>    <span class="hljs-keyword">return</span> SBOX_ERROR_GENERIC;<br><br>  <span class="hljs-comment">// If we&#x27;re launching on the alternate desktop we need to make sure the</span><br>  <span class="hljs-comment">// integrity label on the object is no higher than the sandboxed process&#x27;s</span><br>  <span class="hljs-comment">// integrity level. So, we lower the label on the desktop process if it&#x27;s</span><br>  <span class="hljs-comment">// not already low enough for our process.</span><br>  <span class="hljs-comment">// 这一部分是对alternative desktop IL的调整，它不应该高于target的IL，所以如果</span><br>  <span class="hljs-comment">// IL不够低，就要削成一样低</span><br>  <span class="hljs-keyword">if</span> (use_alternate_desktop_ &amp;&amp; integrity_level_ != INTEGRITY_LEVEL_LAST) &#123;<br>    <span class="hljs-comment">// Integrity label enum is reversed (higher level is a lower value).</span><br>    <span class="hljs-built_in">static_assert</span>(INTEGRITY_LEVEL_SYSTEM &lt; INTEGRITY_LEVEL_UNTRUSTED,<br>                  <span class="hljs-string">&quot;Integrity level ordering reversed.&quot;</span>);<br>    HDESK desktop_handle = <span class="hljs-literal">nullptr</span>;<br>    IntegrityLevel desktop_integrity_level_label;<br>    <span class="hljs-keyword">if</span> (use_alternate_winstation_) &#123;<br>      desktop_handle = alternate_desktop_handle_;<br>      desktop_integrity_level_label = alternate_desktop_integrity_level_label_;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      desktop_handle = alternate_desktop_local_winstation_handle_;<br>      desktop_integrity_level_label =<br>          alternate_desktop_local_winstation_integrity_level_label_;<br>    &#125;<br>    <span class="hljs-comment">// If the desktop_handle hasn&#x27;t been created for any reason, skip this.</span><br>    <span class="hljs-keyword">if</span> (desktop_handle &amp;&amp; desktop_integrity_level_label &lt; integrity_level_) &#123;<br>      result =<br>          <span class="hljs-built_in">SetObjectIntegrityLabel</span>(desktop_handle, SE_WINDOW_OBJECT, <span class="hljs-string">L&quot;&quot;</span>,<br>                                  <span class="hljs-built_in">GetIntegrityLevelString</span>(integrity_level_));<br>      <span class="hljs-keyword">if</span> (ERROR_SUCCESS != result)<br>        <span class="hljs-keyword">return</span> SBOX_ERROR_GENERIC;<br><br>      <span class="hljs-keyword">if</span> (use_alternate_winstation_) &#123;<br>        alternate_desktop_integrity_level_label_ = integrity_level_;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        alternate_desktop_local_winstation_integrity_level_label_ =<br>            integrity_level_;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// lowbox和另外两个不太一样，它的设定依赖于lowbox object</span><br>  <span class="hljs-comment">// 它是Win8以上才能用的技术，我目前亯܌将target交给了policy来管理(`AddTarget`)。</span><br><br>展开看看`AddTarget`:<br><br>​```<span class="hljs-function">cpp</span><br><span class="hljs-function">ResultCode <span class="hljs-title">PolicyBase::AddTarget</span><span class="hljs-params">(TargetProcess* target)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (policy_)<br>    policy_maker_-&gt;<span class="hljs-built_in">Done</span>();<br><br>  <span class="hljs-comment">// mitigation实装</span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ApplyProcessMitigationsToSuspendedProcess</span>(target-&gt;<span class="hljs-built_in">Process</span>(),<br>                                                 mitigations_)) &#123;<br>    <span class="hljs-keyword">return</span> SBOX_ERROR_APPLY_ASLR_MITIGATIONS;<br>  &#125;<br><br>  <span class="hljs-comment">// 对target设置所有的Interceptions，Interception是一种对target进程的Hook机制</span><br>  <span class="hljs-comment">// 内容非常丰富，以后会分析</span><br>  ResultCode ret = <span class="hljs-built_in">SetupAllInterceptions</span>(target);<br><br>  <span class="hljs-keyword">if</span> (ret != SBOX_ALL_OK)<br>    <span class="hljs-keyword">return</span> ret;<br><br>  <span class="hljs-comment">// broker为target进程开辟一块空间，存储传过去的handles</span><br>  <span class="hljs-comment">// 还要把g_handles_to_close值传过去</span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SetupHandleCloser</span>(target))<br>    <span class="hljs-keyword">return</span> SBOX_ERROR_SETUP_HANDLE_CLOSER;<br><br>  DWORD win_error = ERROR_SUCCESS;<br>  <span class="hljs-comment">// Initialize the sandbox infrastructure for the target.</span><br>  <span class="hljs-comment">// TODO(wfh) do something with win_error code here.</span><br>  <span class="hljs-comment">// 这里面别有洞天，现在知道传过去的都是什么鬼了</span><br>  ret = target-&gt;<span class="hljs-built_in">Init</span>(dispatcher_.<span class="hljs-built_in">get</span>(), policy_, kIPCMemSize, kPolMemSize,<br>                     &amp;win_error);<br><br>  <span class="hljs-keyword">if</span> (ret != SBOX_ALL_OK)<br>    <span class="hljs-keyword">return</span> ret;<br><br>  <span class="hljs-comment">// 通过broker把delayed_integrity_level_传给target</span><br>  <span class="hljs-comment">// 这货在SpawnTarget前就由传入的policy参数对象设置好了</span><br>  <span class="hljs-comment">// 在TargetServicesBase::LowerToken中用于降权</span><br>  g_shared_delayed_integrity_level = delayed_integrity_level_;<br>  ret = target-&gt;<span class="hljs-built_in">TransferVariable</span>(<span class="hljs-string">&quot;g_shared_delayed_integrity_level&quot;</span>,<br>                                 &amp;g_shared_delayed_integrity_level,<br>                                 <span class="hljs-built_in">sizeof</span>(g_shared_delayed_integrity_level));<br>  g_shared_delayed_integrity_level = INTEGRITY_LEVEL_LAST;<br>  <span class="hljs-keyword">if</span> (SBOX_ALL_OK != ret)<br>    <span class="hljs-keyword">return</span> ret;<br><br>  <span class="hljs-comment">// 传入g_shared_delayed_mitigations</span><br>  <span class="hljs-comment">// Add in delayed mitigations and pseudo-mitigations enforced at startup.</span><br>  g_shared_delayed_mitigations =<br>      delayed_mitigations_ | <span class="hljs-built_in">FilterPostStartupProcessMitigations</span>(mitigations_);<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CanSetProcessMitigationsPostStartup</span>(g_shared_delayed_mitigations))<br>    <span class="hljs-keyword">return</span> SBOX_ERROR_BAD_PARAMS;<br><br>  ret = target-&gt;<span class="hljs-built_in">TransferVariable</span>(<span class="hljs-string">&quot;g_shared_delayed_mitigations&quot;</span>,<br>                                 &amp;g_shared_delayed_mitigations,<br>                                 <span class="hljs-built_in">sizeof</span>(g_shared_delayed_mitigations));<br>  g_shared_delayed_mitigations = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (SBOX_ALL_OK != ret)<br>    <span class="hljs-keyword">return</span> ret;<br><br>  <span class="hljs-function">AutoLock <span class="hljs-title">lock</span><span class="hljs-params">(&amp;lock_)</span></span>;<br>  targets_.<span class="hljs-built_in">push_back</span>(target);<br>  <span class="hljs-keyword">return</span> SBOX_ALL_OK;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>现在再看<code>TargetProcess::Init</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Construct the IPC server and the IPC dispatcher. When the target does</span><br><span class="hljs-comment">// an IPC it will eventually call the dispatcher.</span><br><span class="hljs-function">ResultCode <span class="hljs-title">TargetProcess::Init</span><span class="hljs-params">(Dispatcher* ipc_dispatcher,</span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-type">void</span>* policy,</span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-type">uint32_t</span> shared_IPC_size,</span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-type">uint32_t</span> shared_policy_size,</span></span><br><span class="hljs-params"><span class="hljs-function">                               DWORD* win_error)</span> </span>&#123;<br>  <span class="hljs-comment">// We need to map the shared memory on the target. This is necessary for</span><br>  <span class="hljs-comment">// any IPC that needs to take place, even if the target has not yet hit</span><br>  <span class="hljs-comment">// the main( ) function or even has initialized the CRT. So here we set</span><br>  <span class="hljs-comment">// the handle to the shared section. The target on the first IPC must do</span><br>  <span class="hljs-comment">// the rest, which boils down to calling MapViewofFile()</span><br><br>  <span class="hljs-comment">// We use this single memory pool for IPC and for policy.</span><br>  <span class="hljs-comment">// 使用了shared_mem的IPC通信方式，以后会详细分析这些内容</span><br>  DWORD shared_mem_size =<br>      <span class="hljs-built_in">static_cast</span>&lt;DWORD&gt;(shared_IPC_size + shared_policy_size);<br>  shared_section_.<span class="hljs-built_in">Set</span>(::<span class="hljs-built_in">CreateFileMappingW</span>(INVALID_HANDLE_VALUE, <span class="hljs-literal">nullptr</span>,<br>                                           PAGE_READWRITE | SEC_COMMIT, <span class="hljs-number">0</span>,<br>                                           shared_mem_size, <span class="hljs-literal">nullptr</span>));<br>  <span class="hljs-keyword">if</span> (!shared_section_.<span class="hljs-built_in">IsValid</span>()) &#123;<br>    *win_error = ::<span class="hljs-built_in">GetLastError</span>();<br>    <span class="hljs-keyword">return</span> SBOX_ERROR_CREATE_FILE_MAPPING;<br>  &#125;<br><br>  DWORD access = FILE_MAP_READ | FILE_MAP_WRITE | SECTION_QUERY;<br>  HANDLE target_shared_section;<br>  <span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">DuplicateHandle</span>(::<span class="hljs-built_in">GetCurrentProcess</span>(), shared_section_.<span class="hljs-built_in">Get</span>(),<br>                         sandbox_process_info_.<span class="hljs-built_in">process_handle</span>(),<br>                         &amp;target_sharedࠤ؍是很清楚它的作用<br>  <span class="hljs-keyword">if</span> (lowbox_sid_) &#123;<br>    <span class="hljs-keyword">if</span> (!lowbox_directory_.<span class="hljs-built_in">IsValid</span>()) &#123;<br>      result =<br>          <span class="hljs-built_in">CreateLowBoxObjectDirectory</span>(lowbox_sid_, <span class="hljs-literal">true</span>, &amp;lowbox_directory_);<br>      <span class="hljs-built_in">DCHECK</span>(result == ERROR_SUCCESS);<br>    &#125;<br><br>    <span class="hljs-comment">// The order of handles isn&#x27;t important in the CreateLowBoxToken call.</span><br>    <span class="hljs-comment">// The kernel will maintain a reference to the object directory handle.</span><br>    HANDLE saved_handles[<span class="hljs-number">1</span>] = &#123;lowbox_directory_.<span class="hljs-built_in">Get</span>()&#125;;<br>    DWORD saved_handles_count = lowbox_directory_.<span class="hljs-built_in">IsValid</span>() ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;<br><br>    Sid <span class="hljs-built_in">package_sid</span>(lowbox_sid_);<br>    SecurityCapabilities <span class="hljs-built_in">caps</span>(package_sid);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">CreateLowBoxToken</span>(lockdown-&gt;<span class="hljs-built_in">Get</span>(), PRIMARY, &amp;caps, saved_handles,<br>                          saved_handles_count, lowbox) != ERROR_SUCCESS) &#123;<br>      <span class="hljs-keyword">return</span> SBOX_ERROR_GENERIC;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Create the &#x27;better&#x27; token. We use this token as the one that the main</span><br>  <span class="hljs-comment">// thread uses when booting up the process. It should contain most of</span><br>  <span class="hljs-comment">// what we need (before reaching main( ))</span><br>  <span class="hljs-comment">// initial token的创建使用的是和lockdown同样的接口，但它是IMPERSONATION而lockdown是PRIMARY</span><br>  result =<br>      <span class="hljs-built_in">CreateRestrictedToken</span>(initial_level_, integrity_level_, IMPERSONATION,<br>                            lockdown_default_dacl_, initial);<br>  <span class="hljs-keyword">if</span> (ERROR_SUCCESS != result)<br>    <span class="hljs-keyword">return</span> SBOX_ERROR_GENERIC;<br><br>  <span class="hljs-keyword">return</span> SBOX_ALL_OK;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="restrictedtoken"><code>RestrictedToken</code></h2>
<p>想要看懂<code>CreateRestrictedToken</code>，首先得搞清楚<code>RestrictedToken</code>类存在的意义。所以在步入<code>CreateRestrictedToken</code>之前，先拆解一下该类。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Handles the creation of a restricted token using the effective token or</span><br><span class="hljs-comment">// any token handle.</span><br><span class="hljs-comment">// 在一个有效的token句柄之上，创建出一个权限更为严格的token</span><br><span class="hljs-comment">// 在Windows中这种token叫受限令牌</span><br><span class="hljs-comment">// 可能从特权集中删除一些特权；该令牌SID可以被标记成Deny-only；该令牌SID可以被标记为</span><br><span class="hljs-comment">// restricted</span><br><span class="hljs-comment">// Sample usage:</span><br><span class="hljs-comment">//    RestrictedToken restricted_token;</span><br><span class="hljs-comment">//    DWORD err_code = restricted_token.Init(nullptr);  // Use the current</span><br><span class="hljs-comment">//                                                   // effective token</span><br><span class="hljs-comment">//    if (ERROR_SUCCESS != err_code) &#123;</span><br><span class="hljs-comment">//      // handle error.</span><br><span class="hljs-comment">//    &#125;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//    restricted_token.AddRestrictingSid(ATL::Sids::Users().GetPSID());</span><br><span class="hljs-comment">//    base::win::ScopedHandle token_handle;</span><br><span class="hljs-comment">//    err_code = restricted_token.GetRestrictedToken(&amp;token_handle);</span><br><span class="hljs-comment">//    if (ERROR_SUCCESS != err_code) &#123;</span><br><span class="hljs-comment">//      // handle error.</span><br><span class="hljs-comment">//    &#125;</span><br><span class="hljs-comment">//    [...]</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedToken</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">// Init() has to be called before calling any other method in the class.</span><br>  <span class="hljs-built_in">RestrictedToken</span>();<br>  ~<span class="hljs-built_in">RestrictedToken</span>();<br><br>  <span class="hljs-comment">// Initializes the RestrictedToken object with effective_token.</span><br>  <span class="hljs-comment">// If effective_token is nullptr, it initializes the RestrictedToken object</span><br>  <span class="hljs-comment">// with the effective token of the current process.</span><br>  <span class="hljs-comment">// 构造器接Init素质二连，如果effective_token是nullptr，就使用当前进程的token</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">Init</span><span class="hljs-params">(HANDLE effective_token)</span></span>;<br><br>  <span class="hljs-comment">// Creates a restricted token.</span><br>  <span class="hljs-comment">// If the function succeeds, the return value is ERROR_SUCCESS. If the</span><br>  <span class="hljs-comment">// function fails, the return value is the win32 error code corresponding to</span><br>  <span class="hljs-comment">// the error.</span><br>  <span class="hljs-comment">// 这个就是在应用了所有的规则之后，创建出来的restricted token，在最后一步使用</span><br>  <span class="hljs-comment">// token显然是个OUT型参数</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">GetRestrictedToken</span><span class="hljs-params">(base::win::ScopedHandle* token)</span> <span class="hljs-type">const</span></span>;<br><br>  <span class="hljs-comment">// Creates a restricted token and uses this new token to create a new token</span><br>  <span class="hljs-comment">// for impersonation. Returns this impersonation token.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// If the function succeeds, the return value is ERROR_SUCCESS. If the</span><br>  <span class="hljs-comment">// function fails, the return value is the win32 error code corresponding to</span><br>  <span class="hljs-comment">// the error.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// The sample usage is the same as the GetRestrictedToken function.</span><br>  <span class="hljs-comment">// 与上面类似，只是生成的是个impersonation token</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">GetRestrictedTokenForImpersonation</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">      base::win::ScopedHandle* token)</span> <span class="hljs-type">const</span></span>;<br><br>  <span class="hljs-comment">// Lists all sids in the token and mark them as Deny Only except for those</span><br>  <span class="hljs-comment">// present in the exceptions parameter. If there is no exception needed,</span><br>  <span class="hljs-comment">// the caller can pass an empty list or nullptr for the exceptions</span><br>  <span class="hljs-comment">// parameter.</span><br>  <span class="hljs-comment">// 除了exceptions参数中指定的白名单Sid列表，token中的所有sid都被设置为Deny Only</span><br>  <span class="hljs-comment">// </span><br>  <span class="hljs-comment">// If the function succeeds, the return value is ERROR_SUCCESS. If the</span><br>  <span class="hljs-comment">// function fails, the return value is the win32 error code corresponding to</span><br>  <span class="hljs-comment">// the error.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// Sample usage:</span><br>  <span class="hljs-comment">//    std::vector&lt;Sid&gt; sid_exceptions;</span><br>  <span class="hljs-comment">//    sid_exceptions.push_back(ATL::Sids::Users().GetPSID());</span><br>  <span class="hljs-comment">//    sid_exceptions.push_back(ATL::Sids::World().GetPSID());</span><br>  <span class="hljs-comment">//    restricted_token.AddAllSidsForDenyOnly(&amp;sid_exceptions);</span><br>  <span class="hljs-comment">// Note: A Sid marked for Deny Only in a token cannot be used to grant</span><br>  <span class="hljs-comment">// access to any resource. It can only be used to deny access.</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">AddAllSidsForDenyOnly</span><span class="hljs-params">(std::vector&lt;Sid&gt;* exceptions)</span></span>;<br><br>  <span class="hljs-comment">// Adds a user or group SID for Deny Only in the restricted token.</span><br>  <span class="hljs-comment">// Parameter: sid is the SID to add in the Deny Only list.</span><br>  <span class="hljs-comment">// The return value is always ERROR_SUCCESS.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// Sample Usage:</span><br>  <span class="hljs-comment">//    restricted_token.AddSidForDenyOnly(ATL::Sids::Admins().GetPSID());</span><br>  <span class="hljs-comment">// 某个SID设为Deny Only</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">AddSidForDenyOnly</span><span class="hljs-params">(<span class="hljs-type">const</span> Sid&amp; sid)</span></span>;<br><br>  <span class="hljs-comment">// Adds the user sid of the token for Deny Only in the restricted token.</span><br>  <span class="hljs-comment">// If the function succeeds, the return value is ERROR_SUCCESS. If the</span><br>  <span class="hljs-comment">// function fails, the return value is the win32 error code corresponding to</span><br>  <span class="hljs-comment">// the error.</span><br>  <span class="hljs-comment">// 这个是user SID的版本</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">AddUserSidForDenyOnly</span><span class="hljs-params">()</span></span>;<br><br>  <span class="hljs-comment">// Lists all privileges in the token and add them to the list of privileges</span><br>  <span class="hljs-comment">// to remove except for those present in the exceptions parameter. If</span><br>  <span class="hljs-comment">// there is no exception needed, the caller can pass an empty list or nullptr</span><br>  <span class="hljs-comment">// for the exceptions parameter.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// If the function succeeds, the return value is ERROR_SUCCESS. If the</span><br>  <span class="hljs-comment">// function fails, the return value is the win32 error code corresponding to</span><br>  <span class="hljs-comment">// the error.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// Sample usage:</span><br>  <span class="hljs-comment">//    std::vector&lt;base::string16&gt; privilege_exceptions;</span><br>  <span class="hljs-comment">//    privilege_exceptions.push_back(SE_CHANGE_NOTIFY_NAME);</span><br>  <span class="hljs-comment">//    restricted_token.DeleteAllPrivileges(&amp;privilege_exceptions);</span><br>  <span class="hljs-comment">// 删除所有特权，除了白名单的那些privilege</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">DeleteAllPrivileges</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;base::string16&gt;* exceptions)</span></span>;<br><br>  <span class="hljs-comment">// Adds a privilege to the list of privileges to remove in the restricted</span><br>  <span class="hljs-comment">// token.</span><br>  <span class="hljs-comment">// Parameter: privilege is the privilege name to remove. This is the string</span><br>  <span class="hljs-comment">// representing the privilege. (e.g. &quot;SeChangeNotifyPrivilege&quot;).</span><br>  <span class="hljs-comment">// If the function succeeds, the return value is ERROR_SUCCESS. If the</span><br>  <span class="hljs-comment">// function fails, the return value is the win32 error code corresponding to</span><br>  <span class="hljs-comment">// the error.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// Sample usage:</span><br>  <span class="hljs-comment">//    restricted_token.DeletePrivilege(SE_LOAD_DRIVER_NAME);</span><br>  <span class="hljs-comment">// 删除某个特权</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">DeletePrivilege</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* privilege)</span></span>;<br><br>  <span class="hljs-comment">// Adds a SID to the list of restricting sids in the restricted token.</span><br>  <span class="hljs-comment">// Parameter: sid is the sid to add to the list restricting sids.</span><br>  <span class="hljs-comment">// The return value is always ERROR_SUCCESS.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// Sample usage:</span><br>  <span class="hljs-comment">//    restricted_token.AddRestrictingSid(ATL::Sids::Users().GetPSID());</span><br>  <span class="hljs-comment">// Note: The list of restricting is used to force Windows to perform all</span><br>  <span class="hljs-comment">// access checks twice. The first time using your user SID and your groups,</span><br>  <span class="hljs-comment">// and the second time using your list of restricting sids. The access has</span><br>  <span class="hljs-comment">// to be granted in both places to get access to the resource requested.</span><br>  <span class="hljs-comment">// Restricting SID强制windows对所有检查进行两次。</span><br>  <span class="hljs-comment">// 第一次使用你的用户和组SID，第二次使用restricting SID列表的SID。</span><br>  <span class="hljs-comment">// 两次必须都被授予可访问，才能通过请求</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">AddRestrictingSid</span><span class="hljs-params">(<span class="hljs-type">const</span> Sid&amp; sid)</span></span>;<br><br>  <span class="hljs-comment">// Adds the logon sid of the token in the list of restricting sids for the</span><br>  <span class="hljs-comment">// restricted token.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// If the function succeeds, the return value is ERROR_SUCCESS. If the</span><br>  <span class="hljs-comment">// function fails, the return value is the win32 error code corresponding to</span><br>  <span class="hljs-comment">// the error.</span><br>  <span class="hljs-comment">// Logon SID是个特殊的SID，是登录会话进行时系统随机生成的（SID最后一节）</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">AddRestrictingSidLogonSession</span><span class="hljs-params">()</span></span>;<br><br>  <span class="hljs-comment">// Adds the owner sid of the token in the list of restricting sids for the</span><br>  <span class="hljs-comment">// restricted token.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// If the function succeeds, the return value is ERROR_SUCCESS. If the</span><br>  <span class="hljs-comment">// function fails, the return value is the win32 error code corresponding to</span><br>  <span class="hljs-comment">// the error.</span><br>  <span class="hljs-comment">// 把所有者SID也加到restricting SID列表</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">AddRestrictingSidCurrentUser</span><span class="hljs-params">()</span></span>;<br><br>  <span class="hljs-comment">// Adds all group sids and the user sid to the restricting sids list.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// If the function succeeds, the return value is ERROR_SUCCESS. If the</span><br>  <span class="hljs-comment">// function fails, the return value is the win32 error code corresponding to</span><br>  <span class="hljs-comment">// the error.</span><br>  <span class="hljs-comment">// token的所有用户/组 SID都加入到restricting sid列表</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">AddRestrictingSidAllSids</span><span class="hljs-params">()</span></span>;<br><br>  <span class="hljs-comment">// Sets the token integrity level. This is only valid on Vista. The integrity</span><br>  <span class="hljs-comment">// level cannot be higher than your current integrity level.</span><br>  <span class="hljs-comment">// IL是用于隔离同一所有者不同权限资源的机制，实际上windows上最终也会折射成一个SID</span><br>  <span class="hljs-comment">// 只是SID的不同节值表示不同含义，并以此区分开</span><br>  <span class="hljs-function">DWORD <span class="hljs-title">SetIntegrityLevel</span><span class="hljs-params">(IntegrityLevel integrity_level)</span></span>;<br><br>  <span class="hljs-comment">// Set a flag which indicates the created token should have a locked down</span><br>  <span class="hljs-comment">// default DACL when created.</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetLockdownDefaultDacl</span><span class="hljs-params">()</span></span>;<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-comment">// The list of restricting sids in the restricted token.</span><br>  std::vector&lt;Sid&gt; sids_to_restrict_;<br>  <span class="hljs-comment">// The list of privileges to remove in the restricted token.</span><br>  std::vector&lt;LUID&gt; privileges_to_disable_;<br>  <span class="hljs-comment">// The list of sids to mark as Deny Only in the restricted token.</span><br>  std::vector&lt;Sid&gt; sids_for_deny_only_;<br>  <span class="hljs-comment">// The token to restrict. Can only be set in a constructor.</span><br>  base::win::ScopedHandle effective_token_;<br>  <span class="hljs-comment">// The token integrity level. Only valid on Vista.</span><br>  IntegrityLevel integrity_level_;<br>  <span class="hljs-comment">// Tells if the object is initialized or not (if Init() has been called)</span><br>  <span class="hljs-type">bool</span> init_;<br>  <span class="hljs-comment">// Lockdown the default DACL when creating new tokens.</span><br>  <span class="hljs-type">bool</span> lockdown_default_dacl_;<br><br>  <span class="hljs-built_in">DISALLOW_COPY_AND_ASSIGN</span>(RestrictedToken);<br>&#125;;<br></code></pre></td></tr></table></figure>
<h3 id="构造器init"><code>构造器+Init</code></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs cpp">RestrictedToken::<span class="hljs-built_in">RestrictedToken</span>()<br>    : <span class="hljs-built_in">integrity_level_</span>(INTEGRITY_LEVEL_LAST),<br>      <span class="hljs-built_in">init_</span>(<span class="hljs-literal">false</span>),<br>      <span class="hljs-built_in">lockdown_default_dacl_</span>(<span class="hljs-literal">false</span>) &#123;&#125;<br><br>RestrictedToken::~<span class="hljs-built_in">RestrictedToken</span>() &#123;&#125;<br><br><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::Init</span><span class="hljs-params">(<span class="hljs-type">const</span> HANDLE effective_token)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (init_)<br>    <span class="hljs-keyword">return</span> ERROR_ALREADY_INITIALIZED;<br><br>  HANDLE temp_token;<br>  <span class="hljs-keyword">if</span> (effective_token) &#123;<br>    <span class="hljs-comment">// We duplicate the handle to be able to use it even if the original handle</span><br>    <span class="hljs-comment">// is closed.</span><br>    <span class="hljs-comment">// 使用受限令牌的WinAPI定式，复制句柄-&gt;打开进程令牌</span><br>    <span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">DuplicateHandle</span>(::<span class="hljs-built_in">GetCurrentProcess</span>(), effective_token,<br>                           ::<span class="hljs-built_in">GetCurrentProcess</span>(), &amp;temp_token, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>,<br>                           DUPLICATE_SAME_ACCESS)) &#123;<br>      <span class="hljs-keyword">return</span> ::<span class="hljs-built_in">GetLastError</span>();<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">OpenProcessToken</span>(::<span class="hljs-built_in">GetCurrentProcess</span>(), TOKEN_ALL_ACCESS,<br>                            &amp;temp_token)) &#123;<br>      <span class="hljs-keyword">return</span> ::<span class="hljs-built_in">GetLastError</span>();<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">// 到这里，effective_token_成员就是当前或某个进程的句柄了（取决于传入参数是不是空）</span><br>  effective_token_.<span class="hljs-built_in">Set</span>(temp_token);<br><br>  init_ = <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="sid-related"><code>SID related</code></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::AddAllSidsForDenyOnly</span><span class="hljs-params">(std::vector&lt;Sid&gt;* exceptions)</span> </span>&#123;<br>  <span class="hljs-built_in">DCHECK</span>(init_);	<span class="hljs-comment">//确保干这事的时候已经初始化过了</span><br>  <span class="hljs-keyword">if</span> (!init_)<br>    <span class="hljs-keyword">return</span> ERROR_NO_TOKEN;<br><br>  DWORD error;<br>  <span class="hljs-comment">// Windows API GetTokenInformation的封装</span><br>  <span class="hljs-comment">// TokenGroups这个枚举值表示所有组SID</span><br>  std::unique_ptr&lt;BYTE[]&gt; buffer =<br>      <span class="hljs-built_in">GetTokenInfo</span>(effective_token_, TokenGroups, &amp;error);<br><br>  <span class="hljs-keyword">if</span> (!buffer)<br>    <span class="hljs-keyword">return</span> error;<br><br>  <span class="hljs-comment">//通过获取的group SID，构筑deny only group SID列表</span><br>  TOKEN_GROUPS* token_groups = <span class="hljs-built_in">reinterpret_cast</span>&lt;TOKEN_GROUPS*&gt;(buffer.<span class="hljs-built_in">get</span>());<br><br>  <span class="hljs-comment">// Build the list of the deny only group SIDs</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; token_groups-&gt;GroupCount; ++i) &#123;<br>    <span class="hljs-keyword">if</span> ((token_groups-&gt;Groups[i].Attributes &amp; SE_GROUP_INTEGRITY) == <span class="hljs-number">0</span> &amp;&amp;<br>        (token_groups-&gt;Groups[i].Attributes &amp; SE_GROUP_LOGON_ID) == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-type">bool</span> should_ignore = <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">if</span> (exceptions) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; exceptions-&gt;<span class="hljs-built_in">size</span>(); ++j) &#123;<br>          <span class="hljs-keyword">if</span> (::<span class="hljs-built_in">EqualSid</span>((*exceptions)[j].<span class="hljs-built_in">GetPSID</span>(),<br>                         token_groups-&gt;Groups[i].Sid)) &#123;<br>            should_ignore = <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">break</span>;<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (!should_ignore) &#123;<br>        <span class="hljs-comment">// 装入group SID</span><br>        sids_for_deny_only_.<span class="hljs-built_in">push_back</span>(<br>            <span class="hljs-built_in">reinterpret_cast</span>&lt;SID*&gt;(token_groups-&gt;Groups[i].Sid));<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br><span class="hljs-comment">// 所以上面这货是装所有组SID的</span><br><span class="hljs-comment">// user sid只可能有一个，但组SID则可能有多个（用户在多个组）</span><br><br><span class="hljs-comment">// 载入特定SID</span><br><span class="hljs-comment">// 注意没有白名单的拦截</span><br><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::AddSidForDenyOnly</span><span class="hljs-params">(<span class="hljs-type">const</span> Sid&amp; sid)</span> </span>&#123;<br>  <span class="hljs-built_in">DCHECK</span>(init_);<br>  <span class="hljs-keyword">if</span> (!init_)<br>    <span class="hljs-keyword">return</span> ERROR_NO_TOKEN;<br><br>  sids_for_deny_only_.<span class="hljs-built_in">push_back</span>(sid);<br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br><br><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::AddUserSidForDenyOnly</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-built_in">DCHECK</span>(init_);<br>  <span class="hljs-keyword">if</span> (!init_)<br>    <span class="hljs-keyword">return</span> ERROR_NO_TOKEN;<br><br>  DWORD size = <span class="hljs-built_in">sizeof</span>(TOKEN_USER) + SECURITY_MAX_SID_SIZE;<br>  <span class="hljs-function">std::unique_ptr&lt;BYTE[]&gt; <span class="hljs-title">buffer</span><span class="hljs-params">(<span class="hljs-keyword">new</span> BYTE[size])</span></span>;<br>  TOKEN_USER* token_user = <span class="hljs-built_in">reinterpret_cast</span>&lt;TOKEN_USER*&gt;(buffer.<span class="hljs-built_in">get</span>());<br><br>  <span class="hljs-comment">// TokenUser枚举量则表示获取User SID。这次没封装。</span><br>  <span class="hljs-comment">// 因为SID仅有一个，所以知道buffer的合适大小，调用一次就行</span><br>  <span class="hljs-type">bool</span> result = ::<span class="hljs-built_in">GetTokenInformation</span>(effective_token_.<span class="hljs-built_in">Get</span>(), TokenUser,<br>                                      token_user, size, &amp;size);<br><br>  <span class="hljs-keyword">if</span> (!result)<br>    <span class="hljs-keyword">return</span> ::<span class="hljs-built_in">GetLastError</span>();<br><br>  Sid user = <span class="hljs-built_in">reinterpret_cast</span>&lt;SID*&gt;(token_user-&gt;User.Sid);<br>  sids_for_deny_only_.<span class="hljs-built_in">push_back</span>(user);<br><br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>有意思的是获取组SID封装了一个外部函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Calls GetTokenInformation with the desired |info_class| and returns a buffer</span><br><span class="hljs-comment">// with the result.</span><br><span class="hljs-function">std::unique_ptr&lt;BYTE[]&gt; <span class="hljs-title">GetTokenInfo</span><span class="hljs-params">(<span class="hljs-type">const</span> base::win::ScopedHandle&amp; token,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     TOKEN_INFORMATION_CLASS info_class,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     DWORD* error)</span> </span>&#123;<br>  <span class="hljs-comment">// Get the required buffer size.</span><br>  <span class="hljs-comment">// 因为组SID是不定长的，无法预先知道长度，GetTokenInformation这个API允许通过传入null的方式来获取长度，然后再二次调用</span><br>  <span class="hljs-comment">// 很多Windows API都有这个特性，好比炉石的暗影步刷一个范克里夫</span><br>  DWORD size = <span class="hljs-number">0</span>;<br>  ::<span class="hljs-built_in">GetTokenInformation</span>(token.<span class="hljs-built_in">Get</span>(), info_class, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, &amp;size);<br>  <span class="hljs-keyword">if</span> (!size) &#123;<br>    *error = ::<span class="hljs-built_in">GetLastError</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  &#125;<br><br>  <span class="hljs-function">std::unique_ptr&lt;BYTE[]&gt; <span class="hljs-title">buffer</span><span class="hljs-params">(<span class="hljs-keyword">new</span> BYTE[size])</span></span>;<br>  <span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">GetTokenInformation</span>(token.<span class="hljs-built_in">Get</span>(), info_class, buffer.<span class="hljs-built_in">get</span>(), size,<br>                             &amp;size)) &#123;<br>    *error = ::<span class="hljs-built_in">GetLastError</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  &#125;<br><br>  *error = ERROR_SUCCESS;<br>  <span class="hljs-keyword">return</span> buffer;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="privilege-related">privilege related</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::DeleteAllPrivileges</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> std::vector&lt;base::string16&gt;* exceptions)</span> </span>&#123;<br>  <span class="hljs-built_in">DCHECK</span>(init_);<br>  <span class="hljs-keyword">if</span> (!init_)<br>    <span class="hljs-keyword">return</span> ERROR_NO_TOKEN;<br><br>  DWORD error;<br>  <span class="hljs-comment">// Privilege是token组成的一部分，通过TokenPrivileges枚举来获取</span><br>  <span class="hljs-comment">// 不定个privilege同样也是未知长度buffer</span><br>  std::unique_ptr&lt;BYTE[]&gt; buffer =<br>      <span class="hljs-built_in">GetTokenInfo</span>(effective_token_, TokenPrivileges, &amp;error);<br><br>  <span class="hljs-keyword">if</span> (!buffer)<br>    <span class="hljs-keyword">return</span> error;<br><br>  TOKEN_PRIVILEGES* token_privileges =<br>      <span class="hljs-built_in">reinterpret_cast</span>&lt;TOKEN_PRIVILEGES*&gt;(buffer.<span class="hljs-built_in">get</span>());<br><br>  <span class="hljs-comment">// Build the list of privileges to disable</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; token_privileges-&gt;PrivilegeCount; ++i) &#123;<br>    <span class="hljs-type">bool</span> should_ignore = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (exceptions) &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; exceptions-&gt;<span class="hljs-built_in">size</span>(); ++j) &#123;<br>        <span class="hljs-comment">// 特权在windows中以LUID值存在，这里通过比较LUID来判断是不是在白名单中</span><br>        LUID luid = &#123;<span class="hljs-number">0</span>&#125;;<br>        ::<span class="hljs-built_in">LookupPrivilegeValue</span>(<span class="hljs-literal">nullptr</span>, (*exceptions)[j].<span class="hljs-built_in">c_str</span>(), &amp;luid);<br>        <span class="hljs-keyword">if</span> (token_privileges-&gt;Privileges[i].Luid.HighPart == luid.HighPart &amp;&amp;<br>            token_privileges-&gt;Privileges[i].Luid.LowPart == luid.LowPart) &#123;<br>          should_ignore = <span class="hljs-literal">true</span>;<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!should_ignore) &#123;<br>      <span class="hljs-comment">// 装入</span><br>      privileges_to_disable_.<span class="hljs-built_in">push_back</span>(token_privileges-&gt;Privileges[i].Luid);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br><br><span class="hljs-comment">// 删除某条具体的特权，这个就很easy了，注意没有白名单的拦截</span><br><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::DeletePrivilege</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* privilege)</span> </span>&#123;<br>  <span class="hljs-built_in">DCHECK</span>(init_);<br>  <span class="hljs-keyword">if</span> (!init_)<br>    <span class="hljs-keyword">return</span> ERROR_NO_TOKEN;<br><br>  LUID luid = &#123;<span class="hljs-number">0</span>&#125;;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">LookupPrivilegeValue</span>(<span class="hljs-literal">nullptr</span>, privilege, &amp;luid))<br>    privileges_to_disable_.<span class="hljs-built_in">push_back</span>(luid);<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">return</span> ::<span class="hljs-built_in">GetLastError</span>();<br><br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="restricting-sid-list-related">Restricting SID list related</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 载入特定sid，没啥好说的</span><br><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::AddRestrictingSid</span><span class="hljs-params">(<span class="hljs-type">const</span> Sid&amp; sid)</span> </span>&#123;<br>  <span class="hljs-built_in">DCHECK</span>(init_);<br>  <span class="hljs-keyword">if</span> (!init_)<br>    <span class="hljs-keyword">return</span> ERROR_NO_TOKEN;<br><br>  sids_to_restrict_.<span class="hljs-built_in">push_back</span>(sid);  <span class="hljs-comment">// No attributes</span><br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br><br><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::AddRestrictingSidLogonSession</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-built_in">DCHECK</span>(init_);<br>  <span class="hljs-keyword">if</span> (!init_)<br>    <span class="hljs-keyword">return</span> ERROR_NO_TOKEN;<br><br>  <span class="hljs-comment">// 先找所有的group SID</span><br>  DWORD error;<br>  std::unique_ptr&lt;BYTE[]&gt; buffer =<br>      <span class="hljs-built_in">GetTokenInfo</span>(effective_token_, TokenGroups, &amp;error);<br><br>  <span class="hljs-keyword">if</span> (!buffer)<br>    <span class="hljs-keyword">return</span> error;<br><br>  TOKEN_GROUPS* token_groups = <span class="hljs-built_in">reinterpret_cast</span>&lt;TOKEN_GROUPS*&gt;(buffer.<span class="hljs-built_in">get</span>());<br><br>  SID* logon_sid = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-comment">// 在group SID中找那个SE_GROUP_LOGON_ID属性的SID，这个就是logon SID</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; token_groups-&gt;GroupCount; ++i) &#123;<br>    <span class="hljs-keyword">if</span> ((token_groups-&gt;Groups[i].Attributes &amp; SE_GROUP_LOGON_ID) != <span class="hljs-number">0</span>) &#123;<br>      logon_sid = <span class="hljs-built_in">static_cast</span>&lt;SID*&gt;(token_groups-&gt;Groups[i].Sid);<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (logon_sid)<br>    sids_to_restrict_.<span class="hljs-built_in">push_back</span>(logon_sid);<br><br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br><br><span class="hljs-comment">// 这个和上面的DenyOnly设定类似</span><br><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::AddRestrictingSidCurrentUser</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-built_in">DCHECK</span>(init_);<br>  <span class="hljs-keyword">if</span> (!init_)<br>    <span class="hljs-keyword">return</span> ERROR_NO_TOKEN;<br><br>  DWORD size = <span class="hljs-built_in">sizeof</span>(TOKEN_USER) + SECURITY_MAX_SID_SIZE;<br>  <span class="hljs-function">std::unique_ptr&lt;BYTE[]&gt; <span class="hljs-title">buffer</span><span class="hljs-params">(<span class="hljs-keyword">new</span> BYTE[size])</span></span>;<br>  TOKEN_USER* token_user = <span class="hljs-built_in">reinterpret_cast</span>&lt;TOKEN_USER*&gt;(buffer.<span class="hljs-built_in">get</span>());<br><br>  <span class="hljs-type">bool</span> result = ::<span class="hljs-built_in">GetTokenInformation</span>(effective_token_.<span class="hljs-built_in">Get</span>(), TokenUser,<br>                                      token_user, size, &amp;size);<br><br>  <span class="hljs-keyword">if</span> (!result)<br>    <span class="hljs-keyword">return</span> ::<span class="hljs-built_in">GetLastError</span>();<br><br>  Sid user = <span class="hljs-built_in">reinterpret_cast</span>&lt;SID*&gt;(token_user-&gt;User.Sid);<br>  sids_to_restrict_.<span class="hljs-built_in">push_back</span>(user);<br><br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br><br><span class="hljs-comment">// 这个也和Deny only的类似，对所有group SID都加入到restricting SID list</span><br><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::AddRestrictingSidAllSids</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-built_in">DCHECK</span>(init_);<br>  <span class="hljs-keyword">if</span> (!init_)<br>    <span class="hljs-keyword">return</span> ERROR_NO_TOKEN;<br><br>  <span class="hljs-comment">// Add the current user to the list.</span><br>  DWORD error = <span class="hljs-built_in">AddRestrictingSidCurrentUser</span>();<br>  <span class="hljs-keyword">if</span> (ERROR_SUCCESS != error)<br>    <span class="hljs-keyword">return</span> error;<br><br>  std::unique_ptr&lt;BYTE[]&gt; buffer =<br>      <span class="hljs-built_in">GetTokenInfo</span>(effective_token_, TokenGroups, &amp;error);<br><br>  <span class="hljs-keyword">if</span> (!buffer)<br>    <span class="hljs-keyword">return</span> error;<br><br>  TOKEN_GROUPS* token_groups = <span class="hljs-built_in">reinterpret_cast</span>&lt;TOKEN_GROUPS*&gt;(buffer.<span class="hljs-built_in">get</span>());<br><br>  <span class="hljs-comment">// Build the list of restricting sids from all groups.</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; token_groups-&gt;GroupCount; ++i) &#123;<br>    <span class="hljs-keyword">if</span> ((token_groups-&gt;Groups[i].Attributes &amp; SE_GROUP_INTEGRITY) == <span class="hljs-number">0</span>)<br>      <span class="hljs-built_in">AddRestrictingSid</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;SID*&gt;(token_groups-&gt;Groups[i].Sid));<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>关于SID的意义，以及chrome对它的封装类Sid，就不展开了，实际上只是把各种类型各种渠道的SID使用不同的static接口汇集在了一起，最终都变成了一个Sid对象。具体请自己阅读Sid.h/Sid.cc。</p>
</blockquote>
<h3 id="integrity-level-related">Integrity Level related</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::SetIntegrityLevel</span><span class="hljs-params">(IntegrityLevel integrity_level)</span> </span>&#123;<br>  <span class="hljs-comment">// 仅仅只是个成员set，实际上IL到Token SID的转换，我们在前面已经见过了。</span><br>  integrity_level_ = integrity_level;<br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="getrestrictedtoken-related">GetRestrictedToken related</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::GetRestrictedToken</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    base::win::ScopedHandle* token)</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-built_in">DCHECK</span>(init_);<br>  <span class="hljs-keyword">if</span> (!init_)<br>    <span class="hljs-keyword">return</span> ERROR_NO_TOKEN;<br><br>  <span class="hljs-comment">// 调用Get的时机，对三个代表的容器应该都已经设置好了</span><br>  <span class="hljs-type">size_t</span> deny_size = sids_for_deny_only_.<span class="hljs-built_in">size</span>();<br>  <span class="hljs-type">size_t</span> restrict_size = sids_to_restrict_.<span class="hljs-built_in">size</span>();<br>  <span class="hljs-type">size_t</span> privileges_size = privileges_to_disable_.<span class="hljs-built_in">size</span>();<br><br>  <span class="hljs-comment">// SID_AND_ATTRIBUTES和LUID_AND_ATTRIBUTES是token存SID和privilege的结构体</span><br>  SID_AND_ATTRIBUTES* deny_only_array = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-keyword">if</span> (deny_size) &#123;<br>    deny_only_array = <span class="hljs-keyword">new</span> SID_AND_ATTRIBUTES[deny_size];<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; sids_for_deny_only_.<span class="hljs-built_in">size</span>(); ++i) &#123;<br>      deny_only_array[i].Attributes = SE_GROUP_USE_FOR_DENY_ONLY;<span class="hljs-comment">//这个是key</span><br>      deny_only_array[i].Sid = sids_for_deny_only_[i].<span class="hljs-built_in">GetPSID</span>();<br>    &#125;<br>  &#125;<br><br>  SID_AND_ATTRIBUTES* sids_to_restrict_array = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-keyword">if</span> (restrict_size) &#123;<br>    sids_to_restrict_array = <span class="hljs-keyword">new</span> SID_AND_ATTRIBUTES[restrict_size];<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; restrict_size; ++i) &#123;<br>      sids_to_restrict_array[i].Attributes = <span class="hljs-number">0</span>;<span class="hljs-comment">//同理</span><br>      sids_to_restrict_array[i].Sid = sids_to_restrict_[i].<span class="hljs-built_in">GetPSID</span>();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 特权的结构和SID不一样</span><br>  LUID_AND_ATTRIBUTES* privileges_to_disable_array = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-keyword">if</span> (privileges_size) &#123;<br>    privileges_to_disable_array = <span class="hljs-keyword">new</span> LUID_AND_ATTRIBUTES[privileges_size];<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; privileges_size; ++i) &#123;<br>      privileges_to_disable_array[i].Attributes = <span class="hljs-number">0</span>;<br>      privileges_to_disable_array[i].Luid = privileges_to_disable_[i];<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-type">bool</span> result = <span class="hljs-literal">true</span>;<br>  HANDLE new_token_handle = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-comment">// The SANDBOX_INERT flag did nothing in XP and it was just a way to tell</span><br>  <span class="hljs-comment">// if a token has ben restricted given the limiations of IsTokenRestricted()</span><br>  <span class="hljs-comment">// but it appears that in Windows 7 it hints the AppLocker subsystem to</span><br>  <span class="hljs-comment">// leave us alone.</span><br>  <span class="hljs-comment">// Windows API真身在此</span><br>  <span class="hljs-keyword">if</span> (deny_size || restrict_size || privileges_size) &#123;<br>    result = ::<span class="hljs-built_in">CreateRestrictedToken</span>(<br>        effective_token_.<span class="hljs-built_in">Get</span>(), SANDBOX_INERT, <span class="hljs-built_in">static_cast</span>&lt;DWORD&gt;(deny_size),<br>        deny_only_array, <span class="hljs-built_in">static_cast</span>&lt;DWORD&gt;(privileges_size),<br>        privileges_to_disable_array, <span class="hljs-built_in">static_cast</span>&lt;DWORD&gt;(restrict_size),<br>        sids_to_restrict_array, &amp;new_token_handle);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// Duplicate the token even if it&#x27;s not modified at this point</span><br>    <span class="hljs-comment">// because any subsequent changes to this token would also affect the</span><br>    <span class="hljs-comment">// current process.</span><br>    result = ::<span class="hljs-built_in">DuplicateTokenEx</span>(effective_token_.<span class="hljs-built_in">Get</span>(), TOKEN_ALL_ACCESS,<br>                                <span class="hljs-literal">nullptr</span>, SecurityIdentification, TokenPrimary,<br>                                &amp;new_token_handle);<br>  &#125;<br>  <span class="hljs-keyword">auto</span> last_error = ::<span class="hljs-built_in">GetLastError</span>();<br><br>  <span class="hljs-comment">// 清理资源</span><br>  <span class="hljs-keyword">if</span> (deny_only_array)<br>    <span class="hljs-keyword">delete</span>[] deny_only_array;<br><br>  <span class="hljs-keyword">if</span> (sids_to_restrict_array)<br>    <span class="hljs-keyword">delete</span>[] sids_to_restrict_array;<br><br>  <span class="hljs-keyword">if</span> (privileges_to_disable_array)<br>    <span class="hljs-keyword">delete</span>[] privileges_to_disable_array;<br><br>  <span class="hljs-keyword">if</span> (!result)<br>    <span class="hljs-keyword">return</span> last_error;<br><br>  base::<span class="hljs-function">win::ScopedHandle <span class="hljs-title">new_token</span><span class="hljs-params">(new_token_handle)</span></span>;<br><br>  <span class="hljs-keyword">if</span> (lockdown_default_dacl_) &#123;<br>    <span class="hljs-comment">// Don&#x27;t add Restricted sid and also remove logon sid access.</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">RevokeLogonSidFromDefaultDacl</span>(new_token.<span class="hljs-built_in">Get</span>()))<br>      <span class="hljs-keyword">return</span> ::<span class="hljs-built_in">GetLastError</span>();<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// Modify the default dacl on the token to contain Restricted.</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">AddSidToDefaultDacl</span>(new_token.<span class="hljs-built_in">Get</span>(), WinRestrictedCodeSid,<br>                             GRANT_ACCESS, GENERIC_ALL)) &#123;<br>      <span class="hljs-keyword">return</span> ::<span class="hljs-built_in">GetLastError</span>();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Add user to default dacl.</span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">AddUserSidToDefaultDacl</span>(new_token.<span class="hljs-built_in">Get</span>(), GENERIC_ALL))<br>    <span class="hljs-keyword">return</span> ::<span class="hljs-built_in">GetLastError</span>();<br><br>  <span class="hljs-comment">// 对IntegrityLevel的处理在这儿，实际上这个已经看过了，就是到SID的转换</span><br>  <span class="hljs-comment">// 然后通过SetTokenInformation API来设置属性为SE_GROUP_INTEGRITY的SID</span><br>  <span class="hljs-comment">// 换句话说，IL也不过是SID的一个子集，而SID是token的子集</span><br>  DWORD error = <span class="hljs-built_in">SetTokenIntegrityLevel</span>(new_token.<span class="hljs-built_in">Get</span>(), integrity_level_);<br>  <span class="hljs-keyword">if</span> (ERROR_SUCCESS != error)<br>    <span class="hljs-keyword">return</span> error;<br><br>  HANDLE token_handle;<br>  <span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">DuplicateHandle</span>(::<span class="hljs-built_in">GetCurrentProcess</span>(), new_token.<span class="hljs-built_in">Get</span>(),<br>                         ::<span class="hljs-built_in">GetCurrentProcess</span>(), &amp;token_handle, TOKEN_ALL_ACCESS,<br>                         <span class="hljs-literal">false</span>,  <span class="hljs-comment">// Don&#x27;t inherit.</span><br>                         <span class="hljs-number">0</span>)) &#123;<br>    <span class="hljs-keyword">return</span> ::<span class="hljs-built_in">GetLastError</span>();<br>  &#125;<br><br>  token-&gt;<span class="hljs-built_in">Set</span>(token_handle);<br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br><br><span class="hljs-function">DWORD <span class="hljs-title">RestrictedToken::GetRestrictedTokenForImpersonation</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    base::win::ScopedHandle* token)</span> <span class="hljs-type">const</span> </span>&#123;<br>  <span class="hljs-built_in">DCHECK</span>(init_);<br>  <span class="hljs-keyword">if</span> (!init_)<br>    <span class="hljs-keyword">return</span> ERROR_NO_TOKEN;<br><br>  base::win::ScopedHandle restricted_token;<br>  DWORD err_code = <span class="hljs-built_in">GetRestrictedToken</span>(&amp;restricted_token);<br>  <span class="hljs-keyword">if</span> (ERROR_SUCCESS != err_code)<br>    <span class="hljs-keyword">return</span> err_code;<br><br>  HANDLE impersonation_token_handle;<br>  <span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">DuplicateToken</span>(restricted_token.<span class="hljs-built_in">Get</span>(), SecurityImpersonation,<br>                        &amp;impersonation_token_handle)) &#123;<br>    <span class="hljs-keyword">return</span> ::<span class="hljs-built_in">GetLastError</span>();<br>  &#125;<br>  base::<span class="hljs-function">win::ScopedHandle <span class="hljs-title">impersonation_token</span><span class="hljs-params">(impersonation_token_handle)</span></span>;<br><br>  HANDLE token_handle;<br>  <span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">DuplicateHandle</span>(::<span class="hljs-built_in">GetCurrentProcess</span>(), impersonation_token.<span class="hljs-built_in">Get</span>(),<br>                         ::<span class="hljs-built_in">GetCurrentProcess</span>(), &amp;token_handle, TOKEN_ALL_ACCESS,<br>                         <span class="hljs-literal">false</span>,  <span class="hljs-comment">// Don&#x27;t inherit.</span><br>                         <span class="hljs-number">0</span>)) &#123;<br>    <span class="hljs-keyword">return</span> ::<span class="hljs-built_in">GetLastError</span>();<br>  &#125;<br><br>  token-&gt;<span class="hljs-built_in">Set</span>(token_handle);<br>  <span class="hljs-keyword">return</span> ERROR_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="createrestrictedtoken"><code>CreateRestrictedToken</code></h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Creates a restricted token based on the effective token of the current</span><br><span class="hljs-comment">// process. The parameter security_level determines how much the token is</span><br><span class="hljs-comment">// restricted. The token_type determines if the token will be used as a primary</span><br><span class="hljs-comment">// token or impersonation token. The integrity level of the token is set to</span><br><span class="hljs-comment">// |integrity level| on Vista only.</span><br><span class="hljs-comment">// |token| is the output value containing the handle of the newly created</span><br><span class="hljs-comment">// restricted token.</span><br><span class="hljs-comment">// |lockdown_default_dacl| indicates the token&#x27;s default DACL should be locked</span><br><span class="hljs-comment">// down to restrict what other process can open kernel resources created while</span><br><span class="hljs-comment">// running under the token.</span><br><span class="hljs-comment">// If the function succeeds, the return value is ERROR_SUCCESS. If the</span><br><span class="hljs-comment">// function fails, the return value is the win32 error code corresponding to</span><br><span class="hljs-comment">// the error.</span><br><span class="hljs-comment">// 根据注释多少能明白一些，传入的这些参数都是PolicyBase对象在调用前就设置好了的成员变量</span><br><span class="hljs-function">DWORD <span class="hljs-title">CreateRestrictedToken</span><span class="hljs-params">(TokenLevel security_level,</span></span><br><span class="hljs-params"><span class="hljs-function">                            IntegrityLevel integrity_level,</span></span><br><span class="hljs-params"><span class="hljs-function">                            TokenType token_type,</span></span><br><span class="hljs-params"><span class="hljs-function">                            <span class="hljs-type">bool</span> lockdown_default_dacl,</span></span><br><span class="hljs-params"><span class="hljs-function">                            base::win::ScopedHandle* token)</span> </span>&#123;<br>  RestrictedToken restricted_token;	<span class="hljs-comment">// 构造接Init素质二连</span><br>  restricted_token.<span class="hljs-built_in">Init</span>(<span class="hljs-literal">nullptr</span>);  <span class="hljs-comment">// Initialized with the current process token</span><br>  <span class="hljs-comment">// 如果有默认DACL，就设置下去</span><br>  <span class="hljs-keyword">if</span> (lockdown_default_dacl)<br>    restricted_token.<span class="hljs-built_in">SetLockdownDefaultDacl</span>();<br><br>  <span class="hljs-comment">// 这两个是用于开绿灯的白名单，一个是不要DenyOnly的SID，一个是不要删除的特权</span><br>  <span class="hljs-comment">// 这就看出了chrome的狠毒，除了白名单的指派其他一无所有。</span><br>  std::vector&lt;base::string16&gt; privilege_exceptions;<br>  std::vector&lt;Sid&gt; sid_exceptions;<br><br>  <span class="hljs-type">bool</span> deny_sids = <span class="hljs-literal">true</span>;<br>  <span class="hljs-type">bool</span> remove_privileges = <span class="hljs-literal">true</span>;<br><br>  <span class="hljs-comment">// TokenLevel是chrome封装的，到这里再会头看它定义处的注释，是否就豁然开朗了？</span><br>  <span class="hljs-comment">// 下面的分支处理，不过是对不同level的定义，部署3个代表（restricting SID/Deny Only SID/Privileges）</span><br>  <span class="hljs-keyword">switch</span> (security_level) &#123;<br>    <span class="hljs-comment">// 无需保护，关闭sid deny和privilege remove</span><br>    <span class="hljs-keyword">case</span> USER_UNPROTECTED: &#123;<br>      deny_sids = <span class="hljs-literal">false</span>;<br>      remove_privileges = <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> USER_RESTRICTED_SAME_ACCESS: &#123;<br>      deny_sids = <span class="hljs-literal">false</span>;<br>      remove_privileges = <span class="hljs-literal">false</span>;<br><br>      <span class="hljs-type">unsigned</span> err_code = restricted_token.<span class="hljs-built_in">AddRestrictingSidAllSids</span>();<br>      <span class="hljs-keyword">if</span> (ERROR_SUCCESS != err_code)<br>        <span class="hljs-keyword">return</span> err_code;<br><br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> USER_NON_ADMIN: &#123;<br>      sid_exceptions.<span class="hljs-built_in">push_back</span>(WinBuiltinUsersSid);<br>      sid_exceptions.<span class="hljs-built_in">push_back</span>(WinWorldSid);<br>      sid_exceptions.<span class="hljs-built_in">push_back</span>(WinInteractiveSid);<br>      sid_exceptions.<span class="hljs-built_in">push_back</span>(WinAuthenticatedUserSid);<br>      privilege_exceptions.<span class="hljs-built_in">push_back</span>(SE_CHANGE_NOTIFY_NAME);<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> USER_INTERACTIVE: &#123;<br>      sid_exceptions.<span class="hljs-built_in">push_back</span>(WinBuiltinUsersSid);<br>      sid_exceptions.<span class="hljs-built_in">push_back</span>(WinWorldSid);<br>      sid_exceptions.<span class="hljs-built_in">push_back</span>(WinInteractiveSid);<br>      sid_exceptions.<span class="hljs-built_in">push_back</span>(WinAuthenticatedUserSid);<br>      privilege_exceptions.<span class="hljs-built_in">push_back</span>(SE_CHANGE_NOTIFY_NAME);<br>      restricted_token.<span class="hljs-built_in">AddRestrictingSid</span>(WinBuiltinUsersSid);<br>      restricted_token.<span class="hljs-built_in">AddRestrictingSid</span>(WinWorldSid);<br>      restricted_token.<span class="hljs-built_in">AddRestrictingSid</span>(WinRestrictedCodeSid);<br>      restricted_token.<span class="hljs-built_in">AddRestrictingSidCurrentUser</span>();<br>      restricted_token.<span class="hljs-built_in">AddRestrictingSidLogonSession</span>();<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> USER_LIMITED: &#123;<br>      sid_exceptions.<span class="hljs-built_in">push_back</span>(WinBuiltinUsersSid);<br>      sid_exceptions.<span class="hljs-built_in">push_back</span>(WinWorldSid);<br>      sid_exceptions.<span class="hljs-built_in">push_back</span>(WinInteractiveSid);<br>      privilege_exceptions.<span class="hljs-built_in">push_back</span>(SE_CHANGE_NOTIFY_NAME);<br>      restricted_token.<span class="hljs-built_in">AddRestrictingSid</span>(WinBuiltinUsersSid);<br>      restricted_token.<span class="hljs-built_in">AddRestrictingSid</span>(WinWorldSid);<br>      restricted_token.<span class="hljs-built_in">AddRestrictingSid</span>(WinRestrictedCodeSid);<br><br>      <span class="hljs-comment">// This token has to be able to create objects in BNO.</span><br>      <span class="hljs-comment">// Unfortunately, on Vista+, it needs the current logon sid</span><br>      <span class="hljs-comment">// in the token to achieve this. You should also set the process to be</span><br>      <span class="hljs-comment">// low integrity level so it can&#x27;t access object created by other</span><br>      <span class="hljs-comment">// processes.</span><br>      restricted_token.<span class="hljs-built_in">AddRestrictingSidLogonSession</span>();<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> USER_RESTRICTED: &#123;<br>      privilege_exceptions.<span class="hljs-built_in">push_back</span>(SE_CHANGE_NOTIFY_NAME);<br>      restricted_token.<span class="hljs-built_in">AddUserSidForDenyOnly</span>();<br>      restricted_token.<span class="hljs-built_in">AddRestrictingSid</span>(WinRestrictedCodeSid);<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> USER_LOCKDOWN: &#123;<br>      restricted_token.<span class="hljs-built_in">AddUserSidForDenyOnly</span>();<br>      restricted_token.<span class="hljs-built_in">AddRestrictingSid</span>(WinNullSid);<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">default</span>: &#123; <span class="hljs-keyword">return</span> ERROR_BAD_ARGUMENTS; &#125;<br>  &#125;<br><br>  DWORD err_code = ERROR_SUCCESS;<br>  <span class="hljs-keyword">if</span> (deny_sids) &#123;<br>    err_code = restricted_token.<span class="hljs-built_in">AddAllSidsForDenyOnly</span>(&amp;sid_exceptions);<br>    <span class="hljs-keyword">if</span> (ERROR_SUCCESS != err_code)<br>      <span class="hljs-keyword">return</span> err_code;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (remove_privileges) &#123;<br>    err_code = restricted_token.<span class="hljs-built_in">DeleteAllPrivileges</span>(&amp;privilege_exceptions);<br>    <span class="hljs-keyword">if</span> (ERROR_SUCCESS != err_code)<br>      <span class="hljs-keyword">return</span> err_code;<br>  &#125;<br><br>  <span class="hljs-comment">// 这个只是填充个成员变量罢了</span><br>  restricted_token.<span class="hljs-built_in">SetIntegrityLevel</span>(integrity_level);<br><br>  <span class="hljs-comment">// lockdown token是PRIMARY而initial token是IMPERSONATION</span><br>  <span class="hljs-comment">// IMPERSONATION是个临时的token</span><br>  <span class="hljs-keyword">switch</span> (token_type) &#123;<br>    <span class="hljs-keyword">case</span> PRIMARY: &#123;<br>      err_code = restricted_token.<span class="hljs-built_in">GetRestrictedToken</span>(token);<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">case</span> IMPERSONATION: &#123;<br>      err_code = restricted_token.<span class="hljs-built_in">GetRestrictedTokenForImpersonation</span>(token);<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">default</span>: &#123;<br>      err_code = ERROR_BAD_ARGUMENTS;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> err_code;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="spawntarget-related"><code>SpawnTarget related</code></h2>
<p>回到<code>BrokerServicesBase::SpawnTarget</code>中，通过<code>policy_base-&gt;MakeToken</code>做出了三个token后，将initial和lockdown传给了<code>TargetProcess</code>构造器，new出target进程对象。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp">TargetProcess* target = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TargetProcess</span>(<br>      std::<span class="hljs-built_in">move</span>(initial_token), std::<span class="hljs-built_in">move</span>(lockdown_token), job.<span class="hljs-built_in">Get</span>(),<br>      thread_pool_.<span class="hljs-built_in">get</span>(),<br>      profile ? profile-&gt;<span class="hljs-built_in">GetImpersonationCapabilities</span>() : std::<span class="hljs-built_in">vector</span>&lt;Sid&gt;());<br></code></pre></td></tr></table></figure>
<p>而在构造器中，仅仅只是将两个token的所有权移给了成员<code>lockdown_token_</code>和<code>initial_token_</code>。此后在<code>TargetProcess::Create</code>中调用<code>CreateProcessAsUserW</code>
API时，使用了lockdown。该API的调用也是Windows使用token的定式。</p>
<p>所以target进程在创建的时候，使用的是lockdown
token作为process的token。</p>
<p>此后，<code>TargetProcess::Create</code>继续处理initial token：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">if</span> (initial_token_.<span class="hljs-built_in">IsValid</span>()) &#123;<br>    HANDLE impersonation_token = initial_token_.<span class="hljs-built_in">Get</span>();<br>    base::win::ScopedHandle app_container_token;<br>  	<span class="hljs-comment">// 这里是判断是否应用了AC，如果是的话，就用AC的app_container_token取代initial token</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">GetAppContainerImpersonationToken</span>(<br>            process_info.<span class="hljs-built_in">process_handle</span>(), impersonation_token,<br>            impersonation_capabilities_, &amp;app_container_token)) &#123;<br>      impersonation_token = app_container_token.<span class="hljs-built_in">Get</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// Change the token of the main thread of the new process for the</span><br>    <span class="hljs-comment">// impersonation token with more rights. This allows the target to start;</span><br>    <span class="hljs-comment">// otherwise it will crash too early for us to help.</span><br>  	<span class="hljs-comment">// 主线程临时使用这个impersonation token</span><br>    HANDLE temp_thread = process_info.<span class="hljs-built_in">thread_handle</span>();<br>    <span class="hljs-keyword">if</span> (!::<span class="hljs-built_in">SetThreadToken</span>(&amp;temp_thread, impersonation_token)) &#123;<br>      *win_error = ::<span class="hljs-built_in">GetLastError</span>();<br>      ::<span class="hljs-built_in">TerminateProcess</span>(process_info.<span class="hljs-built_in">process_handle</span>(), <span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">return</span> SBOX_ERROR_SET_THREAD_TOKEN;<br>    &#125;<br>  	<span class="hljs-comment">// 只能用一次，这个东西此后就没用了，关闭掉</span><br>    initial_token_.<span class="hljs-built_in">Close</span>();<br>  &#125;<br></code></pre></td></tr></table></figure>
<p>返回到<code>SpawnTarget</code>，此后会继续判断lowbox
token的合法性，如果有就<code>target-&gt;AssignLowBoxToken(lowbox_token);</code>。关于这个lowbox的使用意义，我暂时不深究。</p>
<p>此时，target进程已经做出来了，token也配置好了，但target是挂起的状态。</p>
<p><code>SpawnTarget</code>在<code>target-&gt;Create</code>之后_section,
access, false, 0)) { *win_error = ::GetLastError(); return
SBOX_ERROR_DUPLICATE_SHARED_SECTION; }</p>
<p>void* shared_memory = ::MapViewOfFile( shared_section_.Get(),
FILE_MAP_WRITE | FILE_MAP_READ, 0, 0, 0); if (!shared_memory) {
*win_error = ::GetLastError(); return
SBOX_ERROR_MAP_VIEW_OF_SHARED_SECTION; }</p>
<p>// 通过MapViewOfFile的共享内存方式，把policy传给target
CopyPolicyToTarget(policy, shared_policy_size,
reinterpret_cast&lt;char*&gt;(shared_memory) + shared_IPC_size);</p>
<p>ResultCode ret; // Set the global variables in the target. These are
not used on the broker. g_shared_section = target_shared_section; ret =
TransferVariable("g_shared_section", &amp;g_shared_section,
sizeof(g_shared_section)); g_shared_section = nullptr; if (SBOX_ALL_OK
!= ret) { <em>win_error = ::GetLastError(); return ret; }
g_shared_IPC_size = shared_IPC_size; ret =
TransferVariable("g_shared_IPC_size", &amp;g_shared_IPC_size,
sizeof(g_shared_IPC_size)); g_shared_IPC_size = 0; if (SBOX_ALL_OK !=
ret) { </em>win_error = ::GetLastError(); return ret; }
g_shared_policy_size = shared_policy_size; ret =
TransferVariable("g_shared_policy_size", &amp;g_shared_policy_size,
sizeof(g_shared_policy_size)); g_shared_policy_size = 0; if (SBOX_ALL_OK
!= ret) { *win_error = ::GetLastError(); return ret; }</p>
<p>ipc_server_.reset(new SharedMemIPCServer(
sandbox_process_info_.process_handle(),
sandbox_process_info_.process_id(), thread_pool_, ipc_dispatcher));</p>
<p>if (!ipc_server_-&gt;Init(shared_memory, shared_IPC_size,
kIPCChannelSize)) return SBOX_ERROR_NO_SPACE;</p>
<p>// After this point we cannot use this handle anymore.
::CloseHandle(sandbox_process_info_.TakeThreadHandle());</p>
<p>return SBOX_ALL_OK; } <figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><br>到这里，broker能对target进程做的就都做完了。而控制target运行的runner则又是另一片天地了。<br><br>回头看`TargetServicesBase::LowerToken`:<br><br>​```cpp<br><span class="hljs-comment">// Failure here is a breach of security so the process is terminated.</span><br>void TargetServicesBase::<span class="hljs-constructor">LowerToken()</span> &#123;<br>  <span class="hljs-keyword">if</span> (ERROR_SUCCESS !=<br>      <span class="hljs-constructor">SetProcessIntegrityLevel(<span class="hljs-params">g_shared_delayed_integrity_level</span>)</span>)<br>    ::<span class="hljs-constructor">TerminateProcess(::GetCurrentProcess()</span>, SBOX_FATAL_INTEGRITY);<br>  process_state_.<span class="hljs-constructor">SetRevertedToSelf()</span>;<br> <br>  <span class="hljs-comment">// If the client code as called RegOpenKey, advapi32.dll has cached some</span><br>  <span class="hljs-comment">// handles. The following code gets rid of them.</span><br>  <span class="hljs-comment">// 这个API名称虽然不起眼，但却大有作为，实际上他完成了从撤销impersonate到恢复primary token的过程</span><br>  <span class="hljs-keyword">if</span> (!::<span class="hljs-constructor">RevertToSelf()</span>)<br>    ::<span class="hljs-constructor">TerminateProcess(::GetCurrentProcess()</span>, SBOX_FATAL_DROPTOKEN);<br>  <span class="hljs-comment">// 这些先不关心，处理cache handle</span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-constructor">FlushCachedRegHandles()</span>)<br>    ::<span class="hljs-constructor">TerminateProcess(::GetCurrentProcess()</span>, SBOX_FATAL_FLUSHANDLES);<br>  <span class="hljs-keyword">if</span> (ERROR_SUCCESS != ::<span class="hljs-constructor">RegDisablePredefinedCache()</span>)<br>    ::<span class="hljs-constructor">TerminateProcess(::GetCurrentProcess()</span>, SBOX_FATAL_CACHEDISABLE);<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-constructor">WarmupWindowsLocales()</span>)<br>    ::<span class="hljs-constructor">TerminateProcess(::GetCurrentProcess()</span>, SBOX_FATAL_WARMUP);<br>  <span class="hljs-built_in">bool</span> is_csrss_connected = <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-constructor">CloseOpenHandles(&amp;<span class="hljs-params">is_csrss_connected</span>)</span>)<br>    ::<span class="hljs-constructor">TerminateProcess(::GetCurrentProcess()</span>, SBOX_FATAL_CLOSEHANDLES);<br>  process_state_.<span class="hljs-constructor">SetCsrssConnected(<span class="hljs-params">is_csrss_connected</span>)</span>;<br>  <span class="hljs-comment">// 处理mitigation</span><br>  <span class="hljs-comment">// Enabling mitigations must happen last otherwise handle closing breaks</span><br>  <span class="hljs-keyword">if</span> (g_shared_delayed_mitigations<span class="hljs-operator"> &amp;&amp;</span><br><span class="hljs-operator">      </span>!<span class="hljs-constructor">ApplyProcessMitigationsToCurrentProcess(<span class="hljs-params">g_shared_delayed_mitigations</span>)</span>)<br>    ::<span class="hljs-constructor">TerminateProcess(::GetCurrentProcess()</span>, SBOX_FATAL_MITIGATION);<br>&#125;<br><br><span class="hljs-comment">// 这个就一目了然了，使用新的integrity_level</span><br>DWORD <span class="hljs-constructor">SetProcessIntegrityLevel(IntegrityLevel <span class="hljs-params">integrity_level</span>)</span> &#123;<br>  <span class="hljs-comment">// We don&#x27;t check for an invalid level here because we&#x27;ll just let it</span><br>  <span class="hljs-comment">// fail on the SetTokenIntegrityLevel call later on.</span><br>  <span class="hljs-keyword">if</span> (integrity_level<span class="hljs-operator"> == </span>INTEGRITY_LEVEL_LAST) &#123;<br>    <span class="hljs-comment">// No mandatory level specified, we don&#x27;t change it.</span><br>    return ERROR_SUCCESS;<br>  &#125;<br><br>  HANDLE token_handle;<br>  <span class="hljs-keyword">if</span> (!::<span class="hljs-constructor">OpenProcessToken(GetCurrentProcess()</span>, TOKEN_ADJUST_DEFAULT,<br>                          &amp;token_handle))<br>    return ::<span class="hljs-constructor">GetLastError()</span>;<br><br>  base::win::ScopedHandle token(token_handle);<br><br>  return <span class="hljs-constructor">SetTokenIntegrityLevel(<span class="hljs-params">token</span>.Get()</span>, integrity_level);<br>&#125;<br><br><span class="hljs-comment">// 这些早先已经看过了</span><br>DWORD <span class="hljs-constructor">SetTokenIntegrityLevel(HANDLE <span class="hljs-params">token</span>, IntegrityLevel <span class="hljs-params">integrity_level</span>)</span> &#123;<br>  const wchar_t* integrity_level_str = <span class="hljs-constructor">GetIntegrityLevelString(<span class="hljs-params">integrity_level</span>)</span>;<br>  <span class="hljs-keyword">if</span> (!integrity_level_str) &#123;<br>    <span class="hljs-comment">// No mandatory level specified, we don&#x27;t change it.</span><br>    return ERROR_SUCCESS;<br>  &#125;<br><br>  PSID integrity_sid = nullptr;<br>  <span class="hljs-keyword">if</span> (!::<span class="hljs-constructor">ConvertStringSidToSid(<span class="hljs-params">integrity_level_str</span>, &amp;<span class="hljs-params">integrity_sid</span>)</span>)<br>    return ::<span class="hljs-constructor">GetLastError()</span>;<br><br>  TOKEN_MANDATORY_LABEL label = &#123;&#125;;<br>  label.Label.Attributes = SE_GROUP_INTEGRITY;<br>  label.Label.Sid = integrity_sid;<br><br>  DWORD size = sizeof(TOKEN_MANDATORY_LABEL) + ::<span class="hljs-constructor">GetLengthSid(<span class="hljs-params">integrity_sid</span>)</span>;<br>  <span class="hljs-built_in">bool</span> result = ::<span class="hljs-constructor">SetTokenInformation(<span class="hljs-params">token</span>, TokenIntegrityLevel, &amp;<span class="hljs-params">label</span>, <span class="hljs-params">size</span>)</span>;<br>  auto last_error = ::<span class="hljs-constructor">GetLastError()</span>;<br>  ::<span class="hljs-constructor">LocalFree(<span class="hljs-params">integrity_sid</span>)</span>;<br><br>  return result ? ERROR_SUCCESS : last_error;<br>&#125;<br><br>const wchar_t* <span class="hljs-constructor">GetIntegrityLevelString(IntegrityLevel <span class="hljs-params">integrity_level</span>)</span> &#123;<br>  switch (integrity_level) &#123;<br>    case INTEGRITY_LEVEL_SYSTEM:<br>      return L<span class="hljs-string">&quot;S-1-16-16384&quot;</span>;<br>    case INTEGRITY_LEVEL_HIGH:<br>      return L<span class="hljs-string">&quot;S-1-16-12288&quot;</span>;<br>    case INTEGRITY_LEVEL_MEDIUM:<br>      return L<span class="hljs-string">&quot;S-1-16-8192&quot;</span>;<br>    case INTEGRITY_LEVEL_MEDIUM_LOW:<br>      return L<span class="hljs-string">&quot;S-1-16-6144&quot;</span>;<br>    case INTEGRITY_LEVEL_LOW:<br>      return L<span class="hljs-string">&quot;S-1-16-4096&quot;</span>;<br>    case INTEGRITY_LEVEL_BELOW_LOW:<br>      return L<span class="hljs-string">&quot;S-1-16-2048&quot;</span>;<br>    case INTEGRITY_LEVEL_UNTRUSTED:<br>      return L<span class="hljs-string">&quot;S-1-16-0&quot;</span>;<br>    case INTEGRITY_LEVEL_LAST:<br>      return nullptr;<br>  &#125;<br><br>  <span class="hljs-constructor">NOTREACHED()</span>;<br>  return nullptr;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p>说白了，除了token有两个，initial和lockdown，mitigation和IL也有两个，后者更为严格且作为delayed项。当<code>LowerToken</code>时一并设置下去，而它们都是由broker的policy_base一早就设置好了的，并通过IPC传给了target。</p>
<h2 id="policybase-related"><code>PolicyBase</code> related</h2>
<p>到此，broker对target的所作所为，涉及到token的地方，就全都清楚了。而在<code>LowerToken</code>处我们发现还有个delayed
IL设置了下去，这个IL并非由broker控制，而是传入到<code>SpawnTarget</code>时，policy_base已经设置好了。</p>
<p>而<code>PolicyBase</code>的Owner就尤为关键了，policy的创建是由<code>BrokerServices::CreatePolicy</code>控制的，那么policy对象应该是独立的，在<code>SpawnTarget</code>之前，policy会调用成员函数来设置各种组件，比如我们研究的token。</p>
<p>在sandbox的源码中，可以参考一些test单元测试文件来验证猜想(policy_target_test.cc)。</p>
<p>随便贴一个：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Launches the app in the sandbox and ask it to wait in an</span><br><span class="hljs-comment">// infinite loop. Waits for 2 seconds and then check if the</span><br><span class="hljs-comment">// desktop associated with the app thread is not the same as the</span><br><span class="hljs-comment">// current desktop.</span><br><span class="hljs-built_in">TEST</span>(PolicyTargetTest, DesktopPolicy) &#123;<br>  BrokerServices* broker = <span class="hljs-built_in">GetBroker</span>();<br><br>  <span class="hljs-comment">// Precreate the desktop.</span><br>  scoped_refptr&lt;TargetPolicy&gt; temp_policy = broker-&gt;<span class="hljs-built_in">CreatePolicy</span>();<br>  temp_policy-&gt;<span class="hljs-built_in">CreateAlternateDesktop</span>(<span class="hljs-literal">false</span>);<br>  temp_policy = <span class="hljs-literal">nullptr</span>;<br><br>  <span class="hljs-built_in">ASSERT_TRUE</span>(broker);<br><br>  <span class="hljs-comment">// Get the path to the sandboxed app.</span><br>  <span class="hljs-type">wchar_t</span> prog_name[MAX_PATH];<br>  <span class="hljs-built_in">GetModuleFileNameW</span>(<span class="hljs-literal">nullptr</span>, prog_name, MAX_PATH);<br><br>  <span class="hljs-function">base::string16 <span class="hljs-title">arguments</span><span class="hljs-params">(<span class="hljs-string">L&quot;\&quot;&quot;</span>)</span></span>;<br>  arguments += prog_name;<br>  arguments += <span class="hljs-string">L&quot;\&quot; -child 0 wait&quot;</span>;  <span class="hljs-comment">// Don&#x27;t care about the &quot;state&quot; argument.</span><br><br>  <span class="hljs-comment">// Launch the app.</span><br>  ResultCode result = SBOX_ALL_OK;<br>  ResultCode warning_result = SBOX_ALL_OK;<br>  DWORD last_error = ERROR_SUCCESS;<br>  base::win::ScopedProcessInformation target;<br><br>  scoped_refptr&lt;TargetPolicy&gt; policy = broker-&gt;<span class="hljs-built_in">CreatePolicy</span>();<br>  policy-&gt;<span class="hljs-built_in">SetAlternateDesktop</span>(<span class="hljs-literal">false</span>);<br>  policy-&gt;<span class="hljs-built_in">SetTokenLevel</span>(USER_INTERACTIVE, USER_LOCKDOWN);<br>  PROCESS_INFORMATION temp_process_info = &#123;&#125;;<br>  result =<br>      broker-&gt;<span class="hljs-built_in">SpawnTarget</span>(prog_name, arguments.<span class="hljs-built_in">c_str</span>(), policy, &amp;warning_result,<br>                          &amp;last_error, &amp;temp_process_info);<br>  base::string16 desktop_name = policy-&gt;<span class="hljs-built_in">GetAlternateDesktop</span>();<br>  policy = <span class="hljs-literal">nullptr</span>;<br><br>  <span class="hljs-built_in">EXPECT_EQ</span>(SBOX_ALL_OK, result);<br>  <span class="hljs-keyword">if</span> (result == SBOX_ALL_OK)<br>    target.<span class="hljs-built_in">Set</span>(temp_process_info);<br><br>  <span class="hljs-built_in">EXPECT_EQ</span>(<span class="hljs-number">1u</span>, ::<span class="hljs-built_in">ResumeThread</span>(target.<span class="hljs-built_in">thread_handle</span>()));<br><br>  <span class="hljs-built_in">EXPECT_EQ</span>(<span class="hljs-built_in">static_cast</span>&lt;DWORD&gt;(WAIT_TIMEOUT),<br>            ::<span class="hljs-built_in">WaitForSingleObject</span>(target.<span class="hljs-built_in">process_handle</span>(), <span class="hljs-number">2000</span>));<br><br>  <span class="hljs-built_in">EXPECT_NE</span>(::<span class="hljs-built_in">GetThreadDesktop</span>(target.<span class="hljs-built_in">thread_id</span>()),<br>            ::<span class="hljs-built_in">GetThreadDesktop</span>(::<span class="hljs-built_in">GetCurrentThreadId</span>()));<br><br>  HDESK desk = ::<span class="hljs-built_in">OpenDesktop</span>(desktop_name.<span class="hljs-built_in">c_str</span>(), <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>, DESKTOP_ENUMERATE);<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(desk);<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(::<span class="hljs-built_in">CloseDesktop</span>(desk));<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(::<span class="hljs-built_in">TerminateProcess</span>(target.<span class="hljs-built_in">process_handle</span>(), <span class="hljs-number">0</span>));<br><br>  ::<span class="hljs-built_in">WaitForSingleObject</span>(target.<span class="hljs-built_in">process_handle</span>(), INFINITE);<br><br>  <span class="hljs-comment">// Close the desktop handle.</span><br>  temp_policy = broker-&gt;<span class="hljs-built_in">CreatePolicy</span>();<br>  temp_policy-&gt;<span class="hljs-built_in">DestroyAlternateDesktop</span>();<br>  temp_policy = <span class="hljs-literal">nullptr</span>;<br><br>  <span class="hljs-comment">// Make sure the desktop does not exist anymore.</span><br>  desk = ::<span class="hljs-built_in">OpenDesktop</span>(desktop_name.<span class="hljs-built_in">c_str</span>(), <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>, DESKTOP_ENUMERATE);<br>  <span class="hljs-built_in">EXPECT_FALSE</span>(desk);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>暂不用看懂所有逻辑，理解整个运营的方式即可。这个TEST是检查alternative
desktop的，在设置后，理应和用户当前的desktop不一致。</p>
<blockquote>
<p>Alternative
desktop也是policy三大组件之一，它比较简单，目的在于防止对用户desktop的其他window的攻击，比如全局hook，监听等等。本质上就是把target窗口隔离。</p>
</blockquote>
<p>关于Token的事儿暂时就说到这儿，chrome仅仅只是根据设计（TokenLevel和IntegrityLevel）按等级权限使用了Windows的restricted
token。其中还用到了impersonate机制。</p>
<p>想要理解这些设置是如何生效的，对象的过审检查是如何进行的，首先得了解Windows的对象安全机制。文首已经给出了非常nice的参考书，尽管《Windows
Internals》因为作者职位的敏感，文中的描述都是高度抽象且没有代码参照，但凭借google在手，还是能够有一定收获的。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" class="category-chain-item">源码剖析</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/chromium/" class="print-no-link">#chromium</a>
      
        <a href="/tags/chromium-sandbox/" class="print-no-link">#chromium-sandbox</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Chromium-sandbox-Tokens-analysis</div>
      <div>https://r00tk1ts.github.io/2018/05/19/chromium-sandbox-Tokens-analysis/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>r00tk1t</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2018年5月19日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2018/05/19/chromium-sandbox-AlternateDesktop-analysis/" title="Chromium-sandbox-AlternateDesktop-analysis">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Chromium-sandbox-AlternateDesktop-analysis</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2018/05/14/chromium-sandbox-Job-analysis/" title="Chromium-sandbox-Job-analysis">
                        <span class="hidden-mobile">Chromium-sandbox-Job-analysis</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/diy/yinghua.js"></script>
<script src="/js/diy/love.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
