

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="r00tk1t">
  <meta name="keywords" content="">
  
    <meta name="description" content="本篇是sandbox源码剖析的第十二篇，主要分析了windows平台下，Chromium sandbox中子系统三大组件构成中的第三大组件——low-level policy的基础设施PolicyEngine。阅读本篇前，请先阅读前四篇。 想要流程的阅读本系列你需要以下几个条件： 1. 较高水平的C++编码能力（至少通读C++ Primer 5th，刷过课后题，有一定编码量）。 2. 熟悉Wind">
<meta property="og:type" content="article">
<meta property="og:title" content="Chromium-sandbox-PolicyEngine-analysis">
<meta property="og:url" content="https://r00tk1ts.github.io/2018/05/26/chromium-sandbox-PolicyEngine-analysis/index.html">
<meta property="og:site_name" content="玉涵的技能书">
<meta property="og:description" content="本篇是sandbox源码剖析的第十二篇，主要分析了windows平台下，Chromium sandbox中子系统三大组件构成中的第三大组件——low-level policy的基础设施PolicyEngine。阅读本篇前，请先阅读前四篇。 想要流程的阅读本系列你需要以下几个条件： 1. 较高水平的C++编码能力（至少通读C++ Primer 5th，刷过课后题，有一定编码量）。 2. 熟悉Wind">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-05-26T03:48:11.000Z">
<meta property="article:modified_time" content="2024-04-22T03:34:00.166Z">
<meta property="article:author" content="r00tk1t">
<meta property="article:tag" content="chromium">
<meta property="article:tag" content="chromium-sandbox">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Chromium-sandbox-PolicyEngine-analysis - 玉涵的技能书</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"r00tk1ts.github.io","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":80,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>玉涵的技能书</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/doc/">
                <i class="iconfont icon-books"></i>
                <span>藏经阁</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Chromium-sandbox-PolicyEngine-analysis"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2018-05-26 11:48" pubdate>
          2018年5月26日 中午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          54k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          453 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Chromium-sandbox-PolicyEngine-analysis</h1>
            
            
              <div class="markdown-body">
                
                <p>本篇是sandbox源码剖析的第十二篇，主要分析了windows平台下，Chromium
sandbox中子系统三大组件构成中的第三大组件——low-level
policy的基础设施PolicyEngine。阅读本篇前，请先阅读前四篇。</p>
<p>想要流程的阅读本系列你需要以下几个条件： 1.
较高水平的C++编码能力（至少通读C++ Primer
5th，刷过课后题，有一定编码量）。 2. 熟悉Windows
API编程，尤其是安全相关的内容。 3.
对二进制安全有一定了解，熟悉各类型安全漏洞成因、漏洞缓解措施及bypass手法。</p>
<span id="more"></span>
<h1
id="chromium-sandbox-policyengine-analysis">chromium-sandbox-PolicyEngine-analysis</h1>
<p>子系统共有三大组件：负责IPC请求分发的Dispatcher、对敏感函数拦截的Interception+Resolver、low-level-policy。此前已经分析过前两个组件，本篇开始分析low-level-policy，来看看low-level-policy究竟是什么。</p>
<p>定位源代码时，发现low-level-policy这套机制是建立在policy_engine之上的，所以分析low-level-policy之前，首先要搞懂policy_engine的方方面面。</p>
<h2 id="opcodes">opcodes</h2>
<p>policy_engine由两部分组成：opcodes和processor。先研究一下opcodes。</p>
<p>何为opcodes？实际上头文件给出的功能描述已经相当详尽了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// The low-level policy is implemented using the concept of policy &#x27;opcodes&#x27;.</span><br><span class="hljs-comment">// An opcode is a structure that contains enough information to perform one</span><br><span class="hljs-comment">// comparison against one single input parameter. For example, an opcode can</span><br><span class="hljs-comment">// encode just one of the following comparison:</span><br><span class="hljs-comment">// low-level policy是基于opcodes概念实现的</span><br><span class="hljs-comment">// opcode是一种包含了充分信息的结构用来与单一输入参数进行比较</span><br><span class="hljs-comment">// 下面给出了几个比较的范例：</span><br><span class="hljs-comment">// </span><br><span class="hljs-comment">// - Is input parameter 3 not equal to nullptr?</span><br><span class="hljs-comment">// - Does input parameter 2 start with L&quot;c:\\&quot;?</span><br><span class="hljs-comment">// - Is input parameter 5, bit 3 is equal 1?</span><br><span class="hljs-comment">// 看起来opcode可以裁决某个输入参数的值是否是理想值</span><br><span class="hljs-comment">// </span><br><span class="hljs-comment">// Each opcode is in fact equivalent to a function invocation where all</span><br><span class="hljs-comment">// the parameters are known by the opcode except one. So say you have a</span><br><span class="hljs-comment">// function of this form:</span><br><span class="hljs-comment">//      bool fn(a, b, c, d)  with 4 arguments</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Then an opcode is:</span><br><span class="hljs-comment">//      op(fn, b, c, d)</span><br><span class="hljs-comment">// Which stores the function to call and its 3 last arguments</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Then and opcode evaluation is:</span><br><span class="hljs-comment">//      op.eval(a)  ------------------------&gt; fn(a,b,c,d)</span><br><span class="hljs-comment">//                        internally calls</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// The idea is that complex policy rules can be split into streams of</span><br><span class="hljs-comment">// opcodes which are evaluated in sequence. The evaluation is done in</span><br><span class="hljs-comment">// groups of opcodes that have N comparison opcodes plus 1 action opcode:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// [comparison 1][comparison 2]...[comparison N][action][comparison 1]...</span><br><span class="hljs-comment">//    ----- evaluation order-----------&gt;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Each opcode group encodes one high-level policy rule. The rule applies</span><br><span class="hljs-comment">// only if all the conditions on the group evaluate to true. The action</span><br><span class="hljs-comment">// opcode contains the policy outcome for that particular rule.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Note that this header contains the main building blocks of low-level policy</span><br><span class="hljs-comment">// but not the low level policy class.</span><br></code></pre></td></tr></table></figure>
<p>尽管描述详尽，但仅凭现有的信息和猜想，还无法理解如此复杂的设计，我们继续往下看。</p>
<p>头文件中定义了几个关键的结构体和常量，以及两个非常重要的类：<code>OpcodePolicy</code>和<code>OpcodeFactory</code>。</p>
<h3 id="structure-const">structure &amp; const</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// These are the possible policy outcomes. Note that some of them might</span><br><span class="hljs-comment">// not apply and can be removed. Also note that The following values only</span><br><span class="hljs-comment">// specify what to do, not how to do it and it is acceptable given specific</span><br><span class="hljs-comment">// cases to ignore the policy outcome.</span><br><span class="hljs-comment">// 仅仅表示应该怎样处理，但并未规范如何处理。对于特殊情景，可以不采纳输出的结果。</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">EvalResult</span> &#123;<br>  <span class="hljs-comment">// Comparison opcode values:</span><br>  <span class="hljs-comment">// 参考头注释的说明，group是以多个comparison+一个action组成</span><br>  <span class="hljs-comment">// 这三个result是comparison的结果</span><br>  EVAL_TRUE,   <span class="hljs-comment">// Opcode condition evaluated true.</span><br>  EVAL_FALSE,  <span class="hljs-comment">// Opcode condition evaluated false.</span><br>  EVAL_ERROR,  <span class="hljs-comment">// Opcode condition generated an error while evaluating.</span><br>  <span class="hljs-comment">// Action opcode values:</span><br>  <span class="hljs-comment">// 这些都是action的值，表示裁决的行动</span><br>  ASK_BROKER,   <span class="hljs-comment">// The target must generate an IPC to the broker. On the broker</span><br>                <span class="hljs-comment">// side, this means grant access to the resource.</span><br>  DENY_ACCESS,  <span class="hljs-comment">// No access granted to the resource.</span><br>  GIVE_READONLY,   <span class="hljs-comment">// Give readonly access to the resource.</span><br>  GIVE_ALLACCESS,  <span class="hljs-comment">// Give full access to the resource.</span><br>  GIVE_CACHED,     <span class="hljs-comment">// IPC is not required. Target can return a cached handle.</span><br>  GIVE_FIRST,      <span class="hljs-comment">// TODO(cpu)</span><br>  SIGNAL_ALARM,    <span class="hljs-comment">// Unusual activity. Generate an alarm.</span><br>  FAKE_SUCCESS,    <span class="hljs-comment">// Do not call original function. Just return &#x27;success&#x27;.</span><br>  FAKE_ACCESS_DENIED,  <span class="hljs-comment">// Do not call original function. Just return &#x27;denied&#x27;</span><br>                       <span class="hljs-comment">// and do not do IPC.</span><br>  TERMINATE_PROCESS,   <span class="hljs-comment">// Destroy target process. Do IPC as well.</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<p>根据<code>EvalResult</code>的枚举值，能够猜想到comparison是一次比较，但comparison本身是怎样的结构，还不清楚。而action则是最终的审判。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// The following are the implemented opcodes.</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">OpcodeID</span> &#123;<br>  <span class="hljs-comment">// 前6个都是具体的比较方式</span><br>  OP_ALWAYS_FALSE,        <span class="hljs-comment">// Evaluates to false (EVAL_FALSE).</span><br>  OP_ALWAYS_TRUE,         <span class="hljs-comment">// Evaluates to true (EVAL_TRUE).</span><br>  OP_NUMBER_MATCH,        <span class="hljs-comment">// Match a 32-bit integer as n == a.</span><br>  OP_NUMBER_MATCH_RANGE,  <span class="hljs-comment">// Match a 32-bit integer as a &lt;= n &lt;= b.</span><br>  OP_NUMBER_AND_MATCH,    <span class="hljs-comment">// Match using bitwise AND; as in: n &amp; a != 0.</span><br>  OP_WSTRING_MATCH,       <span class="hljs-comment">// Match a string for equality.</span><br>  <span class="hljs-comment">// 后1个应该是标志action所用</span><br>  OP_ACTION               <span class="hljs-comment">// Evaluates to an action opcode.</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<p>comparison看起来会是一种具体的比较类别，各不相同，要么返回FALSE/TRUE，要么比较<code>int</code>、<code>string</code>值等等。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 下面的几个应该都是标志位，从某个角度来影响裁决结果或过程</span><br><span class="hljs-comment">// Options that apply to every opcode. They are specified when creating</span><br><span class="hljs-comment">// each opcode using OpcodeFactory::MakeOpXXXXX() family of functions</span><br><span class="hljs-comment">// Do nothing special.</span><br><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> kPolNone = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// Convert EVAL_TRUE into EVAL_FALSE and vice-versa. This allows to express</span><br><span class="hljs-comment">// negated conditions such as if ( a &amp;&amp; !b).</span><br><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> kPolNegateEval = <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">// Zero the MatchContext context structure. This happens after the opcode</span><br><span class="hljs-comment">// is evaluated.</span><br><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> kPolClearContext = <span class="hljs-number">2</span>;<br><br><span class="hljs-comment">// Use OR when evaluating this set of opcodes. The policy evaluator by default</span><br><span class="hljs-comment">// uses AND when evaluating. Very helpful when</span><br><span class="hljs-comment">// used with kPolNegateEval. For example if you have a condition best expressed</span><br><span class="hljs-comment">// as if(! (a &amp;&amp; b &amp;&amp; c)), the use of this flags allows it to be expressed as</span><br><span class="hljs-comment">// if ((!a) || (!b) || (!c)).</span><br><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> kPolUseOREval = <span class="hljs-number">4</span>;<br></code></pre></td></tr></table></figure>
<p>一个专门为连续字符串匹配定制的专属结构体：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Keeps the evaluation state between opcode evaluations. This is used</span><br><span class="hljs-comment">// for string matching where the next opcode needs to continue matching</span><br><span class="hljs-comment">// from the last character position from the current opcode. The match</span><br><span class="hljs-comment">// context is preserved across opcode evaluation unless an opcode specifies</span><br><span class="hljs-comment">// as an option kPolClearContext.</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MatchContext</span> &#123;<br>  <span class="hljs-type">size_t</span> position;<br>  <span class="hljs-type">uint32_t</span> options;<br><br>  <span class="hljs-built_in">MatchContext</span>() &#123; <span class="hljs-built_in">Clear</span>(); &#125;<br><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Clear</span><span class="hljs-params">()</span> </span>&#123;<br>    position = <span class="hljs-number">0</span>;<br>    options = <span class="hljs-number">0</span>;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>看起来<code>kPolClearContext</code>这个标记和连续匹配字符串有关。</p>
<h3 id="policyopcode"><code>PolicyOpcode</code></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Models a policy opcode; that is a condition evaluation were all the</span><br><span class="hljs-comment">// arguments but one are stored in objects of this class. Use OpcodeFactory</span><br><span class="hljs-comment">// to create objects of this type.</span><br><span class="hljs-comment">// policy opcode是基于此运营的，除了第一个参数都存储在此对象中进行裁决。</span><br><span class="hljs-comment">// OpcodeFactory工厂类负责创建该类型对象。</span><br><span class="hljs-comment">// </span><br><span class="hljs-comment">// This class is just an implementation artifact and not exposed to the</span><br><span class="hljs-comment">// API clients or visible in the intercepted service. Internally, an</span><br><span class="hljs-comment">// opcode is just:</span><br><span class="hljs-comment">//  - An integer that identifies the actual opcode.</span><br><span class="hljs-comment">//  - An index to indicate which one is the input argument</span><br><span class="hljs-comment">//  - An array of arguments.</span><br><span class="hljs-comment">// 该类仅仅是抽象体，不对外暴露（client/service）。</span><br><span class="hljs-comment">// 操作码的三个组成</span><br><span class="hljs-comment">// - opcode的id</span><br><span class="hljs-comment">// - 一个index索引表示哪个是输入参数</span><br><span class="hljs-comment">// - 一个参数数组</span><br><span class="hljs-comment">// </span><br><span class="hljs-comment">// While an OO hierarchy of objects would have been a natural choice, the fact</span><br><span class="hljs-comment">// that 1) this code can execute before the CRT is loaded, presents serious</span><br><span class="hljs-comment">// problems in terms of guarantees about the actual state of the vtables and</span><br><span class="hljs-comment">// 2) because the opcode objects are generated in the broker process, we need to</span><br><span class="hljs-comment">// use plain objects. To preserve some minimal type safety templates are used</span><br><span class="hljs-comment">// when possible.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PolicyOpcode</span> &#123;<br>  <span class="hljs-keyword">friend</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OpcodeFactory</span>;<br><br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">// Evaluates the opcode. For a typical comparison opcode the return value</span><br>  <span class="hljs-comment">// is EVAL_TRUE or EVAL_FALSE. If there was an error in the evaluation the</span><br>  <span class="hljs-comment">// the return is EVAL_ERROR. If the opcode is an action opcode then the</span><br>  <span class="hljs-comment">// return can take other values such as ASK_BROKER.</span><br>  <span class="hljs-comment">// 这个函数就是裁决的执行，根据opcode是comparison还是action，返回两类结果</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// parameters: An array of all input parameters. This argument is normally</span><br>  <span class="hljs-comment">// created by the macros POLPARAMS_BEGIN() POLPARAMS_END.</span><br>  <span class="hljs-comment">// count: The number of parameters passed as first argument.</span><br>  <span class="hljs-comment">// match: The match context that is persisted across the opcode evaluation</span><br>  <span class="hljs-comment">// sequence.</span><br>  <span class="hljs-comment">// 可以看到参数数组是个ParameterSet结构，这个结构在policy_engine_params.h中定义</span><br>  <span class="hljs-comment">// 一会儿展开看看。count表示参数个数，match是一个辅助结构，用于支持连续字符串匹配用的</span><br>  <span class="hljs-function">EvalResult <span class="hljs-title">Evaluate</span><span class="hljs-params">(<span class="hljs-type">const</span> ParameterSet* parameters,</span></span><br><span class="hljs-params"><span class="hljs-function">                      <span class="hljs-type">size_t</span> count,</span></span><br><span class="hljs-params"><span class="hljs-function">                      MatchContext* match)</span></span>;<br>	<br>  <span class="hljs-comment">// 一目了然的三个set/get方法</span><br>  <span class="hljs-comment">// Retrieves a stored argument by index. Valid index values are</span><br>  <span class="hljs-comment">// from 0 to &lt; kArgumentCount.</span><br>  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GetArgument</span><span class="hljs-params">(<span class="hljs-type">size_t</span> index, T* argument)</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-built_in">static_assert</span>(<span class="hljs-built_in">sizeof</span>(T) &lt;= <span class="hljs-built_in">sizeof</span>(arguments_[<span class="hljs-number">0</span>]), <span class="hljs-string">&quot;invalid size&quot;</span>);<br>    *argument = *<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> T*&gt;(&amp;arguments_[index].mem);<br>  &#125;<br><br>  <span class="hljs-comment">// Sets a stored argument by index. Valid index values are</span><br>  <span class="hljs-comment">// from 0 to &lt; kArgumentCount.</span><br>  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetArgument</span><span class="hljs-params">(<span class="hljs-type">size_t</span> index, <span class="hljs-type">const</span> T&amp; argument)</span> </span>&#123;<br>    <span class="hljs-built_in">static_assert</span>(<span class="hljs-built_in">sizeof</span>(T) &lt;= <span class="hljs-built_in">sizeof</span>(arguments_[<span class="hljs-number">0</span>]), <span class="hljs-string">&quot;invalid size&quot;</span>);<br>    *<span class="hljs-built_in">reinterpret_cast</span>&lt;T*&gt;(&amp;arguments_[index].mem) = argument;<br>  &#125;<br><br>  <span class="hljs-comment">// Retrieves the actual address of an string argument. When using</span><br>  <span class="hljs-comment">// GetArgument() to retrieve an index that contains a string, the returned</span><br>  <span class="hljs-comment">// value is just an offset to the actual string.</span><br>  <span class="hljs-comment">// index: the stored string index. Valid values are from 0</span><br>  <span class="hljs-comment">// to &lt; kArgumentCount.</span><br>  <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* <span class="hljs-title">GetRelativeString</span><span class="hljs-params">(<span class="hljs-type">size_t</span> index)</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-type">ptrdiff_t</span> str_delta = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">GetArgument</span>(index, &amp;str_delta);<br>    <span class="hljs-comment">// 字符串的GetArgument返回的是一个offset</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* delta = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">char</span>*&gt;(<span class="hljs-keyword">this</span>) + str_delta;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>*&gt;(delta);<br>  &#125;<br><br>  <span class="hljs-comment">// OpcodeID相关</span><br>  <span class="hljs-comment">// Returns true if this opcode is an action opcode without actually</span><br>  <span class="hljs-comment">// evaluating it. Used to do a quick scan forward to the next opcode group.</span><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">IsAction</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> (OP_ACTION == opcode_id_); &#125;<br><br>  <span class="hljs-comment">// Returns the opcode type.</span><br>  <span class="hljs-function">OpcodeID <span class="hljs-title">GetID</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> opcode_id_; &#125;<br><br>  <span class="hljs-comment">// Returns the stored options such as kPolNegateEval and others.</span><br>  <span class="hljs-function"><span class="hljs-type">uint32_t</span> <span class="hljs-title">GetOptions</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> options_; &#125;<br><br>  <span class="hljs-comment">// Sets the stored options such as kPolNegateEval.</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetOptions</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> options)</span> </span>&#123;<br>    options_ = base::<span class="hljs-built_in">checked_cast</span>&lt;<span class="hljs-type">uint16_t</span>&gt;(options);<br>  &#125;<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> kArgumentCount = <span class="hljs-number">4</span>;  <span class="hljs-comment">// The number of supported argument.</span><br><br>  <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OpcodeArgument</span> &#123;<br>    UINT_PTR mem;<br>  &#125;;<br><br>  <span class="hljs-comment">// Better define placement new in the class instead of relying on the</span><br>  <span class="hljs-comment">// global definition which seems to be fubared.</span><br>  <span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-keyword">operator</span> <span class="hljs-title">new</span><span class="hljs-params">(<span class="hljs-type">size_t</span>, <span class="hljs-type">void</span>* location)</span> </span>&#123; <span class="hljs-keyword">return</span> location; &#125;<br><br>  <span class="hljs-comment">// Helper function to evaluate the opcode. The parameters have the same</span><br>  <span class="hljs-comment">// meaning that in Evaluate().</span><br>  <span class="hljs-comment">// 这个应该是真正的裁决处理helper函数</span><br>  <span class="hljs-function">EvalResult <span class="hljs-title">EvaluateHelper</span><span class="hljs-params">(<span class="hljs-type">const</span> ParameterSet* parameters,</span></span><br><span class="hljs-params"><span class="hljs-function">                            MatchContext* match)</span></span>;<br>  OpcodeID opcode_id_;<br>  <span class="hljs-type">int16_t</span> parameter_;	<br>  <span class="hljs-comment">// TODO(cpu): Making |options_| a uint32_t would avoid casting, but causes</span><br>  <span class="hljs-comment">// test failures.  Somewhere code is relying on the size of this struct.</span><br>  <span class="hljs-comment">// http://crbug.com/420296</span><br>  <span class="hljs-type">uint16_t</span> options_;<br>  OpcodeArgument arguments_[PolicyOpcode::kArgumentCount]; <span class="hljs-comment">// 其实就是4个指针，供参数get/set用</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<p>除了<code>Evaluate</code>以外，其他基本都在类头定义了。暂且不管<code>ParamterSet</code>参数，看看处理的逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//////////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Opcode evaluation dispatchers.</span><br><br><span class="hljs-comment">// This function is the one and only entry for evaluating any opcode. It is</span><br><span class="hljs-comment">// in charge of applying any relevant opcode options and calling EvaluateInner</span><br><span class="hljs-comment">// were the actual dispatch-by-id is made. It would seem at first glance that</span><br><span class="hljs-comment">// the dispatch should be done by virtual function (vtable) calls but you have</span><br><span class="hljs-comment">// to remember that the opcodes are made in the broker process and copied as</span><br><span class="hljs-comment">// raw memory to the target process.</span><br><br><span class="hljs-function">EvalResult <span class="hljs-title">PolicyOpcode::Evaluate</span><span class="hljs-params">(<span class="hljs-type">const</span> ParameterSet* call_params,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-type">size_t</span> param_count,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  MatchContext* match)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (!call_params)<br>    <span class="hljs-keyword">return</span> EVAL_ERROR;<br>  <span class="hljs-type">const</span> ParameterSet* selected_param = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-keyword">if</span> (parameter_ &gt;= <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">size_t</span>&gt;(parameter_) &gt;= param_count) &#123;<br>      <span class="hljs-keyword">return</span> EVAL_ERROR;<br>    &#125;<br>    <span class="hljs-comment">// 看来PolicyOpcode的parameter_成员是个索引，call_params是个ParameterSet数组</span><br>    <span class="hljs-comment">// selected_param借助parameter_的值找到本次想要处理的ParameterSet</span><br>    selected_param = &amp;call_params[parameter_];<br>  &#125;<br>  <span class="hljs-comment">// 这里干大事</span><br>  EvalResult result = <span class="hljs-built_in">EvaluateHelper</span>(selected_param, match);<br><br>  <span class="hljs-comment">// Apply the general options regardless of the particular type of opcode.</span><br>  <span class="hljs-comment">// 如果本PolicyOpcode的标记为kPolNone，直接返回结果，什么也不做</span><br>  <span class="hljs-keyword">if</span> (kPolNone == options_) &#123;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;<br><br>  <span class="hljs-comment">// 如果本PolicyOpcode的标记了kPolNegateEval位，那么就要对结果取反（ERROR不管）</span><br>  <span class="hljs-keyword">if</span> (options_ &amp; kPolNegateEval) &#123;<br>    <span class="hljs-keyword">if</span> (EVAL_TRUE == result) &#123;<br>      result = EVAL_FALSE;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (EVAL_FALSE == result) &#123;<br>      result = EVAL_TRUE;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (EVAL_ERROR != result) &#123;<br>      result = EVAL_ERROR;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (match) &#123;<br>    <span class="hljs-comment">// 如果标记了kPolClearContext位，那么要对辅助结构MatchContext进行清理工作</span><br>    <span class="hljs-keyword">if</span> (options_ &amp; kPolClearContext)<br>      match-&gt;<span class="hljs-built_in">Clear</span>();<br>    <span class="hljs-comment">// 如果标记了kPolUseOREval，那么就对辅助结构MatchContext打上标记</span><br>    <span class="hljs-keyword">if</span> (options_ &amp; kPolUseOREval)<br>      match-&gt;options = kPolUseOREval;	<span class="hljs-comment">//默认是用AND来裁决，该标记表示用OR</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OPCODE_EVAL(op, x, y, z) \</span><br><span class="hljs-meta">  case op:                       \</span><br><span class="hljs-meta">    return OpcodeEval<span class="hljs-string">&lt;op&gt;</span>(x, y, z)</span><br><br><span class="hljs-function">EvalResult <span class="hljs-title">PolicyOpcode::EvaluateHelper</span><span class="hljs-params">(<span class="hljs-type">const</span> ParameterSet* parameters,</span></span><br><span class="hljs-params"><span class="hljs-function">                                        MatchContext* match)</span> </span>&#123;<br>  <span class="hljs-keyword">switch</span> (opcode_id_) &#123;<br>    <span class="hljs-built_in">OPCODE_EVAL</span>(OP_ALWAYS_FALSE, <span class="hljs-keyword">this</span>, parameters, match);<br>    <span class="hljs-built_in">OPCODE_EVAL</span>(OP_ALWAYS_TRUE, <span class="hljs-keyword">this</span>, parameters, match);<br>    <span class="hljs-built_in">OPCODE_EVAL</span>(OP_NUMBER_MATCH, <span class="hljs-keyword">this</span>, parameters, match);<br>    <span class="hljs-built_in">OPCODE_EVAL</span>(OP_NUMBER_MATCH_RANGE, <span class="hljs-keyword">this</span>, parameters, match);<br>    <span class="hljs-built_in">OPCODE_EVAL</span>(OP_NUMBER_AND_MATCH, <span class="hljs-keyword">this</span>, parameters, match);<br>    <span class="hljs-built_in">OPCODE_EVAL</span>(OP_WSTRING_MATCH, <span class="hljs-keyword">this</span>, parameters, match);<br>    <span class="hljs-built_in">OPCODE_EVAL</span>(OP_ACTION, <span class="hljs-keyword">this</span>, parameters, match);<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-keyword">return</span> EVAL_ERROR;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>根据<code>opcode_id_</code>分类，helper函数内部做了类别分发。这里<code>OpcodeEval</code>是个函数模板：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-type">int</span>&gt;<br><span class="hljs-function">EvalResult <span class="hljs-title">OpcodeEval</span><span class="hljs-params">(PolicyOpcode* opcode,</span></span><br><span class="hljs-params"><span class="hljs-function">                      <span class="hljs-type">const</span> ParameterSet* pp,</span></span><br><span class="hljs-params"><span class="hljs-function">                      MatchContext* match)</span></span>;<br></code></pre></td></tr></table></figure>
<p>对应每种opcode_id_，都有一个具体的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;&gt;<br>EvalResult <span class="hljs-built_in">OpcodeEval</span>&lt;OP_ALWAYS_FALSE&gt;(PolicyOpcode* opcode,<br>                                       <span class="hljs-type">const</span> ParameterSet* param,<br>                                       MatchContext* context) &#123;<br>  <span class="hljs-keyword">return</span> EVAL_FALSE;<br>&#125;<br><br><span class="hljs-keyword">template</span> &lt;&gt;<br>EvalResult <span class="hljs-built_in">OpcodeEval</span>&lt;OP_ALWAYS_TRUE&gt;(PolicyOpcode* opcode,<br>                                      <span class="hljs-type">const</span> ParameterSet* param,<br>                                      MatchContext* context) &#123;<br>  <span class="hljs-keyword">return</span> EVAL_TRUE;<br>&#125;<br><span class="hljs-comment">// 前两个没啥好说的，根本不用比，对于id为OP_ALWAYS_FALSE或OP_ALWAYS_TRUE的PolicyOpcode</span><br><span class="hljs-comment">// 直接返回值结果就行了</span><br><span class="hljs-comment">// opcode id为action的比较特别，它的值在argumetnts_[0].mem保存</span><br><span class="hljs-keyword">template</span> &lt;&gt;<br>EvalResult <span class="hljs-built_in">OpcodeEval</span>&lt;OP_ACTION&gt;(PolicyOpcode* opcode,<br>                                 <span class="hljs-type">const</span> ParameterSet* param,<br>                                 MatchContext* context) &#123;<br>  <span class="hljs-type">int</span> action = <span class="hljs-number">0</span>;<br>  opcode-&gt;<span class="hljs-built_in">GetArgument</span>(<span class="hljs-number">0</span>, &amp;action);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">static_cast</span>&lt;EvalResult&gt;(action);<br>&#125;<br><br><span class="hljs-comment">// uint32比较有两种情况，param可以是一个uint32值，也可以是一个指针</span><br><span class="hljs-comment">// 无论哪一种，都是把输入的值和该PolicyOpcode中的arguments_[0].mem进行比较</span><br><span class="hljs-keyword">template</span> &lt;&gt;<br>EvalResult <span class="hljs-built_in">OpcodeEval</span>&lt;OP_NUMBER_MATCH&gt;(PolicyOpcode* opcode,<br>                                       <span class="hljs-type">const</span> ParameterSet* param,<br>                                       MatchContext* context) &#123;<br>  <span class="hljs-type">uint32_t</span> value_uint32 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (param-&gt;<span class="hljs-built_in">Get</span>(&amp;value_uint32)) &#123;<br>    <span class="hljs-type">uint32_t</span> match_uint32 = <span class="hljs-number">0</span>;<br>    opcode-&gt;<span class="hljs-built_in">GetArgument</span>(<span class="hljs-number">0</span>, &amp;match_uint32);<br>    <span class="hljs-keyword">return</span> (match_uint32 != value_uint32) ? EVAL_FALSE : EVAL_TRUE;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">void</span>* value_ptr = <span class="hljs-literal">nullptr</span>;<br>    <span class="hljs-keyword">if</span> (param-&gt;<span class="hljs-built_in">Get</span>(&amp;value_ptr)) &#123;<br>      <span class="hljs-type">const</span> <span class="hljs-type">void</span>* match_ptr = <span class="hljs-literal">nullptr</span>;<br>      opcode-&gt;<span class="hljs-built_in">GetArgument</span>(<span class="hljs-number">0</span>, &amp;match_ptr);<br>      <span class="hljs-keyword">return</span> (match_ptr != value_ptr) ? EVAL_FALSE : EVAL_TRUE;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> EVAL_ERROR;<br>&#125;<br><br><span class="hljs-comment">// 和uint32类似，但此时该PolicyOpcode的arguments_中0成员是下限，1成员是上限值</span><br><span class="hljs-comment">// 此时的param中承载的是值，而不是指针</span><br><span class="hljs-keyword">template</span> &lt;&gt;<br>EvalResult <span class="hljs-built_in">OpcodeEval</span>&lt;OP_NUMBER_MATCH_RANGE&gt;(PolicyOpcode* opcode,<br>                                             <span class="hljs-type">const</span> ParameterSet* param,<br>                                             MatchContext* context) &#123;<br>  <span class="hljs-type">uint32_t</span> value = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (!param-&gt;<span class="hljs-built_in">Get</span>(&amp;value))<br>    <span class="hljs-keyword">return</span> EVAL_ERROR;<br><br>  <span class="hljs-type">uint32_t</span> lower_bound = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">uint32_t</span> upper_bound = <span class="hljs-number">0</span>;<br>  opcode-&gt;<span class="hljs-built_in">GetArgument</span>(<span class="hljs-number">0</span>, &amp;lower_bound);<br>  opcode-&gt;<span class="hljs-built_in">GetArgument</span>(<span class="hljs-number">1</span>, &amp;upper_bound);<br>  <span class="hljs-keyword">return</span> ((lower_bound &lt;= value) &amp;&amp; (upper_bound &gt;= value)) ? EVAL_TRUE<br>                                                            : EVAL_FALSE;<br>&#125;<br><br><span class="hljs-comment">// 这个是按位与的结果，param中的也是值</span><br><span class="hljs-keyword">template</span> &lt;&gt;<br>EvalResult <span class="hljs-built_in">OpcodeEval</span>&lt;OP_NUMBER_AND_MATCH&gt;(PolicyOpcode* opcode,<br>                                           <span class="hljs-type">const</span> ParameterSet* param,<br>                                           MatchContext* context) &#123;<br>  <span class="hljs-type">uint32_t</span> value = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (!param-&gt;<span class="hljs-built_in">Get</span>(&amp;value))<br>    <span class="hljs-keyword">return</span> EVAL_ERROR;<br><br>  <span class="hljs-type">uint32_t</span> number = <span class="hljs-number">0</span>;<br>  opcode-&gt;<span class="hljs-built_in">GetArgument</span>(<span class="hljs-number">0</span>, &amp;number);<br>  <span class="hljs-keyword">return</span> (number &amp; value) ? EVAL_TRUE : EVAL_FALSE;<br>&#125;<br><br><span class="hljs-comment">// 这个复杂些</span><br><span class="hljs-keyword">template</span> &lt;&gt;<br>EvalResult <span class="hljs-built_in">OpcodeEval</span>&lt;OP_WSTRING_MATCH&gt;(PolicyOpcode* opcode,<br>                                        <span class="hljs-type">const</span> ParameterSet* param,<br>                                        MatchContext* context) &#123;<br>  <span class="hljs-comment">// 对于字符串的比较，需要用到传入的辅助结构MatchContext</span><br>  <span class="hljs-keyword">if</span> (!context) &#123;<br>    <span class="hljs-keyword">return</span> EVAL_ERROR;<br>  &#125;<br>  <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* source_str = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-keyword">if</span> (!param-&gt;<span class="hljs-built_in">Get</span>(&amp;source_str))<br>    <span class="hljs-keyword">return</span> EVAL_ERROR;<br><br>  <span class="hljs-type">int</span> start_position = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">int</span> match_len = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> match_opts = <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// PolicyOpcode中的arguments_[1,2,3]成员分别是比较的长度、起始位置和比较时的选项</span><br>  opcode-&gt;<span class="hljs-built_in">GetArgument</span>(<span class="hljs-number">1</span>, &amp;match_len);<br>  opcode-&gt;<span class="hljs-built_in">GetArgument</span>(<span class="hljs-number">2</span>, &amp;start_position);<br>  opcode-&gt;<span class="hljs-built_in">GetArgument</span>(<span class="hljs-number">3</span>, &amp;match_opts);<br><br>  <span class="hljs-comment">// PolicyOpcode中的arguments_[0]是字符串的offset，通过GetRelativeString才能转成真实地址</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* match_str = opcode-&gt;<span class="hljs-built_in">GetRelativeString</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-comment">// Advance the source string to the last successfully evaluated position</span><br>  <span class="hljs-comment">// according to the match context.</span><br>  <span class="hljs-comment">// 如果是首次匹配字符串，context-&gt;position应该是0，如果是连续匹配source字符串，那就表示下一个串的位置</span><br>  source_str = &amp;source_str[context-&gt;position];<br>  <span class="hljs-comment">// 每个串都有终结符，计算出本次待比较的长度</span><br>  <span class="hljs-type">int</span> source_len = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(g_nt.<span class="hljs-built_in">wcslen</span>(source_str));<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == source_len) &#123;<br>    <span class="hljs-comment">// If we reached the end of the source string there is nothing we can</span><br>    <span class="hljs-comment">// match against.</span><br>    <span class="hljs-keyword">return</span> EVAL_FALSE;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (match_len &gt; source_len) &#123;<br>    <span class="hljs-comment">// There can&#x27;t be a positive match when the target string is bigger than</span><br>    <span class="hljs-comment">// the source string</span><br>    <span class="hljs-keyword">return</span> EVAL_FALSE;<br>  &#125;<br><br>  <span class="hljs-comment">// 看看match_opts里是否指明了大小写敏感</span><br>  BOOLEAN case_sensitive = (match_opts &amp; CASE_INSENSITIVE) ? TRUE : FALSE;<br><br>  <span class="hljs-comment">// We have three cases, depending on the value of start_pos:</span><br>  <span class="hljs-comment">// Case 1. We skip N characters and compare once.</span><br>  <span class="hljs-comment">// Case 2: We skip to the end and compare once.</span><br>  <span class="hljs-comment">// Case 3: We match the first substring (if we find any).</span><br>  <span class="hljs-comment">// 具体的子串匹配，基操勿6</span><br>  <span class="hljs-keyword">if</span> (start_position &gt;= <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">if</span> (kSeekToEnd == start_position) &#123;<br>      start_position = source_len - match_len;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (match_opts &amp; EXACT_LENGTH) &#123;<br>      <span class="hljs-comment">// A sub-case of case 3 is when the EXACT_LENGTH flag is on</span><br>      <span class="hljs-comment">// the match needs to be not just substring but full match.</span><br>      <span class="hljs-keyword">if</span> ((match_len + start_position) != source_len) &#123;<br>        <span class="hljs-keyword">return</span> EVAL_FALSE;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Advance start_pos characters. Warning! this does not consider</span><br>    <span class="hljs-comment">// utf16 encodings (surrogate pairs) or other Unicode &#x27;features&#x27;.</span><br>    source_str += start_position;<br><br>    <span class="hljs-comment">// Since we skipped, lets reevaluate just the lengths again.</span><br>    <span class="hljs-keyword">if</span> ((match_len + start_position) &gt; source_len) &#123;<br>      <span class="hljs-keyword">return</span> EVAL_FALSE;<br>    &#125;<br><br>    UNICODE_STRING match_ustr;<br>    UNICODE_STRING source_ustr;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">InitStringUnicode</span>(match_str, match_len, &amp;match_ustr) ||<br>        !<span class="hljs-built_in">InitStringUnicode</span>(source_str, match_len, &amp;source_ustr))<br>      <span class="hljs-keyword">return</span> EVAL_ERROR;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == g_nt.<span class="hljs-built_in">RtlCompareUnicodeString</span>(&amp;match_ustr, &amp;source_ustr,<br>                                          case_sensitive)) &#123;<br>      <span class="hljs-comment">// Match! update the match context.</span><br>      <span class="hljs-comment">// 更新context的索引</span><br>      context-&gt;position += start_position + match_len;<br>      <span class="hljs-keyword">return</span> EVAL_TRUE;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> EVAL_FALSE;<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (start_position &lt; <span class="hljs-number">0</span>) &#123;<br>    UNICODE_STRING match_ustr;<br>    UNICODE_STRING source_ustr;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">InitStringUnicode</span>(match_str, match_len, &amp;match_ustr) ||<br>        !<span class="hljs-built_in">InitStringUnicode</span>(source_str, match_len, &amp;source_ustr))<br>      <span class="hljs-keyword">return</span> EVAL_ERROR;<br><br>    <span class="hljs-keyword">do</span> &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == g_nt.<span class="hljs-built_in">RtlCompareUnicodeString</span>(&amp;match_ustr, &amp;source_ustr,<br>                                            case_sensitive)) &#123;<br>        <span class="hljs-comment">// Match! update the match context.</span><br>        <span class="hljs-comment">// 更新context的索引</span><br>        context-&gt;position += (source_ustr.Buffer - source_str) + match_len;<br>        <span class="hljs-keyword">return</span> EVAL_TRUE;<br>      &#125;<br>      ++source_ustr.Buffer;<br>      --source_len;<br>    &#125; <span class="hljs-keyword">while</span> (source_len &gt;= match_len);<br>  &#125;<br>  <span class="hljs-keyword">return</span> EVAL_FALSE;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>无论是哪种比较，本质上都是<code>param</code>和<code>opcode</code>中Argument的比较，而<code>opcode</code>是在<code>OpcodeFactory</code>中配置的。</p>
<p>另一方面也可以看出，<code>PolicyOpcode::Evaluate</code>一次仅仅是比较了参数集中的一个参数，它是一个下层的接口，整个参数集的裁决需要依赖使用者的正确性。</p>
<h3 id="opcodefactory"><code>OpcodeFactory</code></h3>
<p>研究一下它的工厂类。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Opcodes that do string comparisons take a parameter that is the starting</span><br><span class="hljs-comment">// position to perform the comparison so we can do substring matching. There</span><br><span class="hljs-comment">// are two special values:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Start from the current position and compare strings advancing forward until</span><br><span class="hljs-comment">// a match is found if any. Similar to CRT strstr().</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> kSeekForward = <span class="hljs-number">-1</span>;<br><span class="hljs-comment">// Perform a match with the end of the string. It only does a single comparison.</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> kSeekToEnd = <span class="hljs-number">0xfffff</span>;<br><br><span class="hljs-comment">// A PolicyBuffer is a variable size structure that contains all the opcodes</span><br><span class="hljs-comment">// that are to be created or evaluated in sequence.</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">PolicyBuffer</span> &#123;<br>  <span class="hljs-type">size_t</span> opcode_count;<br>  PolicyOpcode opcodes[<span class="hljs-number">1</span>];	<span class="hljs-comment">// 又见flexible</span><br>&#125;;<br><br><span class="hljs-comment">// Helper class to create any opcode sequence. This class is normally invoked</span><br><span class="hljs-comment">// only by the high level policy module or when you need to handcraft a special</span><br><span class="hljs-comment">// policy.</span><br><span class="hljs-comment">// The factory works by creating the opcodes using a chunk of memory given</span><br><span class="hljs-comment">// in the constructor. The opcodes themselves are allocated from the beginning</span><br><span class="hljs-comment">// (top) of the memory, while any string that an opcode needs is allocated from</span><br><span class="hljs-comment">// the end (bottom) of the memory.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// In essence:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//   low address ---&gt; [opcode 1]</span><br><span class="hljs-comment">//                    [opcode 2]</span><br><span class="hljs-comment">//                    [opcode 3]</span><br><span class="hljs-comment">//                    |        | &lt;--- memory_top_</span><br><span class="hljs-comment">//                    | free   |</span><br><span class="hljs-comment">//                    |        |</span><br><span class="hljs-comment">//                    |        | &lt;--- memory_bottom_</span><br><span class="hljs-comment">//                    [string 1]</span><br><span class="hljs-comment">//   high address --&gt; [string 2]</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Note that this class does not keep track of the number of opcodes made and</span><br><span class="hljs-comment">// it is designed to be a building block for low-level policy.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Note that any of the MakeOpXXXXX member functions below can return nullptr on</span><br><span class="hljs-comment">// failure. When that happens opcode sequence creation must be aborted.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OpcodeFactory</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">// memory: base pointer to a chunk of memory where the opcodes are created.</span><br>  <span class="hljs-comment">// memory_size: the size in bytes of the memory chunk.</span><br>  <span class="hljs-comment">// OpcodeFactory维护了一堆组织好的PolicyOpcode，所以需要一个buffer来存储</span><br>  <span class="hljs-comment">// 构造器先对buffer的顶和底进行初始化，memory_top_和memory_bottom_</span><br>  <span class="hljs-comment">// 根据头注释，这个buffer应该是双向增长的，共用中间的free空间</span><br>  <span class="hljs-built_in">OpcodeFactory</span>(<span class="hljs-type">char</span>* memory, <span class="hljs-type">size_t</span> memory_size) : <span class="hljs-built_in">memory_top_</span>(memory) &#123;<br>    memory_bottom_ = &amp;memory_top_[memory_size];<br>  &#125;<br><br>  <span class="hljs-comment">// policy: contains the raw memory where the opcodes are created.</span><br>  <span class="hljs-comment">// memory_size: contains the actual size of the policy argument.</span><br>  <span class="hljs-comment">// 传PolicyBuffer进来，与上面不同的地方在于，memory_top_一开始跳过了前4个opcode_count字节</span><br>  <span class="hljs-built_in">OpcodeFactory</span>(PolicyBuffer* policy, <span class="hljs-type">size_t</span> memory_size) &#123;<br>    memory_top_ = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span>*&gt;(&amp;policy-&gt;opcodes[<span class="hljs-number">0</span>]);<br>    memory_bottom_ = &amp;memory_top_[memory_size];<br>  &#125;<br><br>  <span class="hljs-comment">// Returns the available memory to make opcodes.</span><br>  <span class="hljs-comment">// 看看free还有多大</span><br>  <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">memory_size</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-built_in">DCHECK_GE</span>(memory_bottom_, memory_top_);<br>    <span class="hljs-keyword">return</span> memory_bottom_ - memory_top_;<br>  &#125;<br><br>  <span class="hljs-comment">// 荷枪实弹</span><br>  <span class="hljs-comment">// Creates an OpAlwaysFalse opcode.</span><br>  <span class="hljs-function">PolicyOpcode* <span class="hljs-title">MakeOpAlwaysFalse</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> options)</span></span>;<br><br>  <span class="hljs-comment">// Creates an OpAlwaysFalse opcode.</span><br>  <span class="hljs-function">PolicyOpcode* <span class="hljs-title">MakeOpAlwaysTrue</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> options)</span></span>;<br><br>  <span class="hljs-comment">// Creates an OpAction opcode.</span><br>  <span class="hljs-comment">// action: The action to return when Evaluate() is called.</span><br>  <span class="hljs-function">PolicyOpcode* <span class="hljs-title">MakeOpAction</span><span class="hljs-params">(EvalResult action, <span class="hljs-type">uint32_t</span> options)</span></span>;<br><br>  <span class="hljs-comment">// Creates an OpNumberMatch opcode.</span><br>  <span class="hljs-comment">// selected_param: index of the input argument. It must be a uint32_t or the</span><br>  <span class="hljs-comment">// evaluation result will generate a EVAL_ERROR.</span><br>  <span class="hljs-comment">// match: the number to compare against the selected_param.</span><br>  <span class="hljs-function">PolicyOpcode* <span class="hljs-title">MakeOpNumberMatch</span><span class="hljs-params">(<span class="hljs-type">int16_t</span> selected_param,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-type">uint32_t</span> match,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-type">uint32_t</span> options)</span></span>;<br><br>  <span class="hljs-comment">// Creates an OpNumberMatch opcode (void pointers are cast to numbers).</span><br>  <span class="hljs-comment">// selected_param: index of the input argument. It must be an void* or the</span><br>  <span class="hljs-comment">// evaluation result will generate a EVAL_ERROR.</span><br>  <span class="hljs-comment">// match: the pointer numeric value to compare against selected_param.</span><br>  <span class="hljs-function">PolicyOpcode* <span class="hljs-title">MakeOpVoidPtrMatch</span><span class="hljs-params">(<span class="hljs-type">int16_t</span> selected_param,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   <span class="hljs-type">const</span> <span class="hljs-type">void</span>* match,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   <span class="hljs-type">uint32_t</span> options)</span></span>;<br><br>  <span class="hljs-comment">// Creates an OpNumberMatchRange opcode using the memory passed in the ctor.</span><br>  <span class="hljs-comment">// selected_param: index of the input argument. It must be a uint32_t or the</span><br>  <span class="hljs-comment">// evaluation result will generate a EVAL_ERROR.</span><br>  <span class="hljs-comment">// lower_bound, upper_bound: the range to compare against selected_param.</span><br>  <span class="hljs-function">PolicyOpcode* <span class="hljs-title">MakeOpNumberMatchRange</span><span class="hljs-params">(<span class="hljs-type">int16_t</span> selected_param,</span></span><br><span class="hljs-params"><span class="hljs-function">                                       <span class="hljs-type">uint32_t</span> lower_bound,</span></span><br><span class="hljs-params"><span class="hljs-function">                                       <span class="hljs-type">uint32_t</span> upper_bound,</span></span><br><span class="hljs-params"><span class="hljs-function">                                       <span class="hljs-type">uint32_t</span> options)</span></span>;<br><br>  <span class="hljs-comment">// Creates an OpWStringMatch opcode using the raw memory passed in the ctor.</span><br>  <span class="hljs-comment">// selected_param: index of the input argument. It must be a wide string</span><br>  <span class="hljs-comment">// pointer or the evaluation result will generate a EVAL_ERROR.</span><br>  <span class="hljs-comment">// match_str: string to compare against selected_param.</span><br>  <span class="hljs-comment">// start_position: when its value is from 0 to &lt; 0x7fff it indicates an</span><br>  <span class="hljs-comment">// offset from the selected_param string where to perform the comparison. If</span><br>  <span class="hljs-comment">// the value is SeekForward  then a substring search is performed. If the</span><br>  <span class="hljs-comment">// value is SeekToEnd the comparison is performed against the last part of</span><br>  <span class="hljs-comment">// the selected_param string.</span><br>  <span class="hljs-comment">// Note that the range in the position (0 to 0x7fff) is dictated by the</span><br>  <span class="hljs-comment">// current implementation.</span><br>  <span class="hljs-comment">// match_opts: Indicates additional matching flags. Currently CaseInsensitive</span><br>  <span class="hljs-comment">// is supported.</span><br>  <span class="hljs-function">PolicyOpcode* <span class="hljs-title">MakeOpWStringMatch</span><span class="hljs-params">(<span class="hljs-type">int16_t</span> selected_param,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* match_str,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   <span class="hljs-type">int</span> start_position,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   StringMatchOptions match_opts,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   <span class="hljs-type">uint32_t</span> options)</span></span>;<br><br>  <span class="hljs-comment">// Creates an OpNumberAndMatch opcode using the raw memory passed in the ctor.</span><br>  <span class="hljs-comment">// selected_param: index of the input argument. It must be uint32_t or the</span><br>  <span class="hljs-comment">// evaluation result will generate a EVAL_ERROR.</span><br>  <span class="hljs-comment">// match: the value to bitwise AND against selected_param.</span><br>  <span class="hljs-function">PolicyOpcode* <span class="hljs-title">MakeOpNumberAndMatch</span><span class="hljs-params">(<span class="hljs-type">int16_t</span> selected_param,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     <span class="hljs-type">uint32_t</span> match,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     <span class="hljs-type">uint32_t</span> options)</span></span>;<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-comment">// Constructs the common part of every opcode. selected_param is the index</span><br>  <span class="hljs-comment">// of the input param to use when evaluating the opcode. Pass -1 in</span><br>  <span class="hljs-comment">// selected_param to indicate that no input parameter is required.</span><br>  <span class="hljs-function">PolicyOpcode* <span class="hljs-title">MakeBase</span><span class="hljs-params">(OpcodeID opcode_id,</span></span><br><span class="hljs-params"><span class="hljs-function">                         <span class="hljs-type">uint32_t</span> options,</span></span><br><span class="hljs-params"><span class="hljs-function">                         <span class="hljs-type">int16_t</span> selected_param)</span></span>;<br><br>  <span class="hljs-comment">// Allocates (and copies) a string (of size length) inside the buffer and</span><br>  <span class="hljs-comment">// returns the displacement with respect to start.</span><br>  <span class="hljs-function"><span class="hljs-type">ptrdiff_t</span> <span class="hljs-title">AllocRelative</span><span class="hljs-params">(<span class="hljs-type">void</span>* start, <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* str, <span class="hljs-type">size_t</span> length)</span></span>;<br><br>  <span class="hljs-comment">// Points to the lowest currently available address of the memory</span><br>  <span class="hljs-comment">// used to make the opcodes. This pointer increments as opcodes are made.</span><br>  <span class="hljs-type">char</span>* memory_top_;<br><br>  <span class="hljs-comment">// Points to the highest currently available address of the memory</span><br>  <span class="hljs-comment">// used to make the opcodes. This pointer decrements as opcode strings are</span><br>  <span class="hljs-comment">// allocated.</span><br>  <span class="hljs-type">char</span>* memory_bottom_;<br><br>  <span class="hljs-built_in">DISALLOW_COPY_AND_ASSIGN</span>(OpcodeFactory);<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>荷枪实弹的几个实装方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//////////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Opcode OpAlwaysFalse:</span><br><span class="hljs-comment">// Does not require input parameter.</span><br><br><span class="hljs-function">PolicyOpcode* <span class="hljs-title">OpcodeFactory::MakeOpAlwaysFalse</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> options)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">MakeBase</span>(OP_ALWAYS_FALSE, options, <span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Opcode OpAlwaysTrue:</span><br><span class="hljs-comment">// Does not require input parameter.</span><br><br><span class="hljs-function">PolicyOpcode* <span class="hljs-title">OpcodeFactory::MakeOpAlwaysTrue</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> options)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">MakeBase</span>(OP_ALWAYS_TRUE, options, <span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Opcode OpAction:</span><br><span class="hljs-comment">// Does not require input parameter.</span><br><span class="hljs-comment">// Argument 0 contains the actual action to return.</span><br><br><span class="hljs-function">PolicyOpcode* <span class="hljs-title">OpcodeFactory::MakeOpAction</span><span class="hljs-params">(EvalResult action, <span class="hljs-type">uint32_t</span> options)</span> </span>&#123;<br>  PolicyOpcode* opcode = <span class="hljs-built_in">MakeBase</span>(OP_ACTION, options, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (!opcode)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-comment">// 这就与OpcodeEval&lt;OP_ACTION&gt;的处理对上了，action的确是放在arguments_[0]的</span><br>  opcode-&gt;<span class="hljs-built_in">SetArgument</span>(<span class="hljs-number">0</span>, action);<br>  <span class="hljs-keyword">return</span> opcode;<br>&#125;<br><br><span class="hljs-comment">// 剩下的这些也都和OpcodeEval&lt;xxx&gt;一一对上，就不多说了</span><br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Opcode OpNumberMatch:</span><br><span class="hljs-comment">// Requires a uint32_t or void* in selected_param</span><br><span class="hljs-comment">// Argument 0 is the stored number to match.</span><br><span class="hljs-comment">// Argument 1 is the C++ type of the 0th argument.</span><br><br><span class="hljs-function">PolicyOpcode* <span class="hljs-title">OpcodeFactory::MakeOpNumberMatch</span><span class="hljs-params">(<span class="hljs-type">int16_t</span> selected_param,</span></span><br><span class="hljs-params"><span class="hljs-function">                                               <span class="hljs-type">uint32_t</span> match,</span></span><br><span class="hljs-params"><span class="hljs-function">                                               <span class="hljs-type">uint32_t</span> options)</span> </span>&#123;<br>  PolicyOpcode* opcode = <span class="hljs-built_in">MakeBase</span>(OP_NUMBER_MATCH, options, selected_param);<br>  <span class="hljs-keyword">if</span> (!opcode)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  opcode-&gt;<span class="hljs-built_in">SetArgument</span>(<span class="hljs-number">0</span>, match);<br>  opcode-&gt;<span class="hljs-built_in">SetArgument</span>(<span class="hljs-number">1</span>, UINT32_TYPE);<br>  <span class="hljs-keyword">return</span> opcode;<br>&#125;<br><br><span class="hljs-function">PolicyOpcode* <span class="hljs-title">OpcodeFactory::MakeOpVoidPtrMatch</span><span class="hljs-params">(<span class="hljs-type">int16_t</span> selected_param,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                <span class="hljs-type">const</span> <span class="hljs-type">void</span>* match,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                <span class="hljs-type">uint32_t</span> options)</span> </span>&#123;<br>  PolicyOpcode* opcode = <span class="hljs-built_in">MakeBase</span>(OP_NUMBER_MATCH, options, selected_param);<br>  <span class="hljs-keyword">if</span> (!opcode)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  opcode-&gt;<span class="hljs-built_in">SetArgument</span>(<span class="hljs-number">0</span>, match);<br>  opcode-&gt;<span class="hljs-built_in">SetArgument</span>(<span class="hljs-number">1</span>, VOIDPTR_TYPE);<br>  <span class="hljs-keyword">return</span> opcode;<br>&#125;<br><br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Opcode OpNumberMatchRange</span><br><span class="hljs-comment">// Requires a uint32_t in selected_param.</span><br><span class="hljs-comment">// Argument 0 is the stored lower bound to match.</span><br><span class="hljs-comment">// Argument 1 is the stored upper bound to match.</span><br><br><span class="hljs-function">PolicyOpcode* <span class="hljs-title">OpcodeFactory::MakeOpNumberMatchRange</span><span class="hljs-params">(<span class="hljs-type">int16_t</span> selected_param,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                    <span class="hljs-type">uint32_t</span> lower_bound,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                    <span class="hljs-type">uint32_t</span> upper_bound,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                    <span class="hljs-type">uint32_t</span> options)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (lower_bound &gt; upper_bound) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  &#125;<br>  PolicyOpcode* opcode =<br>      <span class="hljs-built_in">MakeBase</span>(OP_NUMBER_MATCH_RANGE, options, selected_param);<br>  <span class="hljs-keyword">if</span> (!opcode)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  opcode-&gt;<span class="hljs-built_in">SetArgument</span>(<span class="hljs-number">0</span>, lower_bound);<br>  opcode-&gt;<span class="hljs-built_in">SetArgument</span>(<span class="hljs-number">1</span>, upper_bound);<br>  <span class="hljs-keyword">return</span> opcode;<br>&#125;<br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Opcode OpNumberAndMatch:</span><br><span class="hljs-comment">// Requires a uint32_t in selected_param.</span><br><span class="hljs-comment">// Argument 0 is the stored number to match.</span><br><br><span class="hljs-function">PolicyOpcode* <span class="hljs-title">OpcodeFactory::MakeOpNumberAndMatch</span><span class="hljs-params">(<span class="hljs-type">int16_t</span> selected_param,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                  <span class="hljs-type">uint32_t</span> match,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                  <span class="hljs-type">uint32_t</span> options)</span> </span>&#123;<br>  PolicyOpcode* opcode = <span class="hljs-built_in">MakeBase</span>(OP_NUMBER_AND_MATCH, options, selected_param);<br>  <span class="hljs-keyword">if</span> (!opcode)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  opcode-&gt;<span class="hljs-built_in">SetArgument</span>(<span class="hljs-number">0</span>, match);<br>  <span class="hljs-keyword">return</span> opcode;<br>&#125;<br><span class="hljs-comment">//////////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// Opcode OpWStringMatch:</span><br><span class="hljs-comment">// Requires a wchar_t* in selected_param.</span><br><span class="hljs-comment">// Argument 0 is the byte displacement of the stored string.</span><br><span class="hljs-comment">// Argument 1 is the length in chars of the stored string.</span><br><span class="hljs-comment">// Argument 2 is the offset to apply on the input string. It has special values.</span><br><span class="hljs-comment">// as noted in the header file.</span><br><span class="hljs-comment">// Argument 3 is the string matching options.</span><br><br><span class="hljs-function">PolicyOpcode* <span class="hljs-title">OpcodeFactory::MakeOpWStringMatch</span><span class="hljs-params">(<span class="hljs-type">int16_t</span> selected_param,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* match_str,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                <span class="hljs-type">int</span> start_position,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                StringMatchOptions match_opts,</span></span><br><span class="hljs-params"><span class="hljs-function">                                                <span class="hljs-type">uint32_t</span> options)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (!match_str)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;\0&#x27;</span> == match_str[<span class="hljs-number">0</span>])<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br><br>  <span class="hljs-type">int</span> length = <span class="hljs-built_in">lstrlenW</span>(match_str);<br><br>  PolicyOpcode* opcode = <span class="hljs-built_in">MakeBase</span>(OP_WSTRING_MATCH, options, selected_param);<br>  <span class="hljs-keyword">if</span> (!opcode)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-comment">// 字符串分配在buffer尾部，从bottom向上抬</span><br>  <span class="hljs-type">ptrdiff_t</span> delta_str = <span class="hljs-built_in">AllocRelative</span>(opcode, match_str, <span class="hljs-built_in">wcslen</span>(match_str) + <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == delta_str)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-comment">// 注意这个delta_str只是个偏移，所以OpcodeEval&lt;OP_WSTRING_MATCH&gt;时使用的是GetRelativeString</span><br>  <span class="hljs-comment">// 而不是GetArgument</span><br>  opcode-&gt;<span class="hljs-built_in">SetArgument</span>(<span class="hljs-number">0</span>, delta_str);<br>  opcode-&gt;<span class="hljs-built_in">SetArgument</span>(<span class="hljs-number">1</span>, length);<br>  opcode-&gt;<span class="hljs-built_in">SetArgument</span>(<span class="hljs-number">2</span>, start_position);<br>  opcode-&gt;<span class="hljs-built_in">SetArgument</span>(<span class="hljs-number">3</span>, match_opts);<br>  <span class="hljs-keyword">return</span> opcode;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>每个Make方法都是new了一个<code>PolicyOpcode</code>对象，把实装的信息填充到<code>PolicyOpcode</code>对象中。在new出一个<code>PolicyOpcode</code>对象时，都使用了一个相同的基准方法<code>MakeBase</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//////////////////////////////////////////////////////////////////////////////</span><br><span class="hljs-comment">// OpcodeMaker (other member functions).</span><br><br><span class="hljs-function">PolicyOpcode* <span class="hljs-title">OpcodeFactory::MakeBase</span><span class="hljs-params">(OpcodeID opcode_id,</span></span><br><span class="hljs-params"><span class="hljs-function">                                      <span class="hljs-type">uint32_t</span> options,</span></span><br><span class="hljs-params"><span class="hljs-function">                                      <span class="hljs-type">int16_t</span> selected_param)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memory_size</span>() &lt; <span class="hljs-built_in">sizeof</span>(PolicyOpcode))<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br><br>  <span class="hljs-comment">// opcode从top开始向下占用buffer</span><br>  <span class="hljs-comment">// Create opcode using placement-new on the buffer memory.</span><br>  PolicyOpcode* opcode = <span class="hljs-built_in">new</span> (memory_top_) <span class="hljs-built_in">PolicyOpcode</span>();<br><br>  <span class="hljs-comment">// Fill in the standard fields, that every opcode has.</span><br>  memory_top_ += <span class="hljs-built_in">sizeof</span>(PolicyOpcode);<br>  opcode-&gt;opcode_id_ = opcode_id;	<span class="hljs-comment">// 哪种opcode</span><br>  opcode-&gt;<span class="hljs-built_in">SetOptions</span>(options);		<span class="hljs-comment">// 哪些标记</span><br>  <span class="hljs-comment">// 传入的selected_param表示用于和该PolicyOpcode比较的参数在ParameterSet中是第几个，也就是索引</span><br>  <span class="hljs-comment">// 看到这里也就明白了Evaluate中为什么直接读用parameter_做索引了，因为早在Make的时候已经设置好了</span><br>  opcode-&gt;parameter_ = selected_param;	<br>  <span class="hljs-keyword">return</span> opcode;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>字符串的匹配比较特殊，除了要保存一个<code>PolicyOpcode</code>对象以外，还要额外存储一个字符串pattern。这个字符串在尾端分配：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">ptrdiff_t</span> <span class="hljs-title">OpcodeFactory::AllocRelative</span><span class="hljs-params">(<span class="hljs-type">void</span>* start,</span></span><br><span class="hljs-params"><span class="hljs-function">                                       <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* str,</span></span><br><span class="hljs-params"><span class="hljs-function">                                       <span class="hljs-type">size_t</span> length)</span> </span>&#123;<br>  <span class="hljs-type">size_t</span> bytes = length * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">wchar_t</span>);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memory_size</span>() &lt; bytes)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  memory_bottom_ -= bytes;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">reinterpret_cast</span>&lt;UINT_PTR&gt;(memory_bottom_) &amp; <span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-comment">// TODO(cpu) replace this for something better.</span><br>    ::<span class="hljs-built_in">DebugBreak</span>();<br>  &#125;<br>  <span class="hljs-built_in">memcpy</span>(memory_bottom_, str, bytes);<br>  <span class="hljs-type">ptrdiff_t</span> delta = memory_bottom_ - <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span>*&gt;(start);<br>  <span class="hljs-keyword">return</span> delta;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>工厂类的分析可以对接上<code>PolicyOpcode</code>本身的一些接口，到此我们也十分清楚工厂类的使用者在为某个函数设置policy时，会为每个参数调用一系列的Make函数，设置理想的裁决值。</p>
<p>但究竟是谁在用<code>OpcodeFactory</code>，又是如何操纵另一个重要的<code>ParameterSet</code>呢？现在还不得而知。猜想应该就是engine_processor。</p>
<h3 id="parameterset"><code>ParameterSet</code></h3>
<p>移步processor前，我们先分析被比较的<code>ParameterSet</code>都提供了哪些接口，至少我们已经不止一次的看到了它的Get。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Models the set of interesting parameters of an intercepted system call</span><br><span class="hljs-comment">// normally you don&#x27;t create objects of this class directly, instead you</span><br><span class="hljs-comment">// use the POLPARAMS_XXX macros.</span><br><span class="hljs-comment">// For example, if an intercepted function has the following signature:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// NTSTATUS NtOpenFileFunction (PHANDLE FileHandle,</span><br><span class="hljs-comment">//                              ACCESS_MASK DesiredAccess,</span><br><span class="hljs-comment">//                              POBJECT_ATTRIBUTES ObjectAttributes,</span><br><span class="hljs-comment">//                              PIO_STATUS_BLOCK IoStatusBlock,</span><br><span class="hljs-comment">//                              ULONG ShareAccess,</span><br><span class="hljs-comment">//                              ULONG OpenOptions);</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// You could say that the following parameters are of interest to policy:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//   POLPARAMS_BEGIN(open_params)</span><br><span class="hljs-comment">//      POLPARAM(DESIRED_ACCESS)</span><br><span class="hljs-comment">//      POLPARAM(OBJECT_NAME)</span><br><span class="hljs-comment">//      POLPARAM(SECURITY_DESCRIPTOR)</span><br><span class="hljs-comment">//      POLPARAM(IO_STATUS)</span><br><span class="hljs-comment">//      POLPARAM(OPEN_OPTIONS)</span><br><span class="hljs-comment">//   POLPARAMS_END;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// and the actual code will use this for defining the parameters:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//   CountedParameterSet&lt;open_params&gt; p;</span><br><span class="hljs-comment">//   p[open_params::DESIRED_ACCESS] = ParamPickerMake(DesiredAccess);</span><br><span class="hljs-comment">//   p[open_params::OBJECT_NAME] =</span><br><span class="hljs-comment">//       ParamPickerMake(ObjectAttributes-&gt;ObjectName);</span><br><span class="hljs-comment">//   p[open_params::SECURITY_DESCRIPTOR] =</span><br><span class="hljs-comment">//       ParamPickerMake(ObjectAttributes-&gt;SecurityDescriptor);</span><br><span class="hljs-comment">//   p[open_params::IO_STATUS] = ParamPickerMake(IoStatusBlock);</span><br><span class="hljs-comment">//   p[open_params::OPEN_OPTIONS] = ParamPickerMake(OpenOptions);</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//  These will create an stack-allocated array of ParameterSet objects which</span><br><span class="hljs-comment">//  have each 1) the address of the parameter 2) a numeric id that encodes the</span><br><span class="hljs-comment">//  original C++ type. This allows the policy to treat any set of supported</span><br><span class="hljs-comment">//  argument types uniformily and with some type safety.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//  TODO(cpu): support not fully implemented yet for unicode string and will</span><br><span class="hljs-comment">//  probably add other types as well.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterSet</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">ParameterSet</span>() : <span class="hljs-built_in">real_type_</span>(INVALID_TYPE), <span class="hljs-built_in">address_</span>(<span class="hljs-literal">nullptr</span>) &#123;&#125;<br><br>  <span class="hljs-comment">// real_type的3种类型对应的重载Get方法，real_type_来判定</span><br>  <span class="hljs-comment">// Retrieve the stored parameter. If the type does not match ulong fail.</span><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Get</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span>* destination)</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (real_type_ != UINT32_TYPE) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    *destination = <span class="hljs-built_in">Void2TypePointerCopy</span>&lt;<span class="hljs-type">uint32_t</span>&gt;();<span class="hljs-comment">//返回的实际上是address_成员的地址</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// Retrieve the stored parameter. If the type does not match void* fail.</span><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Get</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>** destination)</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (real_type_ != VOIDPTR_TYPE) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    *destination = <span class="hljs-built_in">Void2TypePointerCopy</span>&lt;<span class="hljs-type">void</span>*&gt;();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// Retrieve the stored parameter. If the type does not match wchar_t* fail.</span><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Get</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>** destination)</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (real_type_ != WCHAR_TYPE) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    *destination = <span class="hljs-built_in">Void2TypePointerCopy</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>*&gt;();<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// False if the parameter is not properly initialized.</span><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">IsValid</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123; <span class="hljs-keyword">return</span> real_type_ != INVALID_TYPE; &#125;<br><br> <span class="hljs-keyword">protected</span>:<br>  <span class="hljs-comment">// The constructor can only be called by derived types, which should</span><br>  <span class="hljs-comment">// safely provide the real_type and the address of the argument.</span><br>  <span class="hljs-comment">// 所以他才是关键，真正有用的构造函数，以address赋给address_，实际上参数的buffer</span><br>  <span class="hljs-comment">// 可以看出由外部维护，ParameterSet只是架在上面的操纵者罢了</span><br>  <span class="hljs-comment">// protected权限又表示外部使用该对象时，必须得间接用派生对象</span><br>  <span class="hljs-built_in">ParameterSet</span>(ArgType real_type, <span class="hljs-type">const</span> <span class="hljs-type">void</span>* address)<br>      : <span class="hljs-built_in">real_type_</span>(real_type), <span class="hljs-built_in">address_</span>(address) &#123;&#125;<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-comment">// This template provides the same functionality as bits_cast but</span><br>  <span class="hljs-comment">// it works with pointer while the former works only with references.</span><br>  <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br>  <span class="hljs-function">T <span class="hljs-title">Void2TypePointerCopy</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> *(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> T*&gt;(address_));<span class="hljs-comment">//类型转换模板</span><br>  &#125;<br><br>  ArgType real_type_;<br>  <span class="hljs-type">const</span> <span class="hljs-type">void</span>* address_;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h3 id="parametersetex"><code>ParameterSetEx</code></h3>
<p>protected权限的构造器也就表明了派生类的存在意义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// To safely infer the type, we use a set of template specializations</span><br><span class="hljs-comment">// in ParameterSetEx with a template function ParamPickerMake to do the</span><br><span class="hljs-comment">// parameter type deduction.</span><br><br><span class="hljs-comment">// Base template class. Not implemented so using unsupported types should</span><br><span class="hljs-comment">// fail to compile.</span><br><span class="hljs-comment">// 使用ParameterSetEx类模板</span><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterSetEx</span> : <span class="hljs-keyword">public</span> ParameterSet &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">ParameterSetEx</span>(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* address);<br>&#125;;<br><br><span class="hljs-comment">// 一串不同typename对应的实现体</span><br><span class="hljs-comment">// 实际上差别仅在于设置不同的ArgType</span><br><span class="hljs-keyword">template</span> &lt;&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterSetEx</span>&lt;<span class="hljs-type">void</span> <span class="hljs-type">const</span>*&gt; : <span class="hljs-keyword">public</span> ParameterSet &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">ParameterSetEx</span>(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* address) : <span class="hljs-built_in">ParameterSet</span>(VOIDPTR_TYPE, address) &#123;&#125;<br>&#125;;<br><br><span class="hljs-keyword">template</span> &lt;&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterSetEx</span>&lt;<span class="hljs-type">void</span>*&gt; : <span class="hljs-keyword">public</span> ParameterSet &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">ParameterSetEx</span>(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* address) : <span class="hljs-built_in">ParameterSet</span>(VOIDPTR_TYPE, address) &#123;&#125;<br>&#125;;<br><br><span class="hljs-keyword">template</span> &lt;&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterSetEx</span>&lt;<span class="hljs-type">wchar_t</span>*&gt; : <span class="hljs-keyword">public</span> ParameterSet &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">ParameterSetEx</span>(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* address) : <span class="hljs-built_in">ParameterSet</span>(WCHAR_TYPE, address) &#123;&#125;<br>&#125;;<br><br><span class="hljs-keyword">template</span> &lt;&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterSetEx</span>&lt;<span class="hljs-type">wchar_t</span> <span class="hljs-type">const</span>*&gt; : <span class="hljs-keyword">public</span> ParameterSet &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">ParameterSetEx</span>(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* address) : <span class="hljs-built_in">ParameterSet</span>(WCHAR_TYPE, address) &#123;&#125;<br>&#125;;<br><br><span class="hljs-keyword">template</span> &lt;&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterSetEx</span>&lt;<span class="hljs-type">uint32_t</span>&gt; : <span class="hljs-keyword">public</span> ParameterSet &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">ParameterSetEx</span>(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* address) : <span class="hljs-built_in">ParameterSet</span>(UINT32_TYPE, address) &#123;&#125;<br>&#125;;<br><br><span class="hljs-keyword">template</span> &lt;&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterSetEx</span>&lt;UNICODE_STRING&gt; : <span class="hljs-keyword">public</span> ParameterSet &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-built_in">ParameterSetEx</span>(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* address) : <span class="hljs-built_in">ParameterSet</span>(UNISTR_TYPE, address) &#123;&#125;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>根据父类的<code>ArgType</code>型参数，派生类的每个实现体指明了具体的类型，此时<code>real_type_</code>就有效了。</p>
<p>当然，<code>ParameterSetEx</code>实现体太多了，为了使用方便，又定义了：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-function">ParameterSet <span class="hljs-title">ParamPickerMake</span><span class="hljs-params">(T&amp; parameter)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">ParameterSetEx</span>&lt;T&gt;(&amp;parameter);<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>非常简单的一个转换适配器函数模板，各找各妈。</p>
<h3 id="countedparameterset"><code>CountedParameterSet</code></h3>
<p>一个<code>ParameterSet</code>的集合，每一种interception对应一个这样的policy
parameters串</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// This template defines the actual list of policy parameters for a given</span><br><span class="hljs-comment">// interception.</span><br><span class="hljs-comment">// Warning: This template stores the address to the actual variables, in</span><br><span class="hljs-comment">// other words, the values are not copied.</span><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CountedParameterSet</span> &#123;<br>  <span class="hljs-built_in">CountedParameterSet</span>() : <span class="hljs-built_in">count</span>(T::PolParamLast) &#123;&#125;<br><br>  <span class="hljs-comment">// 重载了[]操作符，对此操作时就可以直接返回选择的ParameterSet对象</span><br>  ParameterSet&amp; <span class="hljs-keyword">operator</span>[](<span class="hljs-keyword">typename</span> T::Args n) &#123; <span class="hljs-keyword">return</span> parameters[n]; &#125;<br><br>  <span class="hljs-comment">// 其实就是count的起始地址</span><br>  <span class="hljs-function">CountedParameterSetBase* <span class="hljs-title">GetBase</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">reinterpret_cast</span>&lt;CountedParameterSetBase*&gt;(<span class="hljs-keyword">this</span>);<br>  &#125;<br><br>  <span class="hljs-type">size_t</span> count;<br>  ParameterSet parameters[T::PolParamLast];<span class="hljs-comment">//这个T::PolParamLast源于T</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<p><code>ParameterSet</code>相关的定义能够暗示一些操纵者的用法，但还不够明朗。我们接下来就研究一下processor这个操纵者是如何驾驭<code>ParameterSet</code>和<code>OpcodeFactory</code>的。</p>
<h2 id="processor">processor</h2>
<p>文件头的描述已经相当详细了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// This header contains the core policy evaluator. In its simplest form</span><br><span class="hljs-comment">// it evaluates a stream of opcodes assuming that they are laid out in</span><br><span class="hljs-comment">// memory as opcode groups.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// An opcode group has N comparison opcodes plus 1 action opcode. For</span><br><span class="hljs-comment">// example here we have 3 opcode groups (A, B,C):</span><br><span class="hljs-comment">// 一个opcode组由N个comparison opcodes加上一个action opcode组成</span><br><span class="hljs-comment">// 这里是个3组的示范：</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// [comparison 1]  &lt;-- group A start</span><br><span class="hljs-comment">// [comparison 2]</span><br><span class="hljs-comment">// [comparison 3]</span><br><span class="hljs-comment">// [action A    ]</span><br><span class="hljs-comment">// [comparison 1]  &lt;-- group B start</span><br><span class="hljs-comment">// [action B    ]</span><br><span class="hljs-comment">// [comparison 1]  &lt;-- group C start</span><br><span class="hljs-comment">// [comparison 2]</span><br><span class="hljs-comment">// [action C    ]</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// The opcode evaluator proceeds from the top, evaluating each opcode in</span><br><span class="hljs-comment">// sequence. An opcode group is evaluated until the first comparison that</span><br><span class="hljs-comment">// returns false. At that point the rest of the group is skipped and evaluation</span><br><span class="hljs-comment">// resumes with the first comparison of the next group. When all the comparisons</span><br><span class="hljs-comment">// in a group have evaluated to true and the action is reached. The group is</span><br><span class="hljs-comment">// considered a matching group.</span><br><span class="hljs-comment">// 裁决从top开始，逐个opcode进行evaluate。</span><br><span class="hljs-comment">// 一组opcode设定的条件只有全部满足时，才继续下一组的匹配，否则就不必继续审判了</span><br><span class="hljs-comment">// </span><br><span class="hljs-comment">// In the &#x27;ShortEval&#x27; mode evaluation stops when it reaches the end or the first</span><br><span class="hljs-comment">// matching group. The action opcode from this group is the resulting policy</span><br><span class="hljs-comment">// action.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// In the &#x27;RankedEval&#x27; mode evaluation stops only when it reaches the end of the</span><br><span class="hljs-comment">// the opcode stream. In the process all matching groups are saved and at the</span><br><span class="hljs-comment">// end the &#x27;best&#x27; group is selected (what makes the best is TBD) and the action</span><br><span class="hljs-comment">// from this group is the resulting policy action.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// As explained above, the policy evaluation of a group is a logical AND of</span><br><span class="hljs-comment">// the evaluation of each opcode. However an opcode can request kPolUseOREval</span><br><span class="hljs-comment">// which makes the evaluation to use logical OR. Given that each opcode can</span><br><span class="hljs-comment">// request its evaluation result to be negated with kPolNegateEval you can</span><br><span class="hljs-comment">// achieve the negation of the total group evaluation. This means that if you</span><br><span class="hljs-comment">// need to express:</span><br><span class="hljs-comment">// 对一组opcode的裁决，默认每个comparsion都是AND操作，可以通过kPolUseOREval来置成</span><br><span class="hljs-comment">// OR操作</span><br><span class="hljs-comment">//             if (!(c1 &amp;&amp; c2 &amp;&amp; c3))</span><br><span class="hljs-comment">// You can do it by:</span><br><span class="hljs-comment">//             if ((!c1) || (!c2) || (!c3))</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-comment">// Possible outcomes of policy evaluation.</span><br></code></pre></td></tr></table></figure>
<p>一些常量、枚举：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Possible outcomes of policy evaluation.</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">PolicyResult</span> &#123; NO_POLICY_MATCH, POLICY_MATCH, POLICY_ERROR &#125;;<br><br><span class="hljs-comment">// Policy evaluation flags</span><br><span class="hljs-comment">// TODO(cpu): implement the options kStopOnErrors &amp; kRankedEval.</span><br><span class="hljs-comment">// </span><br><span class="hljs-comment">// Stop evaluating as soon as an error is encountered.</span><br><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> kStopOnErrors = <span class="hljs-number">1</span>;<br><span class="hljs-comment">// Ignore all non fatal opcode evaluation errors.</span><br><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> kIgnoreErrors = <span class="hljs-number">2</span>;<br><span class="hljs-comment">// Short-circuit evaluation: Only evaluate until opcode group that</span><br><span class="hljs-comment">// evaluated to true has been found.</span><br><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> kShortEval = <span class="hljs-number">4</span>;<br><span class="hljs-comment">// Discussed briefly at the policy design meeting. It will evaluate</span><br><span class="hljs-comment">// all rules and then return the &#x27;best&#x27; rule that evaluated true.</span><br><span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> kRankedEval = <span class="hljs-number">8</span>;<br></code></pre></td></tr></table></figure>
<h3 id="policyprocessor"><code>PolicyProcessor</code></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// This class evaluates a policy-opcode stream given the memory where the</span><br><span class="hljs-comment">// opcodes are and an input &#x27;parameter set&#x27;.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// This class is designed to be callable from interception points</span><br><span class="hljs-comment">// as low as the NtXXXX service level (it is not currently safe, but</span><br><span class="hljs-comment">// it is designed to be made safe).</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Its usage in an interception is:</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//   POLPARAMS_BEGIN(eval_params)</span><br><span class="hljs-comment">//     POLPARAM(param1)</span><br><span class="hljs-comment">//     POLPARAM(param2)</span><br><span class="hljs-comment">//     POLPARAM(param3)</span><br><span class="hljs-comment">//     POLPARAM(param4)</span><br><span class="hljs-comment">//     POLPARAM(param5)</span><br><span class="hljs-comment">//   POLPARAMS_END;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//   PolicyProcessor pol_evaluator(policy_memory);</span><br><span class="hljs-comment">//   PolicyResult pr = pol_evaluator.Evaluate(ShortEval, eval_params,</span><br><span class="hljs-comment">//                                            _countof(eval_params));</span><br><span class="hljs-comment">//   if (NO_POLICY_MATCH == pr) &#123;</span><br><span class="hljs-comment">//     EvalResult policy_action =  pol_evaluator.GetAction();</span><br><span class="hljs-comment">//     // apply policy here...</span><br><span class="hljs-comment">//   &#125;</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Where the POLPARAM() arguments are derived from the intercepted function</span><br><span class="hljs-comment">// arguments, and represent all the &#x27;interesting&#x27; policy inputs, and</span><br><span class="hljs-comment">// policy_memory is a memory buffer containing the opcode stream that is the</span><br><span class="hljs-comment">// relevant policy for this intercept.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PolicyProcessor</span> &#123;<br> <span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">// policy_buffer contains opcodes made with OpcodeFactory. They are usually</span><br>  <span class="hljs-comment">// created in the broker process and evaluated in the target process.</span><br><br>  <span class="hljs-comment">// This constructor is just a variant of the previous constructor.</span><br>  <span class="hljs-comment">// 该构造器把PolicyBuffer传入，存储PolicyOpcode的容器与操纵者关联</span><br>  <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">PolicyProcessor</span><span class="hljs-params">(PolicyBuffer* policy)</span> : policy_(policy) &#123;</span><br>    <span class="hljs-built_in">SetInternalState</span>(<span class="hljs-number">0</span>, EVAL_FALSE);<br>  &#125;<br><br>  <span class="hljs-comment">// Evaluates a policy-opcode stream. See the comments at the top of this</span><br>  <span class="hljs-comment">// class for more info. Returns POLICY_MATCH if a rule set was found that</span><br>  <span class="hljs-comment">// matches an active policy.</span><br>  <span class="hljs-comment">// 这个就是某个函数所有参数的Evaluate，传递了ParameterSet和count进去，其内部理应对每个参数进行</span><br>  <span class="hljs-comment">// PolicyOpcode::Evaluate</span><br>  <span class="hljs-function">PolicyResult <span class="hljs-title">Evaluate</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> options,</span></span><br><span class="hljs-params"><span class="hljs-function">                        ParameterSet* parameters,</span></span><br><span class="hljs-params"><span class="hljs-function">                        <span class="hljs-type">size_t</span> parameter_count)</span></span>;<br><br>  <span class="hljs-comment">// If the result of Evaluate() was POLICY_MATCH, calling this function returns</span><br>  <span class="hljs-comment">// the recommended policy action.</span><br>  <span class="hljs-function">EvalResult <span class="hljs-title">GetAction</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;<br><br> <span class="hljs-keyword">private</span>:<br>  <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-type">size_t</span> current_index_;<br>    EvalResult current_result_;<br>  &#125; state_;<br><br>  <span class="hljs-comment">// Sets the currently matching action result.</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetInternalState</span><span class="hljs-params">(<span class="hljs-type">size_t</span> index, EvalResult result)</span></span>;<br><br>  PolicyBuffer* policy_;<br>  <span class="hljs-built_in">DISALLOW_COPY_AND_ASSIGN</span>(PolicyProcessor);<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>关键的Evaluate，处理函数的parameters。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">PolicyResult <span class="hljs-title">PolicyProcessor::Evaluate</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> options,</span></span><br><span class="hljs-params"><span class="hljs-function">                                       ParameterSet* parameters,</span></span><br><span class="hljs-params"><span class="hljs-function">                                       <span class="hljs-type">size_t</span> param_count)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (!policy_)<br>    <span class="hljs-keyword">return</span> NO_POLICY_MATCH;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == policy_-&gt;opcode_count)<br>    <span class="hljs-keyword">return</span> NO_POLICY_MATCH;<br>  <span class="hljs-comment">// 至少得置位kShortEval</span><br>  <span class="hljs-keyword">if</span> (!(kShortEval &amp; options))<br>    <span class="hljs-keyword">return</span> POLICY_ERROR;<br><br>  MatchContext context;<br>  <span class="hljs-type">bool</span> evaluation = <span class="hljs-literal">false</span>;<br>  <span class="hljs-type">bool</span> skip_group = <span class="hljs-literal">false</span>;<br>  <span class="hljs-built_in">SetInternalState</span>(<span class="hljs-number">0</span>, EVAL_FALSE);<br>  <span class="hljs-type">size_t</span> count = policy_-&gt;opcode_count;	<br>  <span class="hljs-comment">// 共有count个opcode待处理，它们由comparsion和action组成</span><br>  <span class="hljs-comment">// action作为组的定界</span><br>  <br>  <span class="hljs-comment">// Loop over all the opcodes Evaluating in sequence. Since we only support</span><br>  <span class="hljs-comment">// short circuit evaluation, we stop as soon as we find an &#x27;action&#x27; opcode</span><br>  <span class="hljs-comment">// and the current evaluation is true.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// Skipping opcodes can happen when we are in AND mode (!kPolUseOREval) and</span><br>  <span class="hljs-comment">// have got EVAL_FALSE or when we are in OR mode (kPolUseOREval) and got</span><br>  <span class="hljs-comment">// EVAL_TRUE. Skipping will stop at the next action opcode or at the opcode</span><br>  <span class="hljs-comment">// after the action depending on kPolUseOREval.</span><br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> ix = <span class="hljs-number">0</span>; ix != count; ++ix) &#123;<br>    PolicyOpcode&amp; opcode = policy_-&gt;opcodes[ix];<br>    <span class="hljs-comment">// Skipping block.</span><br>    <span class="hljs-keyword">if</span> (skip_group) &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">SkipOpcode</span>(opcode, &amp;context, &amp;skip_group))<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br>    <span class="hljs-comment">// Evaluation block.</span><br>    <span class="hljs-comment">// 这里使用具体的PolicyOpcode::Evaluate来对parameters中某个参数进行匹配</span><br>    EvalResult result = opcode.<span class="hljs-built_in">Evaluate</span>(parameters, param_count, &amp;context);<br>    <span class="hljs-keyword">switch</span> (result) &#123;<br>      <span class="hljs-keyword">case</span> EVAL_FALSE:<br>        evaluation = <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">// 如果某一个参数匹配失败了，那么看看是否设置了OR型匹配，如果没设置，就跳过本组</span><br>        <span class="hljs-comment">// 因为本组已经失败了，说明传递进来的参数不匹配本组</span><br>        <span class="hljs-keyword">if</span> (kPolUseOREval != context.options)<br>          skip_group = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> EVAL_ERROR:<br>        <span class="hljs-keyword">if</span> (kStopOnErrors &amp; options)<br>          <span class="hljs-keyword">return</span> POLICY_ERROR;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> EVAL_TRUE:<br>        evaluation = <span class="hljs-literal">true</span>;<br>        <span class="hljs-comment">// 如果某个匹配成功了，且设置了OR型匹配，那么本组就不必继续了，因为已经成功了</span><br>        <span class="hljs-comment">// 这说明本组也不是想要找的参数匹配组</span><br>        <span class="hljs-keyword">if</span> (kPolUseOREval == context.options)<br>          skip_group = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-comment">// We have evaluated an action.</span><br>        <span class="hljs-comment">// action opcode返回类型是action而非comparison，这说明本组匹配成功</span><br>    	<span class="hljs-comment">// 这时要对第ix组进行结果的设置，然后返回</span><br>        <span class="hljs-built_in">SetInternalState</span>(ix, result);<br>        <span class="hljs-keyword">return</span> POLICY_MATCH;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (evaluation) &#123;<br>    <span class="hljs-comment">// Reaching the end of the policy with a positive evaluation is probably</span><br>    <span class="hljs-comment">// an error: we did not find a final action opcode?</span><br>    <span class="hljs-keyword">return</span> POLICY_ERROR;<br>  &#125;<br>  <span class="hljs-keyword">return</span> NO_POLICY_MATCH;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>SkipOpcode</code>非常简单，闭着眼睛都知道怎么处理的，当然是根据定界的action来移动：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Decides if an opcode can be skipped (not evaluated) or not. The function</span><br><span class="hljs-comment">// takes as inputs the opcode and the current evaluation context and returns</span><br><span class="hljs-comment">// true if the opcode should be skipped or not and also can set keep_skipping</span><br><span class="hljs-comment">// to false to signal that the current instruction should be skipped but not</span><br><span class="hljs-comment">// the next after the current one.</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">SkipOpcode</span><span class="hljs-params">(<span class="hljs-type">const</span> PolicyOpcode&amp; opcode,</span></span><br><span class="hljs-params"><span class="hljs-function">                MatchContext* context,</span></span><br><span class="hljs-params"><span class="hljs-function">                <span class="hljs-type">bool</span>* keep_skipping)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (opcode.<span class="hljs-built_in">IsAction</span>()) &#123;<br>    <span class="hljs-type">uint32_t</span> options = context-&gt;options;<br>    context-&gt;<span class="hljs-built_in">Clear</span>();<br>    *keep_skipping = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> (kPolUseOREval != options);<br>  &#125;<br>  *keep_skipping = <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="管中窥豹">管中窥豹</h3>
<p>无论是opcode相关，还是操纵opcode
group与<code>ParameterSet</code>的processor，他们都只是联合提供了一整套机制，封装成API供上层的某个组件使用。在头文件的描述中，我们已经知道了这个组件是low-level
policy。low-level
policy本身有一定篇幅，我们本节就不再继续深入，留到下一节分析。但抛开low-level
policy，从policy_engine_unittest.cc和policy_opcodes_unittest.cc这两个单元测试代码中亦能可见一斑。</p>
<p>先看一下opcode的单元测试：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 这个TEST是测试ParameterSet的构造器和Get方法是否奏效</span><br><span class="hljs-built_in">TEST</span>(PolicyEngineTest, ParameterSetTest) &#123;<br>  <span class="hljs-comment">// 做出两个ParameterSet，设置对应的realType_和address_成员</span><br>  <span class="hljs-type">void</span>* pv1 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(<span class="hljs-number">0x477EAA5</span>);<br>  <span class="hljs-type">const</span> <span class="hljs-type">void</span>* pv2 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(<span class="hljs-number">0x987654</span>);<br>  ParameterSet pset1 = <span class="hljs-built_in">ParamPickerMake</span>(pv1);<br>  ParameterSet pset2 = <span class="hljs-built_in">ParamPickerMake</span>(pv2);<br><br>  <span class="hljs-comment">// Test that we can store and retrieve a void pointer:</span><br>  <span class="hljs-comment">// 先确认ParameterSet本身没毛病</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">void</span>* result1 = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">uint32_t</span> result2 = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(pset1.<span class="hljs-built_in">Get</span>(&amp;result1));<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(pv1 == result1);<br>  <span class="hljs-built_in">EXPECT_FALSE</span>(pset1.<span class="hljs-built_in">Get</span>(&amp;result2));<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(pset2.<span class="hljs-built_in">Get</span>(&amp;result1));<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(pv2 == result1);<br>  <span class="hljs-built_in">EXPECT_FALSE</span>(pset2.<span class="hljs-built_in">Get</span>(&amp;result2));<br><br>  <span class="hljs-comment">// Test that we can store and retrieve a uint32_t:</span><br>  <span class="hljs-comment">// 确保ParameterSet对uint32_t类型的处理是正确的（它是兼容uint32_t和指针两种处理的）</span><br>  <span class="hljs-type">uint32_t</span> number = <span class="hljs-number">12747</span>;<br>  ParameterSet pset3 = <span class="hljs-built_in">ParamPickerMake</span>(number);<br>  <span class="hljs-built_in">EXPECT_FALSE</span>(pset3.<span class="hljs-built_in">Get</span>(&amp;result1));	<span class="hljs-comment">// Get方法有多个重载，这里因为TYPE对不上理应返会false</span><br>  <span class="hljs-built_in">EXPECT_TRUE</span>(pset3.<span class="hljs-built_in">Get</span>(&amp;result2));		<span class="hljs-comment">// 这个则应该返回true</span><br>  <span class="hljs-built_in">EXPECT_EQ</span>(number, result2);<br><br>  <span class="hljs-comment">// Test that we can store and retrieve a string:</span><br>  <span class="hljs-comment">// 测试字符串的ParameterSet有没有毛病</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* txt = <span class="hljs-string">L&quot;S231L&quot;</span>;<br>  ParameterSet pset4 = <span class="hljs-built_in">ParamPickerMake</span>(txt);<br>  <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* result3 = <span class="hljs-literal">nullptr</span>;<br>  <span class="hljs-built_in">EXPECT_TRUE</span>(pset4.<span class="hljs-built_in">Get</span>(&amp;result3));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">wcscmp</span>(txt, result3));<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>ParameterSet</code>的设计很有灵性，对于上面的测试代码，完全能够理解。</p>
<p>再看对true/false两种opcode的测试：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">TEST</span>(PolicyEngineTest, TrueFalseOpcodes) &#123;<br>  <span class="hljs-type">void</span>* dummy = <span class="hljs-literal">nullptr</span>;<br>  ParameterSet ppb1 = <span class="hljs-built_in">ParamPickerMake</span>(dummy);<br>  <span class="hljs-comment">// 先做出一个工厂，memory作为PolicyOpcode+string的buffer</span><br>  <span class="hljs-type">char</span> memory[kOpcodeMemory];<br>  <span class="hljs-function">OpcodeFactory <span class="hljs-title">opcode_maker</span><span class="hljs-params">(memory, <span class="hljs-keyword">sizeof</span>(memory))</span></span>;<br><br>  <span class="hljs-comment">// This opcode always evaluates to true.</span><br>  <span class="hljs-comment">// op1是一个永远返回FALSE的opcode</span><br>  PolicyOpcode* op1 = opcode_maker.<span class="hljs-built_in">MakeOpAlwaysFalse</span>(kPolNone);<br>  <span class="hljs-built_in">ASSERT_NE</span>(<span class="hljs-literal">nullptr</span>, op1);<br>  <span class="hljs-comment">// op1的evaluate一定是返回false</span><br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_FALSE, op1-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;ppb1, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br>  <span class="hljs-comment">// op1是comparsion，不是action</span><br>  <span class="hljs-built_in">EXPECT_FALSE</span>(op1-&gt;<span class="hljs-built_in">IsAction</span>());<br><br>  <span class="hljs-comment">// This opcode always evaluates to false.</span><br>  <span class="hljs-comment">// op2永远返回true</span><br>  PolicyOpcode* op2 = opcode_maker.<span class="hljs-built_in">MakeOpAlwaysTrue</span>(kPolNone);<br>  <span class="hljs-built_in">ASSERT_NE</span>(<span class="hljs-literal">nullptr</span>, op2);<br>  <span class="hljs-comment">// 这里应该返回true</span><br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_TRUE, op2-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;ppb1, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br><br>  <span class="hljs-comment">// Nulls not allowed on the params.</span><br>  <span class="hljs-comment">// 参数是null的情况，会返回ERROR（此时不会返回裁决值 true或false）</span><br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_ERROR, op2-&gt;<span class="hljs-built_in">Evaluate</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_ERROR, op2-&gt;<span class="hljs-built_in">Evaluate</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br><br>  <span class="hljs-comment">// True and False opcodes do not &#x27;require&#x27; a number of parameters</span><br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_TRUE, op2-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;ppb1, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_TRUE, op2-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;ppb1, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br><br>  <span class="hljs-comment">// Test Inverting the logic. Note that inversion is done outside</span><br>  <span class="hljs-comment">// any particular opcode evaluation so no need to repeat for all</span><br>  <span class="hljs-comment">// opcodes.</span><br>  <span class="hljs-comment">// 设置一个有着kPolNegateEval标记位得永远返回false的opcode</span><br>  PolicyOpcode* op3 = opcode_maker.<span class="hljs-built_in">MakeOpAlwaysFalse</span>(kPolNegateEval);<br>  <span class="hljs-built_in">ASSERT_NE</span>(<span class="hljs-literal">nullptr</span>, op3);<br>  <span class="hljs-comment">// 由于kPolNegateEval，所以永远返回True</span><br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_TRUE, op3-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;ppb1, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br>  PolicyOpcode* op4 = opcode_maker.<span class="hljs-built_in">MakeOpAlwaysTrue</span>(kPolNegateEval);<br>  <span class="hljs-built_in">ASSERT_NE</span>(<span class="hljs-literal">nullptr</span>, op4);<br>  <span class="hljs-comment">// 这个就永远返回false</span><br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_FALSE, op4-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;ppb1, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br><br>  <span class="hljs-comment">// Test that we clear the match context</span><br>  PolicyOpcode* op5 = opcode_maker.<span class="hljs-built_in">MakeOpAlwaysTrue</span>(kPolClearContext);<br>  <span class="hljs-built_in">ASSERT_NE</span>(<span class="hljs-literal">nullptr</span>, op5);<br>  MatchContext context;<br>  context.position = <span class="hljs-number">1</span>;<br>  context.options = kPolUseOREval;<br>  <span class="hljs-comment">// 对字符串连续匹配所用的辅助结构context的测试，实际上这里是用不到的</span><br>  <span class="hljs-comment">// 只是单纯的测试options的值是否会正确的设置给context</span><br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_TRUE, op5-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;ppb1, <span class="hljs-number">1</span>, &amp;context));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(<span class="hljs-number">0u</span>, context.position);<br>  MatchContext context2;<br>  <span class="hljs-built_in">EXPECT_EQ</span>(context2.options, context.options);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>对工厂类的测试：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">TEST</span>(PolicyEngineTest, OpcodeMakerCase1) &#123;<br>  <span class="hljs-comment">// Testing that the opcode maker does not overrun the</span><br>  <span class="hljs-comment">// supplied buffer. It should only be able to make &#x27;count&#x27; opcodes.</span><br>  <span class="hljs-type">void</span>* dummy = <span class="hljs-literal">nullptr</span>;<br>  ParameterSet ppb1 = <span class="hljs-built_in">ParamPickerMake</span>(dummy);<br><br>  <span class="hljs-type">char</span> memory[kOpcodeMemory];<br>  <span class="hljs-function">OpcodeFactory <span class="hljs-title">opcode_maker</span><span class="hljs-params">(memory, <span class="hljs-keyword">sizeof</span>(memory))</span></span>;<br>  <span class="hljs-type">size_t</span> count = <span class="hljs-built_in">sizeof</span>(memory) / <span class="hljs-built_in">sizeof</span>(PolicyOpcode);<br><br>  <span class="hljs-comment">// 放置count个false comparsion opcode到buffer中</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> ix = <span class="hljs-number">0</span>; ix != count; ++ix) &#123;<br>    PolicyOpcode* op = opcode_maker.<span class="hljs-built_in">MakeOpAlwaysFalse</span>(kPolNone);<br>    <span class="hljs-built_in">ASSERT_NE</span>(<span class="hljs-literal">nullptr</span>, op);<br>    <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_FALSE, op-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;ppb1, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br>  &#125;<br>  <span class="hljs-comment">// There should be no room more another opcode:</span><br>  PolicyOpcode* op1 = opcode_maker.<span class="hljs-built_in">MakeOpAlwaysFalse</span>(kPolNone);<br>  <span class="hljs-built_in">ASSERT_EQ</span>(<span class="hljs-literal">nullptr</span>, op1);<br>&#125;<br><br><span class="hljs-built_in">TEST</span>(PolicyEngineTest, OpcodeMakerCase2) &#123;<br>  <span class="hljs-built_in">SetupNtdllImports</span>();<br>  <span class="hljs-comment">// Testing that the opcode maker does not overrun the</span><br>  <span class="hljs-comment">// supplied buffer. It should only be able to make &#x27;count&#x27; opcodes.</span><br>  <span class="hljs-comment">// The difference with the previous test is that this opcodes allocate</span><br>  <span class="hljs-comment">// the string &#x27;txt2&#x27; inside the same buffer.</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* txt1 = <span class="hljs-string">L&quot;1234&quot;</span>;<br>  <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span> txt2[] = <span class="hljs-string">L&quot;123&quot;</span>;<br><br>  ParameterSet ppb1 = <span class="hljs-built_in">ParamPickerMake</span>(txt1);<br>  MatchContext mc1;<br><br>  <span class="hljs-type">char</span> memory[kOpcodeMemory];<br>  <span class="hljs-function">OpcodeFactory <span class="hljs-title">opcode_maker</span><span class="hljs-params">(memory, <span class="hljs-keyword">sizeof</span>(memory))</span></span>;<br>  <span class="hljs-type">size_t</span> count = <span class="hljs-built_in">sizeof</span>(memory) / (<span class="hljs-built_in">sizeof</span>(PolicyOpcode) + <span class="hljs-built_in">sizeof</span>(txt2));<br><br>  <span class="hljs-comment">// Test that it does not overrun the buffer.</span><br>  <span class="hljs-comment">// 放置count个字符串比较opcode到buffer</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> ix = <span class="hljs-number">0</span>; ix != count; ++ix) &#123;<br>    PolicyOpcode* op = opcode_maker.<span class="hljs-built_in">MakeOpWStringMatch</span>(<br>        <span class="hljs-number">0</span>, txt2, <span class="hljs-number">0</span>, CASE_SENSITIVE, kPolClearContext);<br>    <span class="hljs-built_in">ASSERT_NE</span>(<span class="hljs-literal">nullptr</span>, op);<br>    <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_TRUE, op-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;ppb1, <span class="hljs-number">1</span>, &amp;mc1));<br>  &#125;<br><br>  <span class="hljs-comment">// There should be no room more another opcode:</span><br>  PolicyOpcode* op1 =<br>      opcode_maker.<span class="hljs-built_in">MakeOpWStringMatch</span>(<span class="hljs-number">0</span>, txt2, <span class="hljs-number">0</span>, CASE_SENSITIVE, kPolNone);<br>  <span class="hljs-built_in">ASSERT_EQ</span>(<span class="hljs-literal">nullptr</span>, op1);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>继续测试各种comparison opcode的正确性：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">TEST</span>(PolicyEngineTest, IntegerOpcodes) &#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* txt = <span class="hljs-string">L&quot;abcdef&quot;</span>;<br>  <span class="hljs-type">uint32_t</span> num1 = <span class="hljs-number">42</span>;<br>  <span class="hljs-type">uint32_t</span> num2 = <span class="hljs-number">113377</span>;<br><br>  <span class="hljs-comment">// make三个ParameterSet，1个字符串两个uint32</span><br>  ParameterSet pp_wrong1 = <span class="hljs-built_in">ParamPickerMake</span>(txt);<br>  ParameterSet pp_num1 = <span class="hljs-built_in">ParamPickerMake</span>(num1);<br>  ParameterSet pp_num2 = <span class="hljs-built_in">ParamPickerMake</span>(num2);<br><br>  <span class="hljs-type">char</span> memory[kOpcodeMemory];<br>  <span class="hljs-comment">// opcode工厂类</span><br>  <span class="hljs-function">OpcodeFactory <span class="hljs-title">opcode_maker</span><span class="hljs-params">(memory, <span class="hljs-keyword">sizeof</span>(memory))</span></span>;<br><br>  <span class="hljs-comment">// Test basic match for uint32s 42 == 42 and 42 != 113377.</span><br>  <span class="hljs-comment">// 放入一个匹配uint32值为42、参数索引为0、标记为kPolNone的PolicyOpcode</span><br>  <span class="hljs-comment">// 参数索引表示的是在ParameterSet数组中的索引，这里是单参数测试的，所以只有0</span><br>  <span class="hljs-comment">// 这个索引是为了上层的匹配ParameterSet数组而设置的</span><br>  PolicyOpcode* op_m42 = opcode_maker.<span class="hljs-built_in">MakeOpNumberMatch</span>(<span class="hljs-number">0</span>, <span class="hljs-number">42UL</span>, kPolNone);<br>  <span class="hljs-built_in">ASSERT_NE</span>(<span class="hljs-literal">nullptr</span>, op_m42);<br>  <span class="hljs-comment">// 匹配pp_num1应该是返回true的，匹配pp_num2应该返回false，而匹配字符串因为类型不一致，会返回ERROR</span><br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_TRUE, op_m42-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;pp_num1, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_FALSE, op_m42-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;pp_num2, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_ERROR, op_m42-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;pp_wrong1, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br><br>  <span class="hljs-comment">// Test basic match for void pointers.</span><br>  <span class="hljs-comment">// void指针的匹配，同上</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">void</span>* vp = <span class="hljs-literal">nullptr</span>;<br>  ParameterSet pp_num3 = <span class="hljs-built_in">ParamPickerMake</span>(vp);<br>  PolicyOpcode* op_vp_null =<br>      opcode_maker.<span class="hljs-built_in">MakeOpVoidPtrMatch</span>(<span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, kPolNone);<br>  <span class="hljs-built_in">ASSERT_NE</span>(<span class="hljs-literal">nullptr</span>, op_vp_null);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_TRUE, op_vp_null-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;pp_num3, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_FALSE, op_vp_null-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;pp_num1, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_ERROR, op_vp_null-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;pp_wrong1, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br><br>  <span class="hljs-comment">// Basic range test [41 43] (inclusive).</span><br>  PolicyOpcode* op_range1 =<br>      opcode_maker.<span class="hljs-built_in">MakeOpNumberMatchRange</span>(<span class="hljs-number">0</span>, <span class="hljs-number">41</span>, <span class="hljs-number">43</span>, kPolNone);<br>  <span class="hljs-built_in">ASSERT_NE</span>(<span class="hljs-literal">nullptr</span>, op_range1);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_TRUE, op_range1-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;pp_num1, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_FALSE, op_range1-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;pp_num2, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(EVAL_ERROR, op_range1-&gt;<span class="hljs-built_in">Evaluate</span>(&amp;pp_wrong1, <span class="hljs-number">1</span>, <span class="hljs-literal">nullptr</span>));<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其他的测试用例都差不多，就不一一展开了，我们理解了<code>PolicyOpcode</code>，
<code>OpcodeFactory</code>以及<code>ParameterSet</code>的使用即达到目的。</p>
<p>再看整个engine的测试代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">TEST</span>(PolicyEngineTest, Rules1) &#123;<br>  <span class="hljs-built_in">SetupNtdllImports</span>();<br><br>  <span class="hljs-comment">// Construct two policy rules that say:</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// #1</span><br>  <span class="hljs-comment">// If the path is c:\\documents and settings\\* AND</span><br>  <span class="hljs-comment">// If the creation mode is &#x27;open existing&#x27; AND</span><br>  <span class="hljs-comment">// If the security descriptor is null THEN</span><br>  <span class="hljs-comment">// Ask the broker.</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// #2</span><br>  <span class="hljs-comment">// If the security descriptor is null AND</span><br>  <span class="hljs-comment">// If the path ends with *.txt AND</span><br>  <span class="hljs-comment">// If the creation mode is not &#x27;create new&#x27; THEN</span><br>  <span class="hljs-comment">// return Access Denied.</span><br>  <span class="hljs-comment">// 构造了两个rule：</span><br>  <span class="hljs-comment">// 第一个规则的判断条件：</span><br>  <span class="hljs-comment">// path得是c:\\documents and settings\\*且创建模式是open existing且安全描述符是null</span><br>  <span class="hljs-comment">// 满足则action为ASK_BROKER</span><br>  <span class="hljs-comment">// 第二个规则的判断条件：</span><br>  <span class="hljs-comment">// 安全描述符是null且path以*.txt结尾且创建模式不是`create new`</span><br>  <span class="hljs-comment">// 满足则action为Access Denied</span><br>  <span class="hljs-comment">// </span><br>  <span class="hljs-comment">// 这几个参数就是要进行裁决的ParameterSet[]</span><br>  <span class="hljs-keyword">enum</span> <span class="hljs-title class_">FileCreateArgs</span> &#123;<br>    FileNameArg,<br>    CreationDispositionArg,<br>    FlagsAndAttributesArg,<br>    SecurityAttributes<br>  &#125;;<br><br>  <span class="hljs-comment">// 这里使用PolicyBuffer来new一个OpcodeFactory</span><br>  <span class="hljs-comment">// 尺寸为1024，这里构造器的尺寸减去了0x40，我个人觉着减去0x4就可以了吧，不清楚是否是笔误</span><br>  <span class="hljs-comment">// 当然无论是0x40还是0x4都不会影响正确性，仅仅是浪费了点空间</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> policy_sz = <span class="hljs-number">1024</span>;<br>  PolicyBuffer* policy = <span class="hljs-built_in">reinterpret_cast</span>&lt;PolicyBuffer*&gt;(<span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[policy_sz]);<br>  <span class="hljs-function">OpcodeFactory <span class="hljs-title">opcode_maker</span><span class="hljs-params">(policy, policy_sz - <span class="hljs-number">0x40</span>)</span></span>;<br><br>  <span class="hljs-comment">// Add rule set #1</span><br>  <span class="hljs-comment">// 工厂类中添加第一套rule</span><br>  <span class="hljs-comment">// 参数索引为1，值为L&quot;c:\\documents and settings\\&quot;，字符串起始位置0，大小写敏感，标记为kPolNone</span><br>  opcode_maker.<span class="hljs-built_in">MakeOpWStringMatch</span>(FileNameArg, <span class="hljs-string">L&quot;c:\\documents and settings\\&quot;</span>,<br>                                  <span class="hljs-number">0</span>, CASE_INSENSITIVE, kPolNone);<br>  <span class="hljs-comment">// 参数索引为2，值为OPEN_EXISTING，标记为kPolNone</span><br>  opcode_maker.<span class="hljs-built_in">MakeOpNumberMatch</span>(CreationDispositionArg, OPEN_EXISTING,<br>                                 kPolNone);<br>  <span class="hljs-comment">// 参数索引为3，值为nullptr，标记为kPolNone</span><br>  opcode_maker.<span class="hljs-built_in">MakeOpVoidPtrMatch</span>(SecurityAttributes, <span class="hljs-literal">nullptr</span>, kPolNone);<br>  <span class="hljs-comment">// 这一group的comparsion opcode设置完毕了，接上满足匹配时的审判，这里是ASK_BROKER</span><br>  opcode_maker.<span class="hljs-built_in">MakeOpAction</span>(ASK_BROKER, kPolNone);<br><br>  <span class="hljs-comment">// Add rule set #2</span><br>  <span class="hljs-comment">// 第二套规则仅仅判断两个参数</span><br>  opcode_maker.<span class="hljs-built_in">MakeOpWStringMatch</span>(FileNameArg, <span class="hljs-string">L&quot;.TXT&quot;</span>, kSeekToEnd,<br>                                  CASE_INSENSITIVE, kPolNone);<br>  opcode_maker.<span class="hljs-built_in">MakeOpNumberMatch</span>(CreationDispositionArg, CREATE_NEW,<br>                                 kPolNegateEval);<br>  <span class="hljs-comment">// 满足匹配时审判结果为FAKE_ACCESS_DENIED</span><br>  opcode_maker.<span class="hljs-built_in">MakeOpAction</span>(FAKE_ACCESS_DENIED, kPolNone);<br>  <span class="hljs-comment">// 更新count值</span><br>  policy-&gt;opcode_count = <span class="hljs-number">7</span>;<br><br>  <span class="hljs-comment">// 设置一组参数</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">wchar_t</span>* filename = <span class="hljs-string">L&quot;c:\\Documents and Settings\\Microsoft\\BLAH.txt&quot;</span>;<br>  <span class="hljs-type">uint32_t</span> creation_mode = OPEN_EXISTING;<br>  <span class="hljs-type">uint32_t</span> flags = FILE_ATTRIBUTE_NORMAL;<br>  <span class="hljs-type">void</span>* security_descriptor = <span class="hljs-literal">nullptr</span>;<br><br>  <span class="hljs-comment">// 这套宏非常关键，我们此前在注释中就看过了，应该是用于生成ParameterSet数组</span><br>  <span class="hljs-built_in">POLPARAMS_BEGIN</span>(eval_params)<br>    <span class="hljs-built_in">POLPARAM</span>(filename)<br>    <span class="hljs-built_in">POLPARAM</span>(creation_mode)<br>    <span class="hljs-built_in">POLPARAM</span>(flags)<br>    <span class="hljs-built_in">POLPARAM</span>(security_descriptor)<br>  POLPARAMS_END;<br><br>  PolicyResult pr;<br>  <span class="hljs-function">PolicyProcessor <span class="hljs-title">pol_ev</span><span class="hljs-params">(policy)</span></span>;	<span class="hljs-comment">// 架在PolicyBuffer上的processor，操纵者</span><br><br>  <span class="hljs-comment">// Test should match the first rule set.</span><br>  <span class="hljs-comment">// 看起来eval_params就是ParameterSet数组，这一组参数理应匹配到第一套规则</span><br>  <span class="hljs-comment">// 设置kShortEval模式，匹配到了一个就会返回</span><br>  pr = pol_ev.<span class="hljs-built_in">Evaluate</span>(kShortEval, eval_params, _countof(eval_params));<br>  <span class="hljs-comment">// 结果应该是匹配到</span><br>  <span class="hljs-built_in">EXPECT_EQ</span>(POLICY_MATCH, pr);、<br>  <span class="hljs-comment">// 结果应该是ASK_BROKER</span><br>  <span class="hljs-built_in">EXPECT_EQ</span>(ASK_BROKER, pol_ev.<span class="hljs-built_in">GetAction</span>());<br><br>  <span class="hljs-comment">// Test should still match the first rule set.</span><br>  <span class="hljs-comment">// 再次审判，结果应该还是一样的</span><br>  pr = pol_ev.<span class="hljs-built_in">Evaluate</span>(kShortEval, eval_params, _countof(eval_params));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(POLICY_MATCH, pr);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(ASK_BROKER, pol_ev.<span class="hljs-built_in">GetAction</span>());<br><br>  <span class="hljs-comment">// Changing creation_mode such that evaluation should not match any rule.</span><br>  <span class="hljs-comment">// 修改一下参数的值，此时应该匹配不到规则</span><br>  creation_mode = CREATE_NEW;<br>  pr = pol_ev.<span class="hljs-built_in">Evaluate</span>(kShortEval, eval_params, _countof(eval_params));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(NO_POLICY_MATCH, pr);<br><br>  <span class="hljs-comment">// Changing creation_mode such that evaluation should match rule #2.</span><br>  <span class="hljs-comment">// 再次修改一个参数值，此时应该匹配到第二套规则</span><br>  creation_mode = OPEN_ALWAYS;<br>  pr = pol_ev.<span class="hljs-built_in">Evaluate</span>(kShortEval, eval_params, _countof(eval_params));<br>  <span class="hljs-built_in">EXPECT_EQ</span>(POLICY_MATCH, pr);<br>  <span class="hljs-built_in">EXPECT_EQ</span>(FAKE_ACCESS_DENIED, pol_ev.<span class="hljs-built_in">GetAction</span>());<br><br>  <span class="hljs-keyword">delete</span>[] <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span>*&gt;(policy);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>唯一的一点就是<code>POLPARAMS_BEGIN</code>等一整套宏机制了。在policy_params.h中找到了定义，算是本次分析之旅的漏网之鱼：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// Warning: The following macros store the address to the actual variables, in</span><br><span class="hljs-comment">// other words, the values are not copied.</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POLPARAMS_BEGIN(type) class type &#123; public: enum Args &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POLPARAM(arg) arg,</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POLPARAMS_END(type) PolParamLast &#125;; &#125;; \</span><br><span class="hljs-meta">  typedef sandbox::ParameterSet type##Array [type::PolParamLast];</span><br></code></pre></td></tr></table></figure>
<p>而测试代码中使用的套路和此前看到的注释是有些差别的，因为测试代码做了简化，自己重写了这套宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> POLPARAMS_BEGIN(x) sandbox::ParameterSet x[] = &#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POLPARAM(p) sandbox::ParamPickerMake(p),</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POLPARAMS_END &#125;</span><br></code></pre></td></tr></table></figure>
<p>用它展开上面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp">sandbox::ParameterSet eval_params[] = &#123;<br>  sandbox::<span class="hljs-built_in">ParamPickerMake</span>(filename),<br>  sandbox::<span class="hljs-built_in">ParamPickerMake</span>(creation_mode),<br>  sandbox::<span class="hljs-built_in">ParamPickerMake</span>(flags),<br>  sandbox::<span class="hljs-built_in">ParamPickerMake</span>(security_descriptor),<br>&#125;<br><br><span class="hljs-comment">// ParamPickerMake(&amp;parameter) =&gt; ParameterSetEx&lt;type&gt;(address) =&gt; ParameterSet(ArgType, address)</span><br></code></pre></td></tr></table></figure>
<p>相比较policy_params.h的定义，省去了类型的定义，直接使用了<code>ParameterSet</code>数组。</p>
<p>到此，通过对测试用例的解读，我们已经了解了使用这套policy
engine的套路。下一节我们去看看它的上层操纵者：low-level policy。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" class="category-chain-item">源码剖析</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/chromium/" class="print-no-link">#chromium</a>
      
        <a href="/tags/chromium-sandbox/" class="print-no-link">#chromium-sandbox</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Chromium-sandbox-PolicyEngine-analysis</div>
      <div>https://r00tk1ts.github.io/2018/05/26/chromium-sandbox-PolicyEngine-analysis/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>r00tk1t</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2018年5月26日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2018/06/03/chromium-sandbox-LowLevelPolicy-analysis/" title="Chromium-sandbox-LowLevelPolicy-analysis">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Chromium-sandbox-LowLevelPolicy-analysis</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2018/05/26/chromium-sandbox-Resolver-analysis/" title="Chromium-sandbox-Resolver-analysis">
                        <span class="hidden-mobile">Chromium-sandbox-Resolver-analysis</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/diy/yinghua.js"></script>
<script src="/js/diy/love.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
